<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/octLaplacian.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>octLaplacian.C</h1><a href="octLaplacian_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00007 <span class="preprocessor">#include "mpi.h"</span>
00008 <span class="preprocessor">#include "petsc.h"</span>
00009 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00010 <span class="preprocessor">#include "petscmat.h"</span>
00011 <span class="preprocessor">#include "petscvec.h"</span>
00012 <span class="preprocessor">#include "petscksp.h"</span>
00013 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="massMatrix_8h.html">massMatrix.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="stiffnessMatrix_8h.html">stiffnessMatrix.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00017 
<a name="l00018"></a><a class="code" href="octLaplacian_8C.html#a2">00018</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="octLaplacian_8C.html#a2">help</a>[] = <span class="stringliteral">"Driver for a variable coefficient Laplacian problem on octrees"</span>;
00019 
00020 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span>
00024 PetscErrorCode <a class="code" href="octLaplacian_8C.html#a3">LaplacianMatMult</a>(Mat J , Vec in, Vec out);
00025 PetscErrorCode <a class="code" href="octLaplacian_8C.html#a4">InitializeData</a>(<a class="code" href="classot_1_1DA.html">ot::DA</a>* da, Vec nu, Vec inc);
00026 
<a name="l00027"></a><a class="code" href="structAppCtx.html">00027</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00028"></a><a class="code" href="structAppCtx.html#o0">00028</a>   <a class="code" href="classmassMatrix.html">massMatrix</a>* Mass;
<a name="l00029"></a><a class="code" href="structAppCtx.html#o1">00029</a>   <a class="code" href="classstiffnessMatrix.html">stiffnessMatrix</a>* Stiffness;
00030 } <a class="code" href="structAppCtx.html">AppCtx</a>;
00031 
<a name="l00032"></a><a class="code" href="octLaplacian_8C.html#a5">00032</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00033 {
00034   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof = 1;
00035   <span class="keywordtype">double</span> nuval = 1.0;
00036 
00037   Vec nu;   <span class="comment">/* Coefficient vector for the laplacian */</span>
00038   Vec rhs, inc, sol;
00039 
00040   <span class="keywordtype">int</span> size, rank;
00041 
00042   <span class="comment">// Parameters for the balancing algorithm.</span>
00043   <span class="comment">// Refer to manual for details ... </span>
00044   <span class="keywordtype">bool</span> incCorner = 1; <span class="comment">// balance across corners = true  </span>
00045   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxNumPts= 1; <span class="comment">// maximum number of points per octant</span>
00046   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim=3; <span class="comment">// spatial dimensions </span>
00047   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth=30; <span class="comment">// maximum depth of the octree, has to be &lt;= 30</span>
00048 
00049   <span class="keywordtype">char</span> filePrefix[PETSC_MAX_PATH_LEN];
00050   <span class="keywordtype">char</span> filename[PETSC_MAX_PATH_LEN];
00051 
00052   <span class="comment">// The global domain size</span>
00053   <span class="keywordtype">double</span> gSize[3];
00054   gSize[0] = 1.; gSize[1] = 1.; gSize[2] = 1.;
00055 
00056   std::vector&lt;ot::TreeNode&gt; linOct, balOct;
00057   std::vector&lt;double&gt; pts;
00058 
00059   PetscInitialize(&amp;argc, &amp;argv, <span class="stringliteral">"options"</span>, NULL);
00060   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00061 
00062   MPI_Comm_size(MPI_COMM_WORLD, &amp;size);
00063   MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);
00064 
00065   <span class="keywordflow">if</span>(argc &lt; 3) {
00066     std::cerr &lt;&lt; <span class="stringliteral">"Usage: "</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">"-pfx file_prefix"</span> &lt;&lt; std::endl;
00067     <span class="keywordflow">return</span> -1;
00068   }
00069 
00070   CHKERRQ ( PetscOptionsGetString(PETSC_NULL, <span class="stringliteral">"-pfx"</span>, filePrefix, PETSC_MAX_PATH_LEN-1, PETSC_NULL));
00071 
00072   <span class="comment">/*********************************************************************** */</span>
00073   <span class="comment">// READ: Read pts from file ...</span>
00074   <span class="comment">/*********************************************************************** */</span>
00075   sprintf(filename, <span class="stringliteral">"%s.%d.pts"</span>, filePrefix, rank); 
00076   <a class="code" href="namespaceot.html#a48">ot::readPtsFromFile</a>(filename, pts);
00077 
00078   MPI_Barrier(MPI_COMM_WORLD);  
00079 
00080   <span class="comment">/*********************************************************************** */</span>
00081   <span class="comment">// CONSTRUCT: Construct the linear octree from the points ...</span>
00082   <span class="comment">/*********************************************************************** */</span>
00083   <a class="code" href="namespaceot.html#a35">ot::points2Octree</a>(pts, gSize, linOct, dim, maxDepth, maxNumPts, MPI_COMM_WORLD);
00084 
00085   <span class="comment">// The points are not needed anymore, and can be cleared to free memory.</span>
00086   pts.clear();
00087 
00088   <span class="comment">/*********************************************************************** */</span>
00089   <span class="comment">// BALANCE: Balance the linear octree to enforce the 2:1 balance conditions.</span>
00090   <span class="comment">/*********************************************************************** */</span>
00091   <a class="code" href="namespaceot.html#a10">ot::balanceOctree</a> (linOct, balOct, dim, maxDepth, incCorner, MPI_COMM_WORLD, NULL, NULL);
00092 
00093   <span class="comment">// The linear octree (unbalanced) can be cleared to free memory.</span>
00094   linOct.clear();
00095 
00096   <span class="comment">// If desired the octree can be written to a file using the supplied routine ...</span>
00097   <span class="comment">//  ot::writeNodesToFile("filename.rank", balOct);</span>
00098 
00099   <span class="comment">/*********************************************************************** */</span>
00100   <span class="comment">// MESH : Construct the octree-based Distruted Array.</span>
00101   <span class="comment">/*********************************************************************** */</span>
00102   assert(!(balOct.empty()));
00103   <a class="code" href="classot_1_1DA.html">ot::DA</a> da(balOct,MPI_COMM_WORLD, MPI_COMM_WORLD);
00104   balOct.clear();
00105 
00106   MPI_Barrier(MPI_COMM_WORLD);
00107 
00108   <span class="keywordflow">if</span> (!rank)
00109     std::cout &lt;&lt;<span class="stringliteral">"Finshed Meshing"</span> &lt;&lt; std::endl;
00110 
00111   <span class="comment">/*********************************************************************** */</span>
00112   <span class="comment">// Laplacian</span>
00113   <span class="comment">/*********************************************************************** */</span>
00114 
00115   PetscOptionsGetScalar(0,<span class="stringliteral">"-nu"</span>,&amp;nuval,0);
00116 
00117   <span class="comment">// Use the ot::DA to create PETSc Vec objects</span>
00118   da.<a class="code" href="classot_1_1DA.html#z35_8">createVector</a>(inc, <span class="keyword">false</span>, <span class="keyword">false</span>, dof);
00119   da.<a class="code" href="classot_1_1DA.html#z35_8">createVector</a>(nu, <span class="keyword">false</span>, <span class="keyword">false</span>, dof);
00120   da.<a class="code" href="classot_1_1DA.html#z35_8">createVector</a>(rhs, <span class="keyword">false</span>, <span class="keyword">false</span>, dof);
00121   da.<a class="code" href="classot_1_1DA.html#z35_8">createVector</a>(sol, <span class="keyword">false</span>, <span class="keyword">false</span>, dof);
00122 
00123   <span class="comment">// Simple PETSc based initialization</span>
00124   CHKERRQ( VecSet(nu, nuval ) );
00125   CHKERRQ( VecSet(inc, 1.0) );   
00126 
00127   <span class="comment">// We can use elemental and nodal loops using the DA to initialize elemental </span>
00128   <span class="comment">// and nodal properties.</span>
00129   <a class="code" href="octLaplacian_8C.html#a4">InitializeData</a>(&amp;da, nu, inc);
00130 
00131   <span class="comment">/* ********************************************************************** */</span>
00132   <span class="comment">// create the Matrix objects</span>
00133   <a class="code" href="classmassMatrix.html">massMatrix</a> *Mass = <span class="keyword">new</span> <a class="code" href="classmassMatrix.html">massMatrix</a>(ot::fem::feMat::OCT); <span class="comment">// Mass Matrix</span>
00134   <a class="code" href="classstiffnessMatrix.html">stiffnessMatrix</a> *Stiffness = <span class="keyword">new</span> <a class="code" href="classstiffnessMatrix.html">stiffnessMatrix</a>(ot::fem::feMat::OCT); <span class="comment">// Stiffness matrix</span>
00135 
00136   <span class="comment">// set Matrix parameters</span>
00137   Mass-&gt;<a class="code" href="classot_1_1fem_1_1feMat.html#a8">setProblemDimensions</a>(1.0,1.0,1.0);
00138   Mass-&gt;<a class="code" href="classot_1_1fem_1_1feMat.html#a7">setDA</a>(&amp;da);
00139   Mass-&gt;<a class="code" href="classot_1_1fem_1_1feMatrix.html#a18">setDof</a>(dof);
00140 
00141   Stiffness-&gt;<a class="code" href="classot_1_1fem_1_1feMat.html#a8">setProblemDimensions</a>(1.0,1.0,1.0);
00142   Stiffness-&gt;<a class="code" href="classot_1_1fem_1_1feMat.html#a7">setDA</a>(&amp;da);
00143   Stiffness-&gt;<a class="code" href="classstiffnessMatrix.html#a7">setNuVec</a>(nu);
00144   Stiffness-&gt;<a class="code" href="classot_1_1fem_1_1feMatrix.html#a18">setDof</a>(dof);
00145 
00146   <span class="comment">// The RHS</span>
00147   Mass-&gt;<a class="code" href="classot_1_1fem_1_1feMatrix.html#a14">MatVec</a>(inc, rhs);
00148 
00149   <span class="comment">// Create the user context</span>
00150   <a class="code" href="structAppCtx.html">AppCtx</a> user;
00151   user.<a class="code" href="structAppCtx.html#o1">Stiffness</a> = Stiffness;
00152   user.<a class="code" href="structAppCtx.html#o0">Mass</a> = Mass;
00153 
00154   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> Nx = da.<a class="code" href="classot_1_1DA.html#z31_18">getNodeSize</a>();
00155   
00156   Mat J;
00157   MatCreateShell(PETSC_COMM_WORLD,dof*Nx, dof*Nx, PETSC_DETERMINE,PETSC_DETERMINE,&amp;user,&amp;J);
00158   MatShellSetOperation(J,MATOP_MULT,(<span class="keywordtype">void</span>(*)(<span class="keywordtype">void</span>))<a class="code" href="octLaplacian_8C.html#a3">LaplacianMatMult</a>);
00159 
00160   KSP ksp;
00161   KSPCreate(PETSC_COMM_WORLD,&amp;ksp);
00162   KSPSetOperators(ksp,J,J,SAME_NONZERO_PATTERN);
00163   KSPSetType(ksp,KSPCG);
00164   KSPSetFromOptions(ksp);
00165 
00166   <span class="comment">// Solve </span>
00167   KSPSolve(ksp, rhs, sol);
00168 
00169   PetscFinalize();
00170 
00171   <span class="keywordflow">return</span> 0;
00172 }
00173 
00174 <span class="preprocessor">#undef __FUNCT__</span>
00175 <span class="preprocessor"></span><span class="preprocessor">#define __FUNCT__ "LaplacianMatMult"</span>
<a name="l00176"></a><a class="code" href="octLaplacian_8C.html#a3">00176</a> <span class="preprocessor"></span>PetscErrorCode <a class="code" href="octLaplacian_8C.html#a3">LaplacianMatMult</a>(Mat J , Vec in, Vec out)
00177 {
00178   PetscFunctionBegin;
00179   <a class="code" href="structAppCtx.html">AppCtx</a> *data;
00180 
00181   MatShellGetContext( J, (<span class="keywordtype">void</span> **)&amp;data);  
00182 
00183   VecZeroEntries(out);
00184   data-&gt;Mass-&gt;MatVec(in,out);
00185   data-&gt;Stiffness-&gt;MatVec(in,out,-1.0);
00186   PetscFunctionReturn(0);
00187 }
00188 
00189 
00190 <span class="preprocessor">#undef __FUNCT__</span>
<a name="l00191"></a><a class="code" href="octLaplacian_8C.html#a1">00191</a> <span class="preprocessor"></span><span class="preprocessor">#define __FUNCT__ "InitializeData"</span>
<a name="l00192"></a><a class="code" href="octLaplacian_8C.html#a4">00192</a> <span class="preprocessor"></span>PetscErrorCode <a class="code" href="octLaplacian_8C.html#a4">InitializeData</a>(<a class="code" href="classot_1_1DA.html">ot::DA</a>* da, Vec nu, Vec inc) {
00193   PetscScalar *inarray;
00194   PetscScalar *nuarray;
00195 
00196   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof = 1;
00197 
00198   <span class="comment">// Get pointers to the data buffers </span>
00199   da-&gt;<a class="code" href="classot_1_1DA.html#z35_11">vecGetBuffer</a>(inc, inarray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,dof);
00200   da-&gt;<a class="code" href="classot_1_1DA.html#z35_11">vecGetBuffer</a>(nu, nuarray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,dof);
00201   
00202   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxD = da-&gt;<a class="code" href="classot_1_1DA.html#z31_16">getMaxDepth</a>();
00203   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> balOctmaxD = maxD - 1;
00204   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> Nx = da-&gt;<a class="code" href="classot_1_1DA.html#z31_18">getNodeSize</a>();
00205 
00206   <span class="keywordtype">double</span> facsol = 1.0;
00207 
00208   <span class="keywordflow">for</span>( da-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::ALL&gt;(), da-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::WRITABLE&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>() &lt; da-&gt;<a class="code" href="classot_1_1DA.html#z36_2">end</a>&lt;ot::DA_FLAGS::ALL&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_13">next</a>&lt;ot::DA_FLAGS::ALL&gt;()) {
00209     
00210     <a class="code" href="classPoint.html">Point</a> pt;
00211     pt = da-&gt;<a class="code" href="classot_1_1DA.html#z31_3">getCurrentOffset</a>();
00212     <span class="keywordtype">unsigned</span> levelhere = da-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>()) - 1;
00213     <span class="keywordtype">double</span> hxOct = (double)((double)(1u &lt;&lt; (balOctmaxD - levelhere))/(double)(1u &lt;&lt; balOctmaxD));
00214     
00215     <span class="keywordtype">double</span> x = (double)(pt.<a class="code" href="classPoint.html#z52_1">xint</a>())/((double)(1u &lt;&lt; (maxD-1)));
00216     <span class="keywordtype">double</span> y = (double)(pt.<a class="code" href="classPoint.html#z52_3">yint</a>())/((double)(1u &lt;&lt; (maxD-1)));
00217     <span class="keywordtype">double</span> z = (double)(pt.<a class="code" href="classPoint.html#z52_5">zint</a>())/((double)(1u &lt;&lt; (maxD-1)));
00218 
00219     <span class="keywordtype">int</span> xindx = (static_cast&lt;int&gt;(x+y+z))%2;
00220     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
00221     da-&gt;<a class="code" href="classot_1_1DA.html#z36_7">getNodeIndices</a>(indices); 
00222     <span class="keywordtype">double</span> coord[8][3] = {
00223       {0.0,0.0,0.0},
00224       {1.0,0.0,0.0},
00225       {0.0,1.0,0.0},
00226       {1.0,1.0,0.0},
00227       {0.0,0.0,1.0},
00228       {1.0,0.0,1.0},
00229       {0.0,1.0,1.0},
00230       {1.0,1.0,1.0}
00231     };
00232 
00233     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hn = da-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>());
00234 
00235     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 8; i++) {
00236       <span class="keywordflow">if</span> (!(hn &amp; (1 &lt;&lt; i))) {
00237         <span class="keywordtype">double</span> xhere, yhere, zhere;
00238         xhere = x + coord[i][0]*hxOct ; 
00239         yhere = y + coord[i][1]*hxOct; 
00240         zhere = z + coord[i][2]*hxOct; 
00241         
00242         nuarray[dof*indices[i]] = cos(facsol*M_PI*xhere)*cos(facsol*M_PI*yhere)*cos(facsol*M_PI*zhere);
00243         inarray[dof*indices[i]] = (1.0 + 3.0*facsol*facsol*M_PI*M_PI)*cos(facsol*M_PI*xhere)*cos(facsol*M_PI*yhere)*cos(facsol*M_PI*zhere);
00244       }
00245     }
00246   }
00247 
00248   da-&gt;<a class="code" href="classot_1_1DA.html#z35_13">vecRestoreBuffer</a>(inc,inarray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,dof);
00249   da-&gt;<a class="code" href="classot_1_1DA.html#z35_13">vecRestoreBuffer</a>(nu,nuarray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,dof);
00250 
00251   PetscFunctionReturn(0);
00252 }
00253 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:24 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
