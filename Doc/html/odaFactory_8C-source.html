<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /export/home/ilashuk3/Dendro/src/oda/private/odaFactory.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_95d5eb57f2839000f42cfeba4072b840.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b5c6e06b1ba7006988474c52fce3c3f3.html">oda</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_74475bc0462dae8674a4c3cfed617d48.html">private</a></div>
<h1>odaFactory.C</h1><a href="odaFactory_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="colors_8h.html">colors.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="testUtils_8h.html">testUtils.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#ifdef __DEBUG__</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#ifndef __DEBUG_DA__</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">#define __DEBUG_DA__</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span>
<a name="l00019"></a>00019 <span class="preprocessor">#ifdef __DEBUG_DA__</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#ifndef __DEBUG_DA_PUBLIC__</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#define __DEBUG_DA_PUBLIC__</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span>
<a name="l00025"></a>00025 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#ifndef __MEASURE_DA__</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#define __MEASURE_DA__</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 <span class="keyword">namespace </span>ot {
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="odaFactory_8C.html#2d6afa0bb45326f6f5ea171fba93df0e">00033</a> <span class="preprocessor">#define RESET_DA_BLOCK {\</span>
<a name="l00034"></a>00034 <span class="preprocessor">  </span><span class="comment">/*Initialize Member Data*/</span>\
<a name="l00035"></a>00035   m_ucpOctLevels = NULL;\
<a name="l00036"></a>00036   m_bComputedLocalToGlobal = false;\
<a name="l00037"></a>00037   m_bComputedLocalToGlobalElems = false;\
<a name="l00038"></a>00038   m_tnBlocks.clear();\
<a name="l00039"></a>00039   m_tnMinAllBlocks.clear();\
<a name="l00040"></a>00040   m_uiNlist.clear();\
<a name="l00041"></a>00041   m_uiNlistPtr = NULL;\
<a name="l00042"></a>00042   m_dilpLocalToGlobal = NULL;\
<a name="l00043"></a>00043   m_dilpLocalToGlobalElems = NULL;\
<a name="l00044"></a>00044   m_ucpLutRemainders.clear();\
<a name="l00045"></a>00045   m_ucpLutRemaindersPtr = NULL;\
<a name="l00046"></a>00046   m_ucpSortOrders.clear();\
<a name="l00047"></a>00047   m_ucpSortOrdersPtr = NULL;\
<a name="l00048"></a>00048   m_uspLutQuotients.clear();\
<a name="l00049"></a>00049   m_uspLutQuotientsPtr = NULL;\
<a name="l00050"></a>00050   m_ucpLutMasks.clear();\
<a name="l00051"></a>00051   m_ucpLutMasksPtr = NULL;\
<a name="l00052"></a>00052   m_ucpPreGhostConnectivity.clear();\
<a name="l00053"></a>00053   m_ucpPreGhostConnectivityPtr = NULL;\
<a name="l00054"></a>00054   m_ptsPreGhostOffsets.clear();\
<a name="l00055"></a>00055   m_ptsPreGhostOffsetsPtr = NULL;\
<a name="l00056"></a>00056   PreGhostAnchors.clear();\
<a name="l00057"></a>00057   m_uiQuotientCounter = 0;\
<a name="l00058"></a>00058   m_uiPreGhostQuotientCnt = 0;\
<a name="l00059"></a>00059   m_uiElementQuotient = 0;\
<a name="l00060"></a>00060   m_uiIndependentElementQuotient = 0;\
<a name="l00061"></a>00061   m_uiNodeSize = 0;\
<a name="l00062"></a>00062   m_uiBoundaryNodeSize = 0;\
<a name="l00063"></a>00063   m_uiElementSize = 0;\
<a name="l00064"></a>00064   m_uiIndependentElementSize = 0;\
<a name="l00065"></a>00065   m_uiPreGhostElementSize = 0;\
<a name="l00066"></a>00066   m_uiPreGhostNodeSize = 0;\
<a name="l00067"></a>00067   m_uiPreGhostBoundaryNodeSize = 0;\
<a name="l00068"></a>00068   m_uiPostGhostNodeSize = 0;\
<a name="l00069"></a>00069   m_uiLocalBufferSize = 0;\
<a name="l00070"></a>00070   m_uiElementBegin = 0;\
<a name="l00071"></a>00071   m_uiElementEnd = 0;\
<a name="l00072"></a>00072   m_uiPostGhostBegin = 0;\
<a name="l00073"></a>00073   m_uiIndependentElementBegin = 0;\
<a name="l00074"></a>00074   m_uiIndependentElementEnd = 0;\
<a name="l00075"></a>00075   m_uiCurrent = 0;\
<a name="l00076"></a>00076   m_uiDimension = 0;\
<a name="l00077"></a>00077   m_uiMaxDepth = 0;\
<a name="l00078"></a>00078   m_uipScatterMap.clear();\
<a name="l00079"></a>00079   m_uipSendProcs.clear();\
<a name="l00080"></a>00080   m_uipSendOffsets.clear();\
<a name="l00081"></a>00081   m_uipSendCounts.clear();\
<a name="l00082"></a>00082   m_uipElemScatterMap.clear();\
<a name="l00083"></a>00083   m_uipElemSendProcs.clear();\
<a name="l00084"></a>00084   m_uipElemSendOffsets.clear();\
<a name="l00085"></a>00085   m_uipElemSendCounts.clear();\
<a name="l00086"></a>00086   m_uipRecvProcs.clear();\
<a name="l00087"></a>00087   m_uipRecvOffsets.clear();\
<a name="l00088"></a>00088   m_uipRecvCounts.clear();\
<a name="l00089"></a>00089   m_uipElemRecvProcs.clear();\
<a name="l00090"></a>00090   m_uipElemRecvOffsets.clear();\
<a name="l00091"></a>00091   m_uipElemRecvCounts.clear();\
<a name="l00092"></a>00092   m_mpiContexts.clear();\
<a name="l00093"></a>00093   m_bCompressLut = compressLut;\
<a name="l00094"></a>00094   m_uiCommTag = 1;\
<a name="l00095"></a>00095   m_mpiCommAll = comm;\
<a name="l00096"></a>00096   MPI_Comm_size(m_mpiCommAll,&amp;m_iNpesAll);\
<a name="l00097"></a>00097   MPI_Comm_rank(m_mpiCommAll,&amp;m_iRankAll);\
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="classot_1_1DA.html#501a8b533f23844a8e81a5962b1f7fe3">00100</a> <span class="keywordtype">void</span> <a class="code" href="classot_1_1DA.html#501a8b533f23844a8e81a5962b1f7fe3">DA::DA_FactoryPart0</a>(std::vector&lt;ot::TreeNode&gt;&amp; in, MPI_Comm comm,
<a name="l00101"></a>00101     MPI_Comm activeInputComm, <span class="keywordtype">bool</span> compressLut, <span class="keywordtype">bool</span>* iAmActive) {
<a name="l00102"></a>00102   <a class="code" href="odaFactory_8C.html#2d6afa0bb45326f6f5ea171fba93df0e">RESET_DA_BLOCK</a>
<a name="l00103"></a>00103     <a class="code" href="classot_1_1DA.html#73999a1cf452a8d93729df022ac55f83">m_uiInputSize</a> = static_cast&lt;unsigned int&gt;(in.size());
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   <span class="comment">//The default is NULL. </span>
<a name="l00106"></a>00106   <span class="keywordflow">if</span>(iAmActive != NULL) {
<a name="l00107"></a>00107     (*iAmActive) = (!(in.empty())); 
<a name="l00108"></a>00108     <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a> = (*iAmActive);    
<a name="l00109"></a>00109   }<span class="keywordflow">else</span> {
<a name="l00110"></a>00110     <span class="comment">//Don't care for active state.</span>
<a name="l00111"></a>00111     <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a> = (!(in.empty()));
<a name="l00112"></a>00112   }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>  MPI_Comm expectedActiveInputComm;
<a name="l00116"></a>00116   <span class="keywordtype">int</span> commCompareResult;
<a name="l00117"></a>00117   <a class="code" href="namespacepar.html#a8f10e32e1e733335ee23eb7ac9df8d7">par::splitComm2way</a>(<a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>, &amp;expectedActiveInputComm, comm);
<a name="l00118"></a>00118   <span class="keywordflow">if</span>(<a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>) {
<a name="l00119"></a>00119     MPI_Comm_compare(activeInputComm, expectedActiveInputComm, &amp;commCompareResult);
<a name="l00120"></a>00120     assert( (commCompareResult == MPI_CONGRUENT) || (commCompareResult == MPI_IDENT) );
<a name="l00121"></a>00121   }
<a name="l00122"></a>00122 <span class="preprocessor">#endif</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00124"></a>00124   <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a> = activeInputComm;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   <span class="keywordflow">if</span>(<a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>) {
<a name="l00127"></a>00127     MPI_Comm_size(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>, &amp;<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>);
<a name="l00128"></a>00128     MPI_Comm_rank(m_mpiCommActive, &amp;<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>);
<a name="l00129"></a>00129   } <span class="keywordflow">else</span> {
<a name="l00130"></a>00130     <a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a> = 0;
<a name="l00131"></a>00131     <a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a> = 0;
<a name="l00132"></a>00132   }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>) {
<a name="l00135"></a>00135     <span class="keywordflow">return</span>;
<a name="l00136"></a>00136   } <span class="keywordflow">else</span> {
<a name="l00137"></a>00137     assert(!in.empty());
<a name="l00138"></a>00138     <a class="code" href="classot_1_1DA.html#1d45d3b010521c0b1b9724b6bb5eb859">m_uiDimension</a> = in[0].getDim();
<a name="l00139"></a>00139     <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a>  = in[0].getMaxDepth();
<a name="l00140"></a>00140   }
<a name="l00141"></a>00141 }<span class="comment">//end function</span>
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="classot_1_1DA.html#cd0b80931fc51d2dd95c44d773fa0377">00143</a> <span class="keywordtype">void</span> <a class="code" href="classot_1_1DA.html#cd0b80931fc51d2dd95c44d773fa0377">DA::DA_FactoryPart1</a>(std::vector&lt;ot::TreeNode&gt;&amp; in) {
<a name="l00144"></a>00144 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00146"></a>00146 <span class="preprocessor">#endif</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#640ce929d494cd3f048323b1b917e75f">PROF_BUILD_DA_STAGE1_BEGIN</a>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     assert(!in.empty());
<a name="l00150"></a>00150 
<a name="l00151"></a>00151   <span class="comment">// first generate the boundary nodes ...</span>
<a name="l00152"></a>00152   std::vector&lt;ot::TreeNode&gt; positiveBoundaryOctants;
<a name="l00153"></a>00153   <span class="comment">//Assumption: in is globally sorted to begin with. </span>
<a name="l00154"></a>00154   <span class="comment">//Guarantee: in remains globally sorted in the end.</span>
<a name="l00155"></a>00155   <span class="comment">//positiveBoundaryOctants need not be globally sorted, in fact I don't think</span>
<a name="l00156"></a>00156   <span class="comment">//it will be sorted even on 1 processor.</span>
<a name="l00157"></a>00157   <a class="code" href="namespaceot.html#2e6e7a740c9c0ac5c20f7c8e4e8129ac">addBoundaryNodesType1</a>(in, positiveBoundaryOctants, <a class="code" href="classot_1_1DA.html#1d45d3b010521c0b1b9724b6bb5eb859">m_uiDimension</a>, <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a>);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159   <span class="comment">// Update the maxDepth ...</span>
<a name="l00160"></a>00160   <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a> = <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a> + 1;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162   <span class="comment">//Most processors will not add any positive boundaries. So, there is no need</span>
<a name="l00163"></a>00163   <span class="comment">//to unnecessarily distribute positive boundaries on all procs just for</span>
<a name="l00164"></a>00164   <span class="comment">//sorting. So only the few processors touching the positive boundary will</span>
<a name="l00165"></a>00165   <span class="comment">//participate in the parallel sort</span>
<a name="l00166"></a>00166   MPI_Comm bdyComm;
<a name="l00167"></a>00167   <a class="code" href="namespacepar.html#a8f10e32e1e733335ee23eb7ac9df8d7">par::splitComm2way</a>((positiveBoundaryOctants.empty()), &amp;bdyComm, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="keywordflow">if</span>(!(positiveBoundaryOctants.empty())) {
<a name="l00170"></a>00170     <span class="comment">//Call Sample Sort  </span>
<a name="l00171"></a>00171     std::vector&lt;ot::TreeNode &gt; tmpVecTN;
<a name="l00172"></a>00172     par::sampleSort&lt;ot::TreeNode&gt;(positiveBoundaryOctants, tmpVecTN, bdyComm);
<a name="l00173"></a>00173     positiveBoundaryOctants = tmpVecTN;
<a name="l00174"></a>00174     tmpVecTN.clear();
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177   par::concatenate&lt;ot::TreeNode&gt;(in, positiveBoundaryOctants, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00178"></a>00178   positiveBoundaryOctants.clear();
<a name="l00179"></a>00179 
<a name="l00180"></a>00180   <a class="code" href="oda_8h.html#e2eeea24bd75f75147c4d50806cb8f2b">PROF_BUILD_DA_STAGE1_END</a>
<a name="l00181"></a>00181 }<span class="comment">//end function</span>
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="classot_1_1DA.html#32e9130821ed91553b79b3ae4bfae635">00183</a> <span class="keywordtype">void</span> <a class="code" href="classot_1_1DA.html#32e9130821ed91553b79b3ae4bfae635">DA::DA_FactoryPart2</a>(std::vector&lt;ot::TreeNode&gt;&amp; in) {
<a name="l00184"></a>00184 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00186"></a>00186 <span class="preprocessor">#endif</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#6cf0189413460ec644f40f61d6d9e30d">PROF_BUILD_DA_STAGE2_BEGIN</a>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     assert(!in.empty());
<a name="l00190"></a>00190   <span class="comment">//Marks regular nodes. MUST be called before DA_blockPartStage2</span>
<a name="l00191"></a>00191   <span class="comment">//Assumption: in is globally sorted at this point, including positive</span>
<a name="l00192"></a>00192   <span class="comment">//boundaries </span>
<a name="l00193"></a>00193 
<a name="l00194"></a>00194   <a class="code" href="namespaceot.html#3e214972d987182e70d44e2e792f8d12">flagNodesType3</a>(in, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196   <a class="code" href="oda_8h.html#d358677bf023f25dc6b120309138ac77">PROF_BUILD_DA_STAGE2_END</a>
<a name="l00197"></a>00197 }<span class="comment">//end function</span>
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="classot_1_1DA.html#5d40f7727c1a1a1b3616f7ed5d0d05fa">00199</a> <span class="keywordtype">void</span> <a class="code" href="classot_1_1DA.html#5d40f7727c1a1a1b3616f7ed5d0d05fa">DA::DA_FactoryPart3</a>(std::vector&lt;ot::TreeNode&gt;&amp; in, MPI_Comm comm, <span class="keywordtype">bool</span> compressLut,
<a name="l00200"></a>00200     <span class="keyword">const</span> std::vector&lt;ot::TreeNode&gt;* blocksPtr, <span class="keywordtype">bool</span>* iAmActive) {
<a name="l00201"></a>00201 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00203"></a>00203 <span class="preprocessor">#endif</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#46b06fd3c2683fab0cb7b1dff3a13271">PROF_BUILD_DA_STAGE3_BEGIN</a>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     assert(!in.empty());
<a name="l00207"></a>00207   <span class="comment">//  1. First repartition  </span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <a class="code" href="dendro_8h.html#490fe0f826970b13c0e443d13f40448d">DendroIntL</a> localSizeBefore = in.size();
<a name="l00210"></a>00210   <a class="code" href="dendro_8h.html#490fe0f826970b13c0e443d13f40448d">DendroIntL</a> globalSizeBefore; 
<a name="l00211"></a>00211   par::Mpi_Allreduce&lt;DendroIntL&gt;(&amp;localSizeBefore, &amp;globalSizeBefore, 1, MPI_SUM, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   <span class="comment">//Partition in and create blocks (blocks must be globally sorted).</span>
<a name="l00214"></a>00214   std::vector&lt;ot::TreeNode&gt; blocks;
<a name="l00215"></a>00215   <span class="keywordflow">if</span>(blocksPtr == NULL) {
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="comment">//min grain size = 1000</span>
<a name="l00218"></a>00218     <span class="keyword">const</span> <a class="code" href="dendro_8h.html#490fe0f826970b13c0e443d13f40448d">DendroIntL</a> THOUSAND = 1000;
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (globalSizeBefore &lt; (THOUSAND*<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>)) {
<a name="l00220"></a>00220       <span class="keywordtype">int</span> splittingSize = (globalSizeBefore/THOUSAND); 
<a name="l00221"></a>00221       <span class="keywordflow">if</span>(splittingSize == 0) {
<a name="l00222"></a>00222         splittingSize = 1; 
<a name="l00223"></a>00223       }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> avgLoad = (globalSizeBefore / splittingSize);
<a name="l00226"></a>00226       <span class="keywordtype">int</span> leftOvers = (globalSizeBefore % splittingSize);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228       std::vector&lt;TreeNode&gt; tmpIn;
<a name="l00229"></a>00229       <span class="keywordflow">if</span>(<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a> &gt;= splittingSize) {
<a name="l00230"></a>00230         par::scatterValues&lt;ot::TreeNode&gt;(in, tmpIn, 0, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00231"></a>00231       }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a> &lt; leftOvers) {
<a name="l00232"></a>00232         par::scatterValues&lt;ot::TreeNode&gt;(in, tmpIn, (avgLoad+1), <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00233"></a>00233       }<span class="keywordflow">else</span> {
<a name="l00234"></a>00234         par::scatterValues&lt;ot::TreeNode&gt;(in, tmpIn, avgLoad, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00235"></a>00235       }
<a name="l00236"></a>00236       in = tmpIn;
<a name="l00237"></a>00237       tmpIn.clear();
<a name="l00238"></a>00238 
<a name="l00239"></a>00239       MPI_Comm newComm;
<a name="l00240"></a>00240       <a class="code" href="namespacepar.html#a35b0d6d602c42c7273672e0ee444d5a">par::splitCommUsingSplittingRank</a>(splittingSize, &amp;newComm, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00241"></a>00241       <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a> = newComm;
<a name="l00242"></a>00242       MPI_Comm_size(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>,&amp;m_iNpesActive);
<a name="l00243"></a>00243       MPI_Comm_rank(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>,&amp;<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="preprocessor">#ifndef __SILENT_MODE__</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00247"></a>00247         std::cout&lt;&lt;<span class="stringliteral">" input to DA constructor is small("</span>&lt;&lt;globalSizeBefore
<a name="l00248"></a>00248           &lt;&lt;<span class="stringliteral">") npes = "</span>&lt;&lt;m_iNpesActive&lt;&lt;<span class="stringliteral">" splitting comm."</span>&lt;&lt;std::endl;
<a name="l00249"></a>00249       }
<a name="l00250"></a>00250 <span class="preprocessor">#endif</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>
<a name="l00252"></a>00252       <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a> = (!in.empty());   
<a name="l00253"></a>00253       <span class="keywordflow">if</span>(iAmActive != NULL) {   
<a name="l00254"></a>00254         <span class="comment">//Want the active state returned</span>
<a name="l00255"></a>00255         (*iAmActive) = <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>;
<a name="l00256"></a>00256       }
<a name="l00257"></a>00257       <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>) {
<a name="l00258"></a>00258         <a class="code" href="odaFactory_8C.html#2d6afa0bb45326f6f5ea171fba93df0e">RESET_DA_BLOCK</a>
<a name="l00259"></a>00259           <a class="code" href="oda_8h.html#0d2cbbb94a5ac97e85935549d3db6651">PROF_BUILD_DA_STAGE3_END</a>
<a name="l00260"></a>00260           <span class="keywordflow">return</span>;
<a name="l00261"></a>00261       }
<a name="l00262"></a>00262     }<span class="comment">//end check if total size is too small</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <a class="code" href="odaUtils_8h.html#d05dec160a92f3e5ac31f643c4838fbd">PROF_DA_BPART1_BEGIN</a>
<a name="l00265"></a>00265 
<a name="l00266"></a>00266       <a class="code" href="namespaceot.html#2d91bb237f0f1183db04f86a4fb5b954">ot::blockPartStage1</a>(in, blocks, <a class="code" href="classot_1_1DA.html#1d45d3b010521c0b1b9724b6bb5eb859">m_uiDimension</a>, <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a>, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);    
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <a class="code" href="odaUtils_8h.html#2108011bc476c952e96ebefb59b637c3">PROF_DA_BPART1_END</a>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270       <a class="code" href="odaUtils_8h.html#427a13a255fef85a7b36772e0f69f02a">PROF_DA_BPART2_BEGIN</a>
<a name="l00271"></a>00271 
<a name="l00272"></a>00272       <a class="code" href="namespaceot.html#42934a1485d595ea6417c3b61dfaf638">DA_blockPartStage2</a>(in, blocks, <a class="code" href="classot_1_1DA.html#1d45d3b010521c0b1b9724b6bb5eb859">m_uiDimension</a>, <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a>, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <a class="code" href="odaUtils_8h.html#3b0d1b935ae698e8ea41feb224fec53a">PROF_DA_BPART2_END</a>
<a name="l00275"></a>00275   } <span class="keywordflow">else</span> {
<a name="l00276"></a>00276     blocks = *blocksPtr;
<a name="l00277"></a>00277   }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   <a class="code" href="odaUtils_8h.html#c072194785c54052a5124157fca05ccf">PROF_DA_BPART3_BEGIN</a>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <a class="code" href="namespaceot.html#e727aaa471950829d9787d75018b1b93">DA_blockPartStage3</a>(in, blocks, <a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>, <a class="code" href="classot_1_1DA.html#1d45d3b010521c0b1b9724b6bb5eb859">m_uiDimension</a>, <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a>, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283   <a class="code" href="odaUtils_8h.html#44895766abcdb14573c12912ce79440e">PROF_DA_BPART3_END</a>
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="comment">//Store Blocks. </span>
<a name="l00286"></a>00286     <a class="code" href="classot_1_1DA.html#56c9f77603e5b4007195e4ac88c86448">m_tnBlocks</a> = blocks;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   <span class="comment">//we must split comm if new empty procs were created in blockPartStage2</span>
<a name="l00289"></a>00289   <span class="comment">//empty procs are created using partW and 0 wts and so all empty procs should</span>
<a name="l00290"></a>00290   <span class="comment">//be contiguous and only the last few procs should be empty</span>
<a name="l00291"></a>00291   <span class="keywordflow">if</span>(<a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>.size() != <a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>) {
<a name="l00292"></a>00292     <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a> = (!in.empty());   
<a name="l00293"></a>00293     <span class="keywordflow">if</span>(iAmActive != NULL) {     
<a name="l00294"></a>00294       <span class="comment">//Want the active state returned</span>
<a name="l00295"></a>00295       (*iAmActive) = <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     assert( <a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a> == (<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a> &lt; <a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>.size()) );
<a name="l00298"></a>00298 
<a name="l00299"></a>00299     MPI_Comm tmpComm;
<a name="l00300"></a>00300     <a class="code" href="namespacepar.html#a35b0d6d602c42c7273672e0ee444d5a">par::splitCommUsingSplittingRank</a>(static_cast&lt;int&gt;(<a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>.size()),
<a name="l00301"></a>00301         &amp;tmpComm, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00302"></a>00302     <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a> = tmpComm;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="preprocessor">#ifndef __SILENT_MODE__</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00306"></a>00306       std::cout&lt;&lt;<span class="stringliteral">" splitComm: "</span>&lt;&lt;<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>&lt;&lt;<span class="stringliteral">" -&gt; "</span>&lt;&lt;
<a name="l00307"></a>00307         (<a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>.size())&lt;&lt;<span class="stringliteral">" after bPart in DA constructor. "</span>&lt;&lt;std::endl;
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309 <span class="preprocessor">#endif</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span>
<a name="l00311"></a>00311     <span class="keywordflow">if</span>(<a class="code" href="classot_1_1DA.html#8a28ff6ae91e463f9a3553688b11dc0f">m_bIamActive</a>) {
<a name="l00312"></a>00312       MPI_Comm_size(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>,&amp;<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>);
<a name="l00313"></a>00313       MPI_Comm_rank(m_mpiCommActive,&amp;<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>);
<a name="l00314"></a>00314     } <span class="keywordflow">else</span> {
<a name="l00315"></a>00315       <a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a> = 0;
<a name="l00316"></a>00316       <a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a> = 0;
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keywordflow">if</span>(!m_bIamActive) {
<a name="l00320"></a>00320       <a class="code" href="odaFactory_8C.html#2d6afa0bb45326f6f5ea171fba93df0e">RESET_DA_BLOCK</a>
<a name="l00321"></a>00321         <a class="code" href="oda_8h.html#0d2cbbb94a5ac97e85935549d3db6651">PROF_BUILD_DA_STAGE3_END</a>
<a name="l00322"></a>00322         <span class="keywordflow">return</span>;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324   }<span class="comment">//end if new empty procs after bPart</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326   <a class="code" href="oda_8h.html#0d2cbbb94a5ac97e85935549d3db6651">PROF_BUILD_DA_STAGE3_END</a>
<a name="l00327"></a>00327 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00329"></a>00329 <span class="preprocessor">#endif</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#c00d347de5d42f4031b88833139b80db">PROF_BUILD_DA_STAGE4_BEGIN</a>
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="comment">// Set the Local offset</span>
<a name="l00333"></a>00333     assert(!in.empty());
<a name="l00334"></a>00334   assert(<a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>.size() == <a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   <a class="code" href="classot_1_1DA.html#a9bf7721524e94476f2fe03196e79fc9">m_ptOffset</a> = in[0].getAnchor();
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00340"></a>00340   <span class="comment">//Check that block Part did the right job.</span>
<a name="l00341"></a>00341   <span class="comment">//1. Ensure that in is globally sorted and unique.</span>
<a name="l00342"></a>00342   assert(<a class="code" href="namespacepar_1_1test.html#4eef83c8678b9a9e8077ef97dcb86a28">par::test::isUniqueAndSorted</a>(in, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>));
<a name="l00343"></a>00343 
<a name="l00344"></a>00344   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00345"></a>00345   <span class="comment">//2. Ensure that the global size before and after block part has not</span>
<a name="l00346"></a>00346   <span class="comment">//changed. So we don't miss out octants</span>
<a name="l00347"></a>00347   <a class="code" href="dendro_8h.html#490fe0f826970b13c0e443d13f40448d">DendroIntL</a> localSizeAfter = in.size();
<a name="l00348"></a>00348   <a class="code" href="dendro_8h.html#490fe0f826970b13c0e443d13f40448d">DendroIntL</a> globalSizeAfter; 
<a name="l00349"></a>00349   par::Mpi_Allreduce&lt;DendroIntL&gt;(&amp;localSizeAfter, &amp;globalSizeAfter, 1,
<a name="l00350"></a>00350       MPI_SUM, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   assert(globalSizeAfter == globalSizeBefore);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="comment">//3. Locally check that if an anchor is hanging then the parent's first</span>
<a name="l00357"></a>00357   <span class="comment">// child exists.</span>
<a name="l00358"></a>00358   <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt; in.size(); i++) {
<a name="l00359"></a>00359     <span class="keywordflow">if</span>( !(in[i].<a class="code" href="classot_1_1DA.html#ec1386f5ce907cee7e1d8d2ba4fe62bd">getFlag</a>() &amp; <a class="code" href="classot_1_1TreeNode.html#eb7e20b10a13a07386f6a940ae7aecf8f70c442b84b886210653a9d4663e3184">ot::TreeNode::NODE</a>) ) {
<a name="l00360"></a>00360       <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> anchorOfParent = in[i].getParent().getDFD();
<a name="l00361"></a>00361       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idxOfParent;
<a name="l00362"></a>00362       <span class="keywordtype">bool</span> foundAnchorOfParent = seq::maxLowerBound&lt;ot::TreeNode&gt;(in, anchorOfParent, idxOfParent, NULL, NULL);
<a name="l00363"></a>00363       <span class="keywordflow">if</span>(!foundAnchorOfParent) {
<a name="l00364"></a>00364         std::cout&lt;&lt;<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>&lt;&lt;<span class="stringliteral">" failing for: "</span>&lt;&lt;in[i]&lt;&lt;std::endl&lt;&lt;
<a name="l00365"></a>00365           <span class="stringliteral">"Expected to find: "</span>&lt;&lt;
<a name="l00366"></a>00366           anchorOfParent.getAncestor(in[i].<a class="code" href="classot_1_1DA.html#f4bee91c22427cf82991a9e19b2089bd">getLevel</a>())&lt;&lt;std::endl;
<a name="l00367"></a>00367         assert(<span class="keyword">false</span>);
<a name="l00368"></a>00368       }
<a name="l00369"></a>00369       <span class="keywordflow">if</span>( anchorOfParent.getAnchor() != in[idxOfParent].getAnchor() ) {
<a name="l00370"></a>00370         std::cout&lt;&lt;<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>&lt;&lt;<span class="stringliteral">" failing for: "</span>&lt;&lt;in[i]&lt;&lt;std::endl&lt;&lt;
<a name="l00371"></a>00371           <span class="stringliteral">"Expected to find: "</span>&lt;&lt;
<a name="l00372"></a>00372           anchorOfParent.getAncestor(in[i].getLevel())&lt;&lt;std::endl;
<a name="l00373"></a>00373         assert(<span class="keyword">false</span>);
<a name="l00374"></a>00374       }
<a name="l00375"></a>00375       <span class="keywordflow">if</span>( in[idxOfParent].getParent() != in[i].getParent() ) {
<a name="l00376"></a>00376         std::cout&lt;&lt;<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>&lt;&lt;<span class="stringliteral">" failing for: "</span>&lt;&lt;in[i]&lt;&lt;std::endl&lt;&lt;
<a name="l00377"></a>00377           <span class="stringliteral">"Expected to find: "</span>&lt;&lt;
<a name="l00378"></a>00378           anchorOfParent.getAncestor(in[i].<a class="code" href="classot_1_1DA.html#f4bee91c22427cf82991a9e19b2089bd">getLevel</a>())&lt;&lt;std::endl;
<a name="l00379"></a>00379         assert(<span class="keyword">false</span>);
<a name="l00380"></a>00380       }
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382   }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00387"></a>00387     std::cout&lt;&lt;<span class="stringliteral">"Partition is correct. Using "</span>&lt;&lt;<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>&lt;&lt;<span class="stringliteral">" active processors."</span>&lt;&lt;std::endl;
<a name="l00388"></a>00388   }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00391"></a>00391 <span class="preprocessor">#endif</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>
<a name="l00393"></a>00393   <span class="comment">//  2. Obtain all ghost octants.</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00397"></a>00397   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00398"></a>00398     std::cout&lt;&lt;<span class="stringliteral">"Pick Inter-Processor Boundary Nodes "</span>&lt;&lt;std::endl;
<a name="l00399"></a>00399   }
<a name="l00400"></a>00400   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00401"></a>00401 <span class="preprocessor">#endif</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span>
<a name="l00403"></a>00403   <span class="comment">// first let's pick boundary nodes on each proc.</span>
<a name="l00404"></a>00404   std::vector&lt;ot::TreeNode&gt; allBoundaryLeaves;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406   <a class="code" href="namespaceot.html#b8e414aa24271bc4cafc47c55adf8f89">pickInterProcessorBoundaryNodes</a>(in, allBoundaryLeaves, blocks[0], blocks[blocks.size() - 1]);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408   <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> myFirstOctant = in[0];
<a name="l00409"></a>00409   <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> myLastOctant = in[in.size() - 1];
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   <a class="code" href="namespaceot.html#15bd55c92ab3a33a5d88ca34eed5838d">includeSiblingsOfBoundary</a>(allBoundaryLeaves, myFirstOctant, myLastOctant);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413   <a class="code" href="oda_8h.html#1225adc72e9435fca272d3bbd1d27c38">PROF_BUILD_DA_STAGE4_END</a>
<a name="l00414"></a>00414 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00416"></a>00416 <span class="preprocessor">#endif</span>
<a name="l00417"></a>00417 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#514829ac4b2d161aabb26265eea38add">PROF_BUILD_DA_STAGE5_BEGIN</a>
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00421"></a>00421   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00422"></a>00422     std::cout&lt;&lt;<span class="stringliteral">"Selected Extra Ghost Candidates. Now Checking "</span>&lt;&lt;std::endl;      
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425   assert(seq::test::isUniqueAndSorted&lt;ot::TreeNode&gt;(allBoundaryLeaves));
<a name="l00426"></a>00426 
<a name="l00427"></a>00427   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> allBoundaryLeavesSize = allBoundaryLeaves.size();
<a name="l00428"></a>00428   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxBndSz;
<a name="l00429"></a>00429   par::Mpi_Reduce&lt;unsigned int&gt;(&amp;allBoundaryLeavesSize,&amp;maxBndSz,1,MPI_MAX,0,<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00432"></a>00432     std::cout&lt;&lt;<span class="stringliteral">"Max Bnd Size:  "</span>&lt;&lt;maxBndSz&lt;&lt;std::endl;      
<a name="l00433"></a>00433   }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00436"></a>00436 <span class="preprocessor">#endif</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span>
<a name="l00438"></a>00438   <a class="code" href="oda_8h.html#c15a0191516ccc748aca4ce427d0d6e3">PROF_BUILD_DA_STAGE5_END</a>
<a name="l00439"></a>00439 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00440"></a>00440 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00441"></a>00441 <span class="preprocessor">#endif</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#7ddf9a5b759199af117ed988d249056e">PROF_BUILD_DA_STAGE6_BEGIN</a>
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="comment">//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="comment">// 4. Loop through all local boundary nodes and determine which processors</span>
<a name="l00447"></a>00447     <span class="comment">// need to be aware of those nodes. Create lists that shall be sent.</span>
<a name="l00448"></a>00448     <span class="comment">//</span>
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="keywordtype">int</span> *sendCnt = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>];
<a name="l00451"></a>00451   <span class="keywordtype">int</span> *recvCnt = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>];
<a name="l00452"></a>00452   <span class="keywordtype">int</span> *sendOffsets = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>];
<a name="l00453"></a>00453   <span class="keywordtype">int</span> *recvOffsets = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>];
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   std::vector&lt; std::vector&lt;unsigned int&gt; &gt; sendNodes;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <a class="code" href="namespaceot.html#2c51872b223c91db37aab19935b5825f">prepareAprioriCommMessagesInDAtype2</a>(in, allBoundaryLeaves, blocks, <a class="code" href="classot_1_1DA.html#70a52f230b37593f6110723037fc02b1">m_tnMinAllBlocks</a>,
<a name="l00458"></a>00458       <a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>, <a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>, sendCnt, sendNodes);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   allBoundaryLeaves.clear();
<a name="l00461"></a>00461   blocks.clear();
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00465"></a>00465   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00466"></a>00466     std::cout&lt;&lt;<span class="stringliteral">"Picked Octants for Apriori Comm. "</span>&lt;&lt;std::endl;
<a name="l00467"></a>00467   }
<a name="l00468"></a>00468   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00469"></a>00469 <span class="preprocessor">#endif</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span>
<a name="l00471"></a>00471   <span class="comment">// 5. Actual send/recv. to exchange nodes.</span>
<a name="l00472"></a>00472   <span class="comment">//</span>
<a name="l00473"></a>00473   <span class="comment">// 5a.</span>
<a name="l00474"></a>00474   <span class="comment">// Now do an All2All to get numKeysRecv</span>
<a name="l00475"></a>00475   par::Mpi_Alltoall&lt;int&gt;( sendCnt, recvCnt, 1, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   <span class="comment">// 5b. Concatenate all nodes into one single Carray ...</span>
<a name="l00478"></a>00478   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalSend=0;
<a name="l00479"></a>00479   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalRecv=0;
<a name="l00480"></a>00480   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classot_1_1DA.html#155de256c071717644c4ba2f5f643be7">m_iNpesActive</a>; i++) {
<a name="l00481"></a>00481     totalSend+= sendCnt[i];
<a name="l00482"></a>00482     totalRecv+= recvCnt[i];
<a name="l00483"></a>00483   }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   <span class="comment">// create the send and recv buffers ...</span>
<a name="l00486"></a>00486   std::vector&lt;ot::TreeNode&gt; sendK (totalSend);
<a name="l00487"></a>00487   std::vector&lt;ot::TreeNode&gt; recvK (totalRecv);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489   <span class="comment">// Now create sendK</span>
<a name="l00490"></a>00490   sendOffsets[0] = 0;
<a name="l00491"></a>00491   recvOffsets[0] = 0;   
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="comment">// compute offsets ...</span>
<a name="l00494"></a>00494   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; m_iNpesActive; i++) {
<a name="l00495"></a>00495     sendOffsets[i] = sendOffsets[i-1] + sendCnt[i-1];
<a name="l00496"></a>00496     recvOffsets[i] = recvOffsets[i-1] + recvCnt[i-1];
<a name="l00497"></a>00497   }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   <span class="keywordtype">int</span> myOff = recvOffsets[<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>];
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>  assert(sendCnt[<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>] == 0);
<a name="l00503"></a>00503 <span class="preprocessor">#endif</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>
<a name="l00505"></a>00505   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; m_iNpesActive; i++) {
<a name="l00506"></a>00506     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;sendCnt[i]; j++) {
<a name="l00507"></a>00507       sendK[sendOffsets[i] + j] = in[sendNodes[i][j]];
<a name="l00508"></a>00508       <a class="code" href="classot_1_1DA.html#8552503942a98b59c8f498422c91c04e">m_uipScatterMap</a>.push_back(sendNodes[i][j] + myOff);
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510   }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00514"></a>00514   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00515"></a>00515     std::cout&lt;&lt;<span class="stringliteral">"Built Primary ScatterMap. "</span>&lt;&lt;std::endl;
<a name="l00516"></a>00516   }
<a name="l00517"></a>00517   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00518"></a>00518 <span class="preprocessor">#endif</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>
<a name="l00520"></a>00520   <span class="comment">// 5c. Perform SendRecv to send and receive all keys ...</span>
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>* sendKptr = NULL;
<a name="l00523"></a>00523   <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>* recvKptr = NULL;
<a name="l00524"></a>00524   <span class="keywordflow">if</span>(!sendK.empty()) {
<a name="l00525"></a>00525     sendKptr = &amp;(*(sendK.begin()));
<a name="l00526"></a>00526   }
<a name="l00527"></a>00527   <span class="keywordflow">if</span>(!recvK.empty()) {
<a name="l00528"></a>00528     recvKptr = &amp;(*(recvK.begin()));
<a name="l00529"></a>00529   }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531   par::Mpi_Alltoallv_sparse&lt;ot::TreeNode&gt;( sendKptr, sendCnt, sendOffsets, 
<a name="l00532"></a>00532       recvKptr, recvCnt, recvOffsets, <a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00533"></a>00533 
<a name="l00534"></a>00534   sendK.clear();
<a name="l00535"></a>00535   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; m_iNpesActive; i++) {
<a name="l00536"></a>00536     sendNodes[i].clear();
<a name="l00537"></a>00537   }
<a name="l00538"></a>00538   sendNodes.clear();
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   <span class="comment">// Let's store the counts for later synchronizations  ...</span>
<a name="l00541"></a>00541   <span class="comment">//The offsets will be computed just before compression, After primary and</span>
<a name="l00542"></a>00542   <span class="comment">//secondary scatterMaps are merged.</span>
<a name="l00543"></a>00543   <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; m_iNpesActive; i++) {
<a name="l00544"></a>00544     <span class="keywordflow">if</span> ( sendCnt[i] ) {
<a name="l00545"></a>00545       <a class="code" href="classot_1_1DA.html#c1cf50f4fa19a3d2d9a9c990d8cf1cfd">m_uipSendProcs</a>.push_back(i);
<a name="l00546"></a>00546       <a class="code" href="classot_1_1DA.html#276b6eb959bc06cab5f087c383322980">m_uipSendCounts</a>.push_back(sendCnt[i]);
<a name="l00547"></a>00547 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span>      assert(i != <a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>);
<a name="l00549"></a>00549 <span class="preprocessor">#endif</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span>    }
<a name="l00551"></a>00551     <span class="keywordflow">if</span> ( recvCnt[i] ) {
<a name="l00552"></a>00552       <a class="code" href="classot_1_1DA.html#0e0dae2af2862d622d0076eebc36848e">m_uipRecvProcs</a>.push_back(i);
<a name="l00553"></a>00553       <a class="code" href="classot_1_1DA.html#fd40cb2d7a125a5a2b27413278a6b6b4">m_uipRecvCounts</a>.push_back(recvCnt[i]);
<a name="l00554"></a>00554 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>      assert(i != <a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>);
<a name="l00556"></a>00556 <span class="preprocessor">#endif</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>    }
<a name="l00558"></a>00558   }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   <span class="comment">//Free some memory...</span>
<a name="l00561"></a>00561   <span class="keyword">delete</span> [] sendCnt;
<a name="l00562"></a>00562   <span class="keyword">delete</span> [] recvCnt;
<a name="l00563"></a>00563   <span class="keyword">delete</span> [] sendOffsets;
<a name="l00564"></a>00564   <span class="keyword">delete</span> [] recvOffsets;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <a class="code" href="oda_8h.html#ea7b6baf28a4655ea57d7e2cd59d0342">PROF_BUILD_DA_STAGE6_END</a>
<a name="l00567"></a>00567 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00569"></a>00569 <span class="preprocessor">#endif</span>
<a name="l00570"></a>00570 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#66cd472e57abeb306215fc44e1fa7842">PROF_BUILD_DA_STAGE7_BEGIN</a>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     <span class="comment">//Now that we have the ghost nodes (in recvK), we can merge this with the</span>
<a name="l00573"></a>00573     <span class="comment">//input nodes, and all tag all of these as elements. While merging we shall</span>
<a name="l00574"></a>00574     <span class="comment">//also set the right offsets into the global vector.</span>
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__        </span>
<a name="l00577"></a>00577 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00578"></a>00578   <span class="comment">//std::cout &lt;&lt; "Now Merging recv ghosts with own octants, recvK size is " &lt;&lt; recvK.size() &lt;&lt; std::endl;</span>
<a name="l00579"></a>00579   <span class="comment">//std::cout &lt;&lt; "In size is " &lt;&lt; in.size() &lt;&lt; std::endl;</span>
<a name="l00580"></a>00580   assert(seq::test::isSorted&lt;ot::TreeNode&gt; (recvK));
<a name="l00581"></a>00581   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00582"></a>00582 <span class="preprocessor">#endif        </span>
<a name="l00583"></a>00583 <span class="preprocessor"></span>
<a name="l00584"></a>00584   <span class="comment">// Lets store offsets demarcating the global domain spanned by this</span>
<a name="l00585"></a>00585   <span class="comment">// processor.</span>
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> globalMin, globalMax;
<a name="l00588"></a>00588   globalMin = in[0];
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a>00591   <span class="comment">// Since recvK is sorted, and so are the 'global' nodes, we can merge</span>
<a name="l00592"></a>00592   <span class="comment">// effectively. We also mark them as being elements.  </span>
<a name="l00593"></a>00593 
<a name="l00594"></a>00594   <span class="comment">//Merge (In-place) recieved octants with local octants....</span>
<a name="l00595"></a>00595   std::vector &lt; ot::TreeNode &gt; localOcts(recvK.size() + in.size() );
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00599"></a>00599   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00600"></a>00600     std::cout&lt;&lt;<span class="stringliteral">"Merging ghosts and own octants into the buffer. "</span>&lt;&lt;std::endl;
<a name="l00601"></a>00601   }
<a name="l00602"></a>00602   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00603"></a>00603 <span class="preprocessor">#endif</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span>
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   <span class="comment">//Note this is an inplace insertion. This is done to preserve the sorted</span>
<a name="l00607"></a>00607   <span class="comment">//order. Each recvK[i] is independently sorted. Also, since the intial</span>
<a name="l00608"></a>00608   <span class="comment">//blocks were globally sorted and since the elements on each processor are</span>
<a name="l00609"></a>00609   <span class="comment">//only decendants of these blocks, hence recvK[i][j] &lt; recvK[i+][k] for all i,j</span>
<a name="l00610"></a>00610   <span class="comment">//and k.</span>
<a name="l00611"></a>00611   <span class="comment">// PreGhost ....</span>
<a name="l00612"></a>00612   <a class="code" href="classot_1_1DA.html#7cdd60ba0d53e89894b4f4a28cfa1403">m_uiPreGhostElementSize</a> = 0;
<a name="l00613"></a>00613   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;myOff; i++) {
<a name="l00614"></a>00614     localOcts[i] = recvK[i];
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (!(localOcts[i].<a class="code" href="classot_1_1DA.html#ec1386f5ce907cee7e1d8d2ba4fe62bd">getFlag</a>() &amp; <a class="code" href="classot_1_1TreeNode.html#eb7e20b10a13a07386f6a940ae7aecf80696c30ddbe9ec3ea80a7e88f5c24e0a">ot::TreeNode::BOUNDARY</a>) ) {
<a name="l00616"></a>00616       <a class="code" href="classot_1_1DA.html#7cdd60ba0d53e89894b4f4a28cfa1403">m_uiPreGhostElementSize</a>++;
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618   }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   <span class="comment">//Mine ...</span>
<a name="l00621"></a>00621   <a class="code" href="classot_1_1DA.html#ec575a8d42f1a5de683e2598f2872e52">m_uiElementBegin</a> = myOff;
<a name="l00622"></a>00622   <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a> = myOff;
<a name="l00623"></a>00623   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=myOff; i&lt;myOff+in.size(); i++) {
<a name="l00624"></a>00624     localOcts[i] = in[i-myOff];
<a name="l00625"></a>00625     <span class="keywordflow">if</span> (!(localOcts[i].<a class="code" href="classot_1_1DA.html#ec1386f5ce907cee7e1d8d2ba4fe62bd">getFlag</a>() &amp; <a class="code" href="classot_1_1TreeNode.html#eb7e20b10a13a07386f6a940ae7aecf80696c30ddbe9ec3ea80a7e88f5c24e0a">ot::TreeNode::BOUNDARY</a>) ) {
<a name="l00626"></a>00626       <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a>++;
<a name="l00627"></a>00627     } 
<a name="l00628"></a>00628   }
<a name="l00629"></a>00629   <a class="code" href="classot_1_1DA.html#316fa899531a2eaf1ed039583580d431">m_uiElementSize</a> = (<a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a> - <a class="code" href="classot_1_1DA.html#ec575a8d42f1a5de683e2598f2872e52">m_uiElementBegin</a>);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631   <span class="comment">//PostGhosts....</span>
<a name="l00632"></a>00632   <a class="code" href="classot_1_1DA.html#c725550f5361a5fb7664c89b685f0b36">m_uiPostGhostBegin</a> = myOff + static_cast&lt;unsigned int&gt;(in.size());
<a name="l00633"></a>00633   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=myOff+in.size(); i&lt;localOcts.size(); i++) {
<a name="l00634"></a>00634     localOcts[i] = recvK[i-in.size()];
<a name="l00635"></a>00635   }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   <span class="comment">// all indices should be set at this stage ...</span>
<a name="l00638"></a>00638   <span class="comment">// free up some memory.</span>
<a name="l00639"></a>00639   in.clear();
<a name="l00640"></a>00640   recvK.clear();
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   <a class="code" href="classot_1_1DA.html#ee267aceeaeac5b4fd2ac15f8d3d3ee1">m_uiLocalBufferSize</a> = static_cast&lt;unsigned int&gt;(localOcts.size());
<a name="l00643"></a>00643 
<a name="l00644"></a>00644   <a class="code" href="oda_8h.html#32f61caccc721173e60f7e4d5f1839aa">PROF_BUILD_DA_STAGE7_END</a>
<a name="l00645"></a>00645 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00646"></a>00646 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00647"></a>00647 <span class="preprocessor">#endif</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#9a93ee670804288889658dfe1bf17708">PROF_BUILD_DA_STAGE8_BEGIN</a>
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     <span class="comment">// Now for the big step. Perform searches to build the look-up table.</span>
<a name="l00651"></a>00651     <span class="comment">// LocalOcts will be modified inside buildNodeList.</span>
<a name="l00652"></a>00652     <span class="comment">// All counters will be reset inside the function.</span>
<a name="l00653"></a>00653     <span class="comment">// The list will continue to remain sorted.</span>
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00658"></a>00658   assert(<a class="code" href="namespaceseq_1_1test.html#1c2cc3f843faf778a0513185f54fcf9f">seq::test::isUniqueAndSorted</a>(localOcts));
<a name="l00659"></a>00659   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00660"></a>00660     std::cout&lt;&lt;<span class="stringliteral">" Entering BuildNodeList. "</span>&lt;&lt;std::endl;
<a name="l00661"></a>00661   }    
<a name="l00662"></a>00662   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00663"></a>00663 <span class="preprocessor">#endif</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span>
<a name="l00665"></a>00665   <a class="code" href="classot_1_1DA.html#2a53ca905bc072ddf6641e3d91d7dfb8">buildNodeList</a>(localOcts);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00668"></a>00668 <span class="preprocessor"></span>  MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00669"></a>00669   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00670"></a>00670     std::cout&lt;&lt;<span class="stringliteral">" Leaving BuildNodeList. "</span>&lt;&lt;std::endl;
<a name="l00671"></a>00671   }
<a name="l00672"></a>00672   assert(<a class="code" href="namespaceseq_1_1test.html#1c2cc3f843faf778a0513185f54fcf9f">seq::test::isUniqueAndSorted</a>(localOcts));
<a name="l00673"></a>00673   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00674"></a>00674 <span class="preprocessor">#endif</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>
<a name="l00676"></a>00676   <a class="code" href="oda_8h.html#f79f53e02068d7c49f1c802e019478d2">PROF_BUILD_DA_STAGE8_END</a>
<a name="l00677"></a>00677 <span class="preprocessor">#ifdef __PROF_WITH_BARRIER__</span>
<a name="l00678"></a>00678 <span class="preprocessor"></span>    MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00679"></a>00679 <span class="preprocessor">#endif</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span>  <a class="code" href="oda_8h.html#2cd04c7222cc1ded4847523bd1d73410">PROF_BUILD_DA_STAGE9_BEGIN</a>
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment">// Set the global offset </span>
<a name="l00683"></a>00683     <a class="code" href="classot_1_1DA.html#81ffed2addf49ada4a78d345d50f4b4d">m_ptGhostedOffset</a> = localOcts[0].getAnchor();
<a name="l00684"></a>00684 
<a name="l00685"></a>00685   <span class="comment">//Compute pre-ghost offsets</span>
<a name="l00686"></a>00686 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00687"></a>00687 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ( <a class="code" href="classot_1_1DA.html#ec575a8d42f1a5de683e2598f2872e52">m_uiElementBegin</a>) {
<a name="l00688"></a>00688     <a class="code" href="classot_1_1DA.html#4c0d651bf4492b36e8856d72f5006ab7">PreGhostAnchors</a>.push_back( localOcts[0].getAnchor());
<a name="l00689"></a>00689   }
<a name="l00690"></a>00690 <span class="preprocessor">#endif</span>
<a name="l00691"></a>00691 <span class="preprocessor"></span>
<a name="l00692"></a>00692   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 1; i &lt; <a class="code" href="classot_1_1DA.html#ec575a8d42f1a5de683e2598f2872e52">m_uiElementBegin</a>; i++) {
<a name="l00693"></a>00693     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> touchConfig = <a class="code" href="namespaceot.html#2b3fbdd7cc8d6e5d252fce21405ffd79">getTouchConfig</a>(localOcts[i-1],
<a name="l00694"></a>00694         localOcts[i], <a class="code" href="classot_1_1DA.html#74995e7d8504c75ec557b95588784355">m_uiMaxDepth</a>);
<a name="l00695"></a>00695     <a class="code" href="classot_1_1DA.html#89a36dd0d38c774b313933cb5900b866">m_ucpPreGhostConnectivity</a>.push_back(touchConfig);
<a name="l00696"></a>00696     <span class="keywordflow">if</span> (!touchConfig) {
<a name="l00697"></a>00697       <a class="code" href="classot_1_1DA.html#51f31d5e07759bb653a9ccaca3f89752">m_ptsPreGhostOffsets</a>.push_back( localOcts[i].getAnchor() );
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>    <a class="code" href="classot_1_1DA.html#4c0d651bf4492b36e8856d72f5006ab7">PreGhostAnchors</a>.push_back( localOcts[i].getAnchor());
<a name="l00701"></a>00701 <span class="preprocessor">#endif</span>
<a name="l00702"></a>00702 <span class="preprocessor"></span>  }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   <span class="comment">// Finally compress the octree, clean up and we are all set.</span>
<a name="l00705"></a>00705 
<a name="l00706"></a>00706   <span class="comment">// we simply retain the oct levels ...</span>
<a name="l00707"></a>00707   <span class="keywordflow">if</span>(!localOcts.empty()) {
<a name="l00708"></a>00708     <a class="code" href="classot_1_1DA.html#d745e0a82b479322f687816c99354de8">m_ucpOctLevels</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> [localOcts.size()];
<a name="l00709"></a>00709   } <span class="keywordflow">else</span> {
<a name="l00710"></a>00710     <a class="code" href="classot_1_1DA.html#d745e0a82b479322f687816c99354de8">m_ucpOctLevels</a> = NULL;
<a name="l00711"></a>00711   }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; localOcts.size(); i++) {
<a name="l00714"></a>00714     <a class="code" href="classot_1_1DA.html#d745e0a82b479322f687816c99354de8">m_ucpOctLevels</a>[i] = localOcts[i].<a class="code" href="classot_1_1DA.html#ec1386f5ce907cee7e1d8d2ba4fe62bd">getFlag</a>();
<a name="l00715"></a>00715   }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   <span class="comment">// clean up ...</span>
<a name="l00718"></a>00718   localOcts.clear();
<a name="l00719"></a>00719 
<a name="l00720"></a>00720   <span class="comment">// Set pointers ....</span>
<a name="l00721"></a>00721   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#67afca98a0862ef09bb4801d846ab935">m_ucpLutRemainders</a>.empty()) {
<a name="l00722"></a>00722     <a class="code" href="classot_1_1DA.html#7d45d2c66d29db980202a8d6ad4c727a">m_ucpLutRemaindersPtr</a> = &amp;(*<a class="code" href="classot_1_1DA.html#67afca98a0862ef09bb4801d846ab935">m_ucpLutRemainders</a>.begin());
<a name="l00723"></a>00723   } <span class="keywordflow">else</span> {
<a name="l00724"></a>00724     <a class="code" href="classot_1_1DA.html#7d45d2c66d29db980202a8d6ad4c727a">m_ucpLutRemaindersPtr</a> = NULL;
<a name="l00725"></a>00725   }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#8b84170b0e36f02dc85e03219abfdb9c">m_uspLutQuotients</a>.empty()) {
<a name="l00728"></a>00728     <a class="code" href="classot_1_1DA.html#e081a363de77e17b8e0f7787749c8f03">m_uspLutQuotientsPtr</a> = &amp;(*<a class="code" href="classot_1_1DA.html#8b84170b0e36f02dc85e03219abfdb9c">m_uspLutQuotients</a>.begin());
<a name="l00729"></a>00729   } <span class="keywordflow">else</span> {
<a name="l00730"></a>00730     <a class="code" href="classot_1_1DA.html#e081a363de77e17b8e0f7787749c8f03">m_uspLutQuotientsPtr</a> = NULL;
<a name="l00731"></a>00731   }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#d4800b646ac8feee9e818a82bca36732">m_ucpLutMasks</a>.empty()) {
<a name="l00734"></a>00734     <a class="code" href="classot_1_1DA.html#38043349905c962a5712c899f0939f51">m_ucpLutMasksPtr</a> = &amp;(*<a class="code" href="classot_1_1DA.html#d4800b646ac8feee9e818a82bca36732">m_ucpLutMasks</a>.begin());
<a name="l00735"></a>00735   } <span class="keywordflow">else</span> {
<a name="l00736"></a>00736     <a class="code" href="classot_1_1DA.html#38043349905c962a5712c899f0939f51">m_ucpLutMasksPtr</a> = NULL;
<a name="l00737"></a>00737   }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#70264ccfce790b1ede010fdbe9cfbf53">m_ucpSortOrders</a>.empty()) {
<a name="l00740"></a>00740     <a class="code" href="classot_1_1DA.html#b6455bf6e161791f300f93826e45522a">m_ucpSortOrdersPtr</a> = &amp;(*<a class="code" href="classot_1_1DA.html#70264ccfce790b1ede010fdbe9cfbf53">m_ucpSortOrders</a>.begin());
<a name="l00741"></a>00741   } <span class="keywordflow">else</span> {
<a name="l00742"></a>00742     <a class="code" href="classot_1_1DA.html#b6455bf6e161791f300f93826e45522a">m_ucpSortOrdersPtr</a> = NULL;
<a name="l00743"></a>00743   }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#277df6fea9f30f6f3834ab229604b782">m_uiNlist</a>.empty()) {
<a name="l00746"></a>00746     <a class="code" href="classot_1_1DA.html#87e632b3741090ed4436c6fa44f5bf52">m_uiNlistPtr</a> = &amp;(*<a class="code" href="classot_1_1DA.html#277df6fea9f30f6f3834ab229604b782">m_uiNlist</a>.begin());
<a name="l00747"></a>00747   } <span class="keywordflow">else</span> {
<a name="l00748"></a>00748     <a class="code" href="classot_1_1DA.html#87e632b3741090ed4436c6fa44f5bf52">m_uiNlistPtr</a> = NULL;
<a name="l00749"></a>00749   }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   <a class="code" href="oda_8h.html#7b73c71c25d78975963e7a31231f3277">PROF_BUILD_DA_STAGE9_END</a>
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00754"></a>00754 <span class="preprocessor"></span>    <span class="comment">//Check Loops</span>
<a name="l00755"></a>00755     MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00756"></a>00756   <span class="keywordflow">for</span>( init&lt;ot::DA_FLAGS::WRITABLE&gt;(); <a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; end&lt;ot::DA_FLAGS::WRITABLE&gt;();
<a name="l00757"></a>00757       next&lt;ot::DA_FLAGS::WRITABLE&gt;() ) {
<a name="l00758"></a>00758     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &gt;= m_uiElementBegin);
<a name="l00759"></a>00759     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a>);
<a name="l00760"></a>00760     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
<a name="l00761"></a>00761     <a class="code" href="classot_1_1DA.html#a985ef2d251c0601fc9d2be2305c54ce">getNodeIndices</a>(indices);
<a name="l00762"></a>00762     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vtxId = 0; vtxId &lt; 8; vtxId++) {
<a name="l00763"></a>00763       assert(indices[vtxId] &gt;= m_uiElementBegin);
<a name="l00764"></a>00764       assert(indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#ee267aceeaeac5b4fd2ac15f8d3d3ee1">m_uiLocalBufferSize</a>);             
<a name="l00765"></a>00765     }
<a name="l00766"></a>00766   }
<a name="l00767"></a>00767   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00768"></a>00768   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00769"></a>00769     std::cout&lt;&lt;<span class="stringliteral">" Finished checking WRITABLE."</span>&lt;&lt;std::endl;
<a name="l00770"></a>00770   }
<a name="l00771"></a>00771   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00772"></a>00772 
<a name="l00773"></a>00773   <span class="keywordflow">for</span>( init&lt;ot::DA_FLAGS::INDEPENDENT&gt;(); <a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; end&lt;ot::DA_FLAGS::INDEPENDENT&gt;();
<a name="l00774"></a>00774       next&lt;ot::DA_FLAGS::INDEPENDENT&gt;() ) {
<a name="l00775"></a>00775     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &gt;= m_uiElementBegin);
<a name="l00776"></a>00776     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a>);
<a name="l00777"></a>00777     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
<a name="l00778"></a>00778     <a class="code" href="classot_1_1DA.html#a985ef2d251c0601fc9d2be2305c54ce">getNodeIndices</a>(indices);
<a name="l00779"></a>00779     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vtxId = 0; vtxId &lt; 8; vtxId++) {
<a name="l00780"></a>00780       assert(indices[vtxId] &gt;= m_uiElementBegin);       
<a name="l00781"></a>00781       assert(indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#c725550f5361a5fb7664c89b685f0b36">m_uiPostGhostBegin</a>);              
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783   }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00786"></a>00786 
<a name="l00787"></a>00787   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00788"></a>00788     std::cout&lt;&lt;<span class="stringliteral">" Finished checking INDEPENDENT."</span>&lt;&lt;std::endl;
<a name="l00789"></a>00789   }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793   <span class="keywordflow">for</span>( init&lt;ot::DA_FLAGS::DEPENDENT&gt;(); <a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; end&lt;ot::DA_FLAGS::DEPENDENT&gt;();
<a name="l00794"></a>00794       next&lt;ot::DA_FLAGS::DEPENDENT&gt;() ) {
<a name="l00795"></a>00795     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a>);
<a name="l00796"></a>00796     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
<a name="l00797"></a>00797     <a class="code" href="classot_1_1DA.html#a985ef2d251c0601fc9d2be2305c54ce">getNodeIndices</a>(indices);
<a name="l00798"></a>00798     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numLocal = 0;
<a name="l00799"></a>00799     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vtxId = 0; vtxId &lt; 8; vtxId++) {
<a name="l00800"></a>00800       assert(indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#ee267aceeaeac5b4fd2ac15f8d3d3ee1">m_uiLocalBufferSize</a>);
<a name="l00801"></a>00801       <span class="keywordflow">if</span>( (indices[vtxId] &gt;= m_uiElementBegin) &amp;&amp;  (indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#c725550f5361a5fb7664c89b685f0b36">m_uiPostGhostBegin</a>) ) {
<a name="l00802"></a>00802         numLocal++;
<a name="l00803"></a>00803       }         
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805     assert(numLocal &gt; 0);
<a name="l00806"></a>00806     assert(numLocal &lt; 8);
<a name="l00807"></a>00807   }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00812"></a>00812     std::cout&lt;&lt;<span class="stringliteral">" Finished checking DEPENDENT."</span>&lt;&lt;std::endl;
<a name="l00813"></a>00813   }
<a name="l00814"></a>00814   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00815"></a>00815 
<a name="l00816"></a>00816   <span class="keywordflow">for</span>( init&lt;ot::DA_FLAGS::W_DEPENDENT&gt;(); <a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; end&lt;ot::DA_FLAGS::W_DEPENDENT&gt;();
<a name="l00817"></a>00817       next&lt;ot::DA_FLAGS::W_DEPENDENT&gt;() ) {
<a name="l00818"></a>00818     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &gt;= m_uiElementBegin);
<a name="l00819"></a>00819     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a>);
<a name="l00820"></a>00820     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
<a name="l00821"></a>00821     <a class="code" href="classot_1_1DA.html#a985ef2d251c0601fc9d2be2305c54ce">getNodeIndices</a>(indices);
<a name="l00822"></a>00822     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numLocal = 0;
<a name="l00823"></a>00823     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vtxId = 0; vtxId &lt; 8; vtxId++) {
<a name="l00824"></a>00824       assert(indices[vtxId] &gt;= m_uiElementBegin);       
<a name="l00825"></a>00825       assert(indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#ee267aceeaeac5b4fd2ac15f8d3d3ee1">m_uiLocalBufferSize</a>);             
<a name="l00826"></a>00826       <span class="keywordflow">if</span>( (indices[vtxId] &gt;= m_uiElementBegin) &amp;&amp;  (indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#c725550f5361a5fb7664c89b685f0b36">m_uiPostGhostBegin</a>) ) {
<a name="l00827"></a>00827         numLocal++;
<a name="l00828"></a>00828       }         
<a name="l00829"></a>00829     }
<a name="l00830"></a>00830     assert(numLocal &gt; 0);
<a name="l00831"></a>00831     assert(numLocal &lt; 8);
<a name="l00832"></a>00832   }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00837"></a>00837     std::cout&lt;&lt;<span class="stringliteral">" Finished checking W_DEPENDENT."</span>&lt;&lt;std::endl;
<a name="l00838"></a>00838   }
<a name="l00839"></a>00839 
<a name="l00840"></a>00840   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842   <span class="keywordflow">for</span>( init&lt;ot::DA_FLAGS::ALL&gt;(); 
<a name="l00843"></a>00843       <a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; end&lt;ot::DA_FLAGS::ALL&gt;();
<a name="l00844"></a>00844       next&lt;ot::DA_FLAGS::ALL&gt;() ) {
<a name="l00845"></a>00845     assert(<a class="code" href="classot_1_1DA.html#91a567428851441c716250e60c93d065">curr</a>() &lt; <a class="code" href="classot_1_1DA.html#7663ba260ee97dcc80c083c9ab841f49">m_uiElementEnd</a>);
<a name="l00846"></a>00846     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
<a name="l00847"></a>00847     <a class="code" href="classot_1_1DA.html#a985ef2d251c0601fc9d2be2305c54ce">getNodeIndices</a>(indices);
<a name="l00848"></a>00848     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vtxId = 0; vtxId &lt; 8; vtxId++) {
<a name="l00849"></a>00849       assert(indices[vtxId] &lt; <a class="code" href="classot_1_1DA.html#ee267aceeaeac5b4fd2ac15f8d3d3ee1">m_uiLocalBufferSize</a>);             
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851   }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853   MPI_Barrier(<a class="code" href="classot_1_1DA.html#045d787547f61d31379f4b02a867c89a">m_mpiCommActive</a>);
<a name="l00854"></a>00854 
<a name="l00855"></a>00855   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00856"></a>00856     std::cout&lt;&lt;<span class="stringliteral">" Finished checking ALL."</span>&lt;&lt;std::endl;
<a name="l00857"></a>00857   }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859   MPI_Barrier(m_mpiCommActive);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="preprocessor">#endif</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span>
<a name="l00863"></a>00863 <span class="preprocessor">#ifdef __DEBUG_DA_PUBLIC__</span>
<a name="l00864"></a>00864 <span class="preprocessor"></span>  MPI_Barrier(m_mpiCommActive);
<a name="l00865"></a>00865   <span class="keywordflow">if</span>(!<a class="code" href="classot_1_1DA.html#80f6c375324f6c5a6aaf706721a6e8f7">m_iRankActive</a>) {
<a name="l00866"></a>00866     std::cout&lt;&lt;<span class="stringliteral">" Just At End of DA...."</span>&lt;&lt;std::endl&lt;&lt;std::endl;
<a name="l00867"></a>00867   }
<a name="l00868"></a>00868   <span class="comment">//std::cout&lt;&lt;m_iRankActive&lt;&lt;" "&lt;&lt;m_uiPreGhostNodeSize&lt;&lt;" "&lt;&lt;m_uiPreGhostBoundaryNodeSize&lt;&lt;" "&lt;&lt;m_uiPostGhostNodeSize&lt;&lt;" "&lt;&lt;m_uiNodeSize&lt;&lt;" "&lt;&lt;m_uiBoundaryNodeSize&lt;&lt;std::endl&lt;&lt;std::endl;</span>
<a name="l00869"></a>00869   MPI_Barrier(m_mpiCommActive);
<a name="l00870"></a>00870 <span class="preprocessor">#endif</span>
<a name="l00871"></a>00871 <span class="preprocessor"></span>
<a name="l00872"></a>00872 }<span class="comment">//end function</span>
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="preprocessor">#undef RESET_DA_BLOCK</span>
<a name="l00875"></a>00875 <span class="preprocessor"></span>
<a name="l00876"></a>00876 }<span class="comment">//end namespace</span>
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Mar 19 16:26:45 2010 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
