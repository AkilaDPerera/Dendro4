<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/stiffnessMatrix.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>stiffnessMatrix.h</h1><a href="stiffnessMatrix_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00015 <span class="preprocessor">#ifndef _STIFFNESSMATRIX_H_</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#define _STIFFNESSMATRIX_H_</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "<a class="code" href="feMatrix_8h.html">feMatrix.h</a>"</span>
00019 
<a name="l00033"></a><a class="code" href="classstiffnessMatrix.html">00033</a> <span class="keyword">class </span><a class="code" href="classstiffnessMatrix.html">stiffnessMatrix</a> : <span class="keyword">public</span> ot::fem::feMatrix&lt;stiffnessMatrix&gt;
00034 {
00035   <span class="keyword">public</span>:       
00036     <a class="code" href="classstiffnessMatrix.html#a8">stiffnessMatrix</a>(daType da);
00047     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a3">ElementalMatVec</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***in, PetscScalar ***out, <span class="keywordtype">double</span> scale);
00048     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a3">ElementalMatVec</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx, PetscScalar *in, PetscScalar *out, <span class="keywordtype">double</span> scale);
00049 
00050     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a1">ElementalMatGetDiagonal</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***diag, <span class="keywordtype">double</span> scale);
00051     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a1">ElementalMatGetDiagonal</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx, PetscScalar *diag, <span class="keywordtype">double</span> scale);
00052     
00053     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a4">initStencils</a>();
00054 
00055     <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a6">preMatVec</a>();
00056     <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a5">postMatVec</a>();
00057 
<a name="l00058"></a><a class="code" href="classstiffnessMatrix.html#a7">00058</a>     <span class="keywordtype">void</span> <a class="code" href="classstiffnessMatrix.html#a7">setNuVec</a>(Vec nv) {
00059       nuvec = nv;
00060     }
00061 
00062    <span class="keyword">private</span>:
00063     <span class="keywordtype">void</span>*               m_nuarray; <span class="comment">/* Diffusion coefficient array*/</span>
00064     Vec                 nuvec;     
00065 
00066     <span class="keywordtype">double</span>              m_dHx;
00067          <span class="keywordtype">double</span>     m_nuval;
00068     <span class="keywordtype">double</span> xFac, yFac, zFac;
00069     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxD;
00070 
00071 };
00072 
<a name="l00073"></a><a class="code" href="classstiffnessMatrix.html#a8">00073</a> <a class="code" href="classstiffnessMatrix.html#a8">stiffnessMatrix::stiffnessMatrix</a>(daType da) {
00074 <span class="preprocessor">#ifdef __DEBUG__</span>
00075 <span class="preprocessor"></span>  assert ( ( da == PETSC ) || ( da == OCT ) );
00076 <span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>  m_daType = da;
00078   m_DA          = NULL;
00079   m_octDA       = NULL;
00080   m_stencil     = NULL;
00081 
00082   <span class="comment">// initialize the stencils ...</span>
00083   <a class="code" href="classstiffnessMatrix.html#a4">initStencils</a>();
00084   <span class="keywordflow">if</span> (da == OCT)
00085     <a class="code" href="classot_1_1fem_1_1feMatrix.html#a10">initOctLut</a>();
00086 }
00087 
<a name="l00088"></a><a class="code" href="classstiffnessMatrix.html#a4">00088</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a4">stiffnessMatrix::initStencils</a>() {
00089   <span class="keyword">typedef</span> <span class="keywordtype">int</span>* int1Ptr;
00090   <span class="keyword">typedef</span> <span class="keywordtype">int</span>** int2Ptr;
00091 
00092   <span class="keywordflow">if</span> ( m_daType == PETSC) {
00093     <span class="keywordtype">int</span> Bjk[8][8] = {
00094       { 64,   0,   0, -16,   0, -16, -16, -16},
00095       {0,  64, -16,   0, -16,   0, -16, -16},
00096       {0, -16,  64,   0, -16, -16,   0, -16},
00097       { -16,   0,   0,  64, -16, -16, -16,   0},
00098       { 0, -16, -16, -16,  64,   0,   0, -16},
00099       { -16,   0, -16, -16,   0,  64, -16,   0},
00100       { -16, -16,   0, -16,   0, -16,  64,   0},
00101       { -16, -16, -16,   0, -16,   0,   0,  64}
00102     };
00103     
00104     <span class="keywordtype">int</span>** Ajk = <span class="keyword">new</span> int1Ptr[8];
00105     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;8;j++) {
00106       Ajk[j] = <span class="keyword">new</span> <span class="keywordtype">int</span>[8];
00107       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0;k&lt;8;k++) {
00108         Ajk[j][k] = Bjk[j][k];
00109       }<span class="comment">//end k</span>
00110     }<span class="comment">//end j</span>
00111     m_stencil = Ajk;
00112 
00113   } <span class="keywordflow">else</span> {
00114     <span class="keywordtype">int</span> Bijk[8][8][8] = {
00115       <span class="comment">//Type-0: No Hanging</span>
00116       {{ 64,   0,   0, -16,   0, -16, -16, -16},
00117         {0,  64, -16,   0, -16,   0, -16, -16},
00118         {0, -16,  64,   0, -16, -16,   0, -16},
00119         { -16,   0,   0,  64, -16, -16, -16,   0},
00120         { 0, -16, -16, -16,  64,   0,   0, -16},
00121         { -16,   0, -16, -16,   0,  64, -16,   0},
00122         { -16, -16,   0, -16,   0, -16,  64,   0},
00123         { -16, -16, -16,   0, -16,   0,   0,  64}},
00124       <span class="comment">//Type-1: Y Hanging</span>
00125       {{  80,  -8,  16, -16,  -8, -24, -16, -24},
00126         {  -8,  64,  -8,   0, -16,   0, -16, -16},
00127         {  16,  -8,  16,   0,  -8,  -8,   0,  -8},
00128         { -16,   0,   0,  64, -16, -16, -16,   0},
00129         {  -8, -16,  -8, -16,  64,   0,   0, -16},
00130         { -24,   0,  -8, -16,   0,  64, -16,   0},
00131         { -16, -16,   0, -16,   0, -16,  64,   0},
00132         { -24, -16,  -8,   0, -16,   0,   0,  64}},
00133       <span class="comment">//Type-2: X and Y Hanging</span>
00134       {{  88,  12,  12, -16, -16, -24, -24, -32},
00135         {  12,  16,  -4,   0,  -8,   0,  -8,  -8},
00136         {  12,  -4,  16,   0,  -8,  -8,   0,  -8},
00137         { -16,   0,   0,  64, -16, -16, -16,   0},
00138         { -16,  -8,  -8, -16,  64,   0,   0, -16},
00139         { -24,   0,  -8, -16,   0,  64, -16,   0},
00140         { -24,  -8,   0, -16,   0, -16,  64,   0},
00141         { -32,  -8,  -8,   0, -16,   0,   0,  64}},
00142       <span class="comment">//Type-3: X, Y and Z Hanging</span>
00143       {{  88,   8,   8, -24,   8, -24, -24, -40},
00144         {   8,  16,  -4,   0,  -4,   0,  -8,  -8},
00145         {   8,  -4,  16,   0,  -4,  -8,   0,  -8},
00146         { -24,   0,   0,  64,  -8, -16, -16,   0},
00147         {   8,  -4,  -4,  -8,  16,   0,   0,  -8},
00148         { -24,   0,  -8, -16,   0,  64, -16,   0},
00149         { -24,  -8,   0, -16,   0, -16,  64,   0},
00150         { -40,  -8,  -8,   0,  -8,   0,   0,  64}},
00151       <span class="comment">//Type-4: XY and X and Y Hanging</span>
00152       {{  84,  12,  12,   0, -20, -28, -28, -32},
00153         {  12,  20,   0,   4, -12,  -4, -12,  -8},
00154         {  12,   0,  20,   4, -12, -12,  -4,  -8},
00155         {   0,   4,   4,   4,  -4,  -4,  -4,   0},
00156         { -20, -12, -12,  -4,  64,   0,   0, -16},
00157         { -28,  -4, -12,  -4,   0,  64, -16,   0},
00158         { -28, -12,  -4,  -4,   0, -16,  64,   0},
00159         { -32,  -8,  -8,   0, -16,   0,   0,  64}},
00160       <span class="comment">//Type-5: XY and X and Y and Z Hanging</span>
00161       {{  80,   6,   6,  -2,   6, -28, -28, -40},
00162         {   6,  20,   0,   4,  -6,  -4, -12,  -8},
00163         {   6,   0,  20,   4,  -6, -12,  -4,  -8},
00164         {  -2,   4,   4,   4,  -2,  -4,  -4,   0},
00165         {   6,  -6,  -6,  -2,  16,   0,   0,  -8},
00166         { -28,  -4, -12,  -4,   0,  64, -16,   0},
00167         { -28, -12,  -4,  -4,   0, -16,  64,   0},
00168         { -40,  -8,  -8,   0,  -8,   0,   0,  64}},
00169       <span class="comment">//Type-6:XY and YZ and X and Y and Z Hanging</span>
00170       {{  70,   3,   2,  -3,   3, -32,  -3, -40},
00171         {   3,  20,  -3,   4,  -9,  -4,  -3,  -8},
00172         {   2,  -3,  22,   3,  -3, -16,   3,  -8},
00173         {  -3,   4,   3,   4,  -3,  -4,  -1,   0},
00174         {   3,  -9,  -3,  -3,  20,  -4,   4,  -8},
00175         { -32,  -4, -16,  -4,  -4,  64,  -4,   0},
00176         {  -3,  -3,   3,  -1,   4,  -4,   4,   0},
00177         { -40,  -8,  -8,   0,  -8,   0,   0,  64}},
00178       <span class="comment">//Type-7:All 6 Hanging</span>
00179       {{  58,  -2,  -2,  -4,  -2,  -4,  -4, -40},
00180         {  -2,  22,  -7,   3,  -7,   3,  -4,  -8},
00181         {  -2,  -7,  22,   3,  -7,  -4,   3,  -8},
00182         {  -4,   3,   3,   4,  -4,  -1,  -1,   0},
00183         {  -2,  -7,  -7,  -4,  22,   3,   3,  -8},
00184         {  -4,   3,  -4,  -1,   3,   4,  -1,   0},
00185         {  -4,  -4,   3,  -1,   3,  -1,   4,   0},
00186         { -40,  -8,  -8,   0,  -8,   0,   0,  64}}
00187     };
00188     <span class="keywordtype">int</span> ***Aijk = <span class="keyword">new</span> int2Ptr[8];
00189     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;8;i++) {
00190       Aijk[i] = <span class="keyword">new</span> int1Ptr[8];
00191       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;8;j++) {
00192         Aijk[i][j] = <span class="keyword">new</span> <span class="keywordtype">int</span>[8];
00193         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0;k&lt;8;k++) {
00194           Aijk[i][j][k] = Bijk[i][j][k];
00195         }<span class="comment">//end k</span>
00196       }<span class="comment">//end j</span>
00197     }<span class="comment">//end i</span>
00198     m_stencil = Aijk;
00199   }
00200   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00201 }
00202 
<a name="l00203"></a><a class="code" href="classstiffnessMatrix.html#a6">00203</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a6">stiffnessMatrix::preMatVec</a>() {
00204   <span class="comment">// nuVec should be set directly into matrix outside the loop ...</span>
00205   <span class="keywordflow">if</span> (m_daType == PETSC) {
00206     PetscScalar ***nuarray; <span class="comment">//</span>
00207          <span class="comment">// int ierr;</span>
00208          <span class="comment">// ierr = VecNorm(nuvec,NORM_INFINITY,&amp;m_nuval); CHKERRQ(ierr);</span>
00209 
00210     <span class="keywordtype">int</span> ierr = DAVecGetArray(m_DA, nuvec, &amp;nuarray);
00211 
00212     m_nuarray = nuarray;
00213     <span class="comment">// compute Hx</span>
00214     PetscInt mx,my,mz;
00215     ierr = DAGetInfo(m_DA,0, &amp;mx, &amp;my, &amp;mz, 0,0,0,0,0,0,0); CHKERRQ(ierr); 
00216     CHKERRQ(ierr);
00217     
00218     m_dHx = m_dLx/(mx -1);
00219 
00220     m_dHx /= 192.0;
00221   } <span class="keywordflow">else</span> {
00222     PetscScalar *nuarray; 
00223     <span class="comment">// Get nuarray</span>
00224     m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z35_11">vecGetBuffer</a>(nuvec, nuarray, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>,m_uiDof);
00225     m_nuarray = nuarray;
00226 
00227     <span class="comment">// compute Hx</span>
00228     <span class="comment">// For octree Hx values will change per element, so has to be </span>
00229     <span class="comment">// computed inside the loop.</span>
00230          maxD = m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z31_16">getMaxDepth</a>();
00231 
00232     
00233     <span class="comment">// Get the  x,y,z factors </span>
00234     xFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));
00235     <span class="keywordflow">if</span> (m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z31_4">getDimension</a>() &gt; 1) {
00236       yFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));
00237       <span class="keywordflow">if</span> (m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z31_4">getDimension</a>() &gt; 2) {
00238         zFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));
00239       }
00240     }
00241   }
00242 
00243   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00244 }
00245 
<a name="l00246"></a><a class="code" href="classstiffnessMatrix.html#a2">00246</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a3">stiffnessMatrix::ElementalMatVec</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, PetscScalar *in, PetscScalar *out, <span class="keywordtype">double</span> scale) {
00247   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lev = m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(i);
00248   <span class="keywordtype">double</span> hx = xFac*(1u &lt;&lt; (maxD - lev));
00249   <span class="keywordtype">double</span> hy = yFac*(1u &lt;&lt; (maxD - lev));
00250   <span class="keywordtype">double</span> hz = zFac*(1u &lt;&lt; (maxD - lev));
00251 
00252   <span class="keywordtype">double</span> fac11 = -hx*scale/192.0;
00253   
00254   stdElemType elemType;
00255   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx[8];
00256 
00257   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hangingMask = m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(i);    <span class="comment">//  alignElementAndVertices(m_octDA, elemType, idx);       </span>
00258   <span class="keywordtype">int</span> ***Aijk = (<span class="keywordtype">int</span> ***)m_stencil;
00259   
00260   <a class="code" href="classot_1_1fem_1_1feMatrix.html#a0">alignElementAndVertices</a>(m_octDA, elemType, idx);       
00261 
00262   PetscScalar *nuarray = (PetscScalar *)m_nuarray;
00263   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0;k &lt; 8;k++) {
00264     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;8;j++) {
00265                 <span class="keywordtype">double</span> fac1 = nuarray[idx[k]]*fac11;
00266       out[m_uiDof*idx[k]] +=  (fac1*(Aijk[elemType][k][j]))*in[m_uiDof*idx[j]];
00267                 <span class="comment">//if(hangingMask) std::cout &lt;&lt; fac1*Aijk[elemType][k][j] &lt;&lt; " " ;</span>
00268     }<span class="comment">//end for j</span>
00269          <span class="comment">//      if(hangingMask) std::cout &lt;&lt; std::endl;</span>
00270   }<span class="comment">//end for k</span>
00271   <span class="comment">//  if(hangingMask) std::cout &lt;&lt; " /* ********************************************************************** */" &lt;&lt; std::endl;</span>
00272   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00273 }
00274 
<a name="l00275"></a><a class="code" href="classstiffnessMatrix.html#a3">00275</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a3">stiffnessMatrix::ElementalMatVec</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***in, PetscScalar ***out, <span class="keywordtype">double</span> scale){
00276   <span class="keywordtype">int</span> dof= m_uiDof;
00277   <span class="keywordtype">int</span> idx[8][3]={
00278     {k, j, dof*i},
00279     {k,j,dof*(i+1)},
00280     {k,j+1,dof*i},
00281     {k,j+1,dof*(i+1)},
00282     {k+1, j, dof*i},
00283     {k+1,j,dof*(i+1)},
00284     {k+1,j+1,dof*i},
00285     {k+1,j+1,dof*(i+1)}               
00286   };             
00287 
00288   <span class="keywordtype">double</span> stencilScale;
00289   <span class="keywordtype">int</span> **Ajk = (<span class="keywordtype">int</span> **)m_stencil;
00290 
00291   PetscScalar ***nuarray = (PetscScalar ***)m_nuarray;
00292   
00293   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> q = 0; q &lt; 8; q++) {
00294     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r = 0; r &lt; 8; r++) {
00295       stencilScale = -(nuarray[k][j][i]*m_dHx)*scale;
00296                 <span class="comment">// stencilScale = -(m_nuval*m_dHx)*scale;</span>
00297                 <span class="comment">//              stencilScale = -(nuarray[k][j][dof*i]*m_dHx)*scale;</span>
00298                 <span class="comment">//stencilScale = -(m_dHx)*scale;</span>
00299       out[idx[q][0]][idx[q][1]][idx[q][2]] +=  stencilScale*Ajk[q][r]*in[idx[r][0]][idx[r][1]][idx[r][2]];
00300       <span class="keywordflow">if</span> (dof &gt; 1)      
00301         out[idx[q][0]][idx[q][1]][idx[q][2]+1] += 0.0;
00302     }
00303   }
00304 <span class="preprocessor">#ifdef __DEBUG__</span>
00305 <span class="preprocessor"></span>  <span class="comment">//            PetscPrintf(0,"stencil scale in stiffness matrix = %f\n",stencilScale);</span>
00306 <span class="preprocessor">#endif</span>
00307 <span class="preprocessor"></span>
00308   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00309 }
00310 
<a name="l00311"></a><a class="code" href="classstiffnessMatrix.html#a5">00311</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a5">stiffnessMatrix::postMatVec</a>() {
00312   <span class="keywordflow">if</span> ( m_daType == PETSC) {
00313          PetscScalar ***nuarray = (PetscScalar ***)m_nuarray;
00314     <span class="keywordtype">int</span> ierr = DAVecRestoreArray(m_DA, nuvec, &amp;nuarray);
00315     CHKERRQ(ierr);
00316   } <span class="keywordflow">else</span> {
00317     PetscScalar *nuarray = (PetscScalar *)m_nuarray;
00318     m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z35_13">vecRestoreBuffer</a>(nuvec, nuarray, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>,m_uiDof);
00319   }
00320 
00321   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00322 }
00323 
<a name="l00324"></a><a class="code" href="classstiffnessMatrix.html#a1">00324</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a1">stiffnessMatrix::ElementalMatGetDiagonal</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***diag, <span class="keywordtype">double</span> scale) {
00325   <span class="keywordtype">int</span> dof= m_uiDof;
00326   <span class="keywordtype">int</span> idx[8][3]={
00327     {k, j, dof*i},
00328     {k,j,dof*(i+1)},
00329     {k,j+1,dof*i},
00330     {k,j+1,dof*(i+1)},
00331     {k+1, j, dof*i},
00332     {k+1,j,dof*(i+1)},
00333     {k+1,j+1,dof*i},
00334     {k+1,j+1,dof*(i+1)}               
00335   };             
00336 
00337   <span class="keywordtype">double</span> stencilScale;
00338   <span class="keywordtype">int</span> **Ajk = (<span class="keywordtype">int</span> **)m_stencil;
00339 
00340   PetscScalar ***nuarray = (PetscScalar ***)m_nuarray;
00341   
00342   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> q = 0; q &lt; 8; q++) {
00343         <span class="comment">// stencilScale = -(m_nuval*m_dHx)*scale;</span>
00344     stencilScale = -(nuarray[k][j][i]*m_dHx)*scale;
00345     diag [idx[q][0]][idx[q][1]][idx[q][2]] +=  stencilScale*Ajk[q][q] ;
00346         <span class="keywordflow">if</span> (dof &gt; 1)    
00347       diag[idx[q][0]][idx[q][1]][idx[q][2]+1] += 0.0;
00348   }
00349 
00350   <span class="comment">// std::cout &lt;&lt; "Nuval is " &lt;&lt; nuarray[k][j][i] &lt;&lt; std::endl;</span>
00351   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00352 }
00353 
<a name="l00354"></a><a class="code" href="classstiffnessMatrix.html#a0">00354</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#a1">stiffnessMatrix::ElementalMatGetDiagonal</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, PetscScalar *diag, <span class="keywordtype">double</span> scale) {
00355   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lev = m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(i);
00356   <span class="keywordtype">double</span> hx = xFac*(1u &lt;&lt; (maxD - lev));
00357   <span class="keywordtype">double</span> hy = yFac*(1u &lt;&lt; (maxD - lev));
00358   <span class="keywordtype">double</span> hz = zFac*(1u &lt;&lt; (maxD - lev));
00359 
00360   <span class="keywordtype">double</span> fac11 = -hx*scale/192.0;
00361   
00362   stdElemType elemType;
00363   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx[8];
00364 
00365   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hangingMask = m_octDA-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(i);    <span class="comment">//  alignElementAndVertices(m_octDA, elemType, idx);       </span>
00366   <span class="keywordtype">int</span> ***Aijk = (<span class="keywordtype">int</span> ***)m_stencil;
00367   
00368   <a class="code" href="classot_1_1fem_1_1feMatrix.html#a0">alignElementAndVertices</a>(m_octDA, elemType, idx);       
00369 
00370   PetscScalar *nuarray = (PetscScalar *)m_nuarray;
00371   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0;k &lt; 8;k++) {
00372     <span class="keywordtype">double</span> fac1 = nuarray[idx[k]]*fac11;
00373     diag[m_uiDof*idx[k]] +=  (fac1*(Aijk[elemType][k][k]));
00374   }<span class="comment">//end for k</span>
00375 
00376   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00377 }
00378 
00379 
00380 <span class="preprocessor">#endif </span><span class="comment">/*_STIFFNESSMATRIX_H_*/</span>
00381 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:26 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
