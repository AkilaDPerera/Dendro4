<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /export/home/ilashuk3/Dendro/examples/include/stiffnessMatrix.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_daf6f5b00748c52b92c6b2e1ffe15259.html">examples</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_c73ac5f1b283295815c51801c668b299.html">include</a></div>
<h1>stiffnessMatrix.h</h1><a href="stiffnessMatrix_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00015"></a>00015 <span class="preprocessor">#ifndef _STIFFNESSMATRIX_H_</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#define _STIFFNESSMATRIX_H_</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="feMatrix_8h.html">feMatrix.h</a>"</span>
<a name="l00019"></a>00019 
<a name="l00033"></a><a class="code" href="classstiffnessMatrix.html">00033</a> <span class="keyword">class </span><a class="code" href="classstiffnessMatrix.html">stiffnessMatrix</a> : <span class="keyword">public</span> ot::fem::<a class="code" href="classot_1_1fem_1_1feMatrix.html#3a241b594d881e2c15c23667b554e8de">feMatrix</a>&lt;stiffnessMatrix&gt;
<a name="l00034"></a>00034 {
<a name="l00035"></a>00035   <span class="keyword">public</span>:       
<a name="l00036"></a>00036     <a class="code" href="classstiffnessMatrix.html#6c4729ec254b62d584597bc35670923f">stiffnessMatrix</a>(<a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6f">daType</a> da);
<a name="l00047"></a>00047     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#7d78135455efac78f02a67a651ae745f">ElementalMatVec</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***in, PetscScalar ***out, <span class="keywordtype">double</span> scale);
<a name="l00048"></a>00048     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#7d78135455efac78f02a67a651ae745f">ElementalMatVec</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx, PetscScalar *in, PetscScalar *out, <span class="keywordtype">double</span> scale);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#83a21a70bb07a70b689ea7800623f13d">ElementalMatGetDiagonal</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***diag, <span class="keywordtype">double</span> scale);
<a name="l00051"></a>00051     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#83a21a70bb07a70b689ea7800623f13d">ElementalMatGetDiagonal</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx, PetscScalar *diag, <span class="keywordtype">double</span> scale);
<a name="l00052"></a>00052     
<a name="l00053"></a>00053     <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#3e7c758276f5b81112cdac3ac4526eea">initStencils</a>();
<a name="l00054"></a>00054 
<a name="l00055"></a>00055     <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#174fb48ae4a6d22bd05cf59ac4f36c13">preMatVec</a>();
<a name="l00056"></a>00056     <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#0ef04e20dd2ee914b28b9bfe7dd11bbe">postMatVec</a>();
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="classstiffnessMatrix.html#69124471154a304bcd8164142181280e">00058</a>     <span class="keywordtype">void</span> <a class="code" href="classstiffnessMatrix.html#69124471154a304bcd8164142181280e">setNuVec</a>(Vec nv) {
<a name="l00059"></a>00059       nuvec = nv;
<a name="l00060"></a>00060     }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062    <span class="keyword">private</span>:
<a name="l00063"></a>00063     <span class="keywordtype">void</span>*               m_nuarray; <span class="comment">/* Diffusion coefficient array*/</span>
<a name="l00064"></a>00064     Vec                 nuvec;     
<a name="l00065"></a>00065 
<a name="l00066"></a>00066     <span class="keywordtype">double</span>              m_dHx;
<a name="l00067"></a>00067          <span class="keywordtype">double</span>     m_nuval;
<a name="l00068"></a>00068     <span class="keywordtype">double</span> xFac, yFac, zFac;
<a name="l00069"></a>00069     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxD;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 };
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="classstiffnessMatrix.html#6c4729ec254b62d584597bc35670923f">00073</a> <a class="code" href="classstiffnessMatrix.html#6c4729ec254b62d584597bc35670923f">stiffnessMatrix::stiffnessMatrix</a>(daType da) {
<a name="l00074"></a>00074 <span class="preprocessor">#ifdef __DEBUG__</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>  assert ( ( da == <a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6fed07c25adbae6025233c9d0e861e2df7">PETSC</a> ) || ( da == <a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6f9557906c8c9773be23ed9ef37f872a15">OCT</a> ) );
<a name="l00076"></a>00076 <span class="preprocessor">#endif</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>  <a class="code" href="classot_1_1fem_1_1feMat.html#dc8c6b0e6d715bbc70339f9a08bb27b2">m_daType</a> = da;
<a name="l00078"></a>00078   <a class="code" href="classot_1_1fem_1_1feMat.html#87a6821a9d62570de2ba74c64a864d42">m_DA</a>          = NULL;
<a name="l00079"></a>00079   <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>       = NULL;
<a name="l00080"></a>00080   <a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a>     = NULL;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   <span class="comment">// initialize the stencils ...</span>
<a name="l00083"></a>00083   <a class="code" href="classstiffnessMatrix.html#3e7c758276f5b81112cdac3ac4526eea">initStencils</a>();
<a name="l00084"></a>00084   <span class="keywordflow">if</span> (da == <a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6f9557906c8c9773be23ed9ef37f872a15">OCT</a>)
<a name="l00085"></a>00085     <a class="code" href="classot_1_1fem_1_1feMatrix.html#b56d327883a3946b42a69499ca4b1a21">initOctLut</a>();
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="classstiffnessMatrix.html#3e7c758276f5b81112cdac3ac4526eea">00088</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#3e7c758276f5b81112cdac3ac4526eea">stiffnessMatrix::initStencils</a>() {
<a name="l00089"></a>00089   <span class="keyword">typedef</span> <span class="keywordtype">int</span>* int1Ptr;
<a name="l00090"></a>00090   <span class="keyword">typedef</span> <span class="keywordtype">int</span>** int2Ptr;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   <span class="keywordflow">if</span> ( <a class="code" href="classot_1_1fem_1_1feMat.html#dc8c6b0e6d715bbc70339f9a08bb27b2">m_daType</a> == <a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6fed07c25adbae6025233c9d0e861e2df7">PETSC</a>) {
<a name="l00093"></a>00093     <span class="keywordtype">int</span> Bjk[8][8] = {
<a name="l00094"></a>00094       { 64,   0,   0, -16,   0, -16, -16, -16},
<a name="l00095"></a>00095       {0,  64, -16,   0, -16,   0, -16, -16},
<a name="l00096"></a>00096       {0, -16,  64,   0, -16, -16,   0, -16},
<a name="l00097"></a>00097       { -16,   0,   0,  64, -16, -16, -16,   0},
<a name="l00098"></a>00098       { 0, -16, -16, -16,  64,   0,   0, -16},
<a name="l00099"></a>00099       { -16,   0, -16, -16,   0,  64, -16,   0},
<a name="l00100"></a>00100       { -16, -16,   0, -16,   0, -16,  64,   0},
<a name="l00101"></a>00101       { -16, -16, -16,   0, -16,   0,   0,  64}
<a name="l00102"></a>00102     };
<a name="l00103"></a>00103     
<a name="l00104"></a>00104     <span class="keywordtype">int</span>** Ajk = <span class="keyword">new</span> int1Ptr[8];
<a name="l00105"></a>00105     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;8;j++) {
<a name="l00106"></a>00106       Ajk[j] = <span class="keyword">new</span> <span class="keywordtype">int</span>[8];
<a name="l00107"></a>00107       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0;k&lt;8;k++) {
<a name="l00108"></a>00108         Ajk[j][k] = Bjk[j][k];
<a name="l00109"></a>00109       }<span class="comment">//end k</span>
<a name="l00110"></a>00110     }<span class="comment">//end j</span>
<a name="l00111"></a>00111     <a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a> = Ajk;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113   } <span class="keywordflow">else</span> {
<a name="l00114"></a>00114     <span class="keywordtype">int</span> Bijk[8][8][8] = {
<a name="l00115"></a>00115       <span class="comment">//Type-0: No Hanging</span>
<a name="l00116"></a>00116       {{ 64,   0,   0, -16,   0, -16, -16, -16},
<a name="l00117"></a>00117         {0,  64, -16,   0, -16,   0, -16, -16},
<a name="l00118"></a>00118         {0, -16,  64,   0, -16, -16,   0, -16},
<a name="l00119"></a>00119         { -16,   0,   0,  64, -16, -16, -16,   0},
<a name="l00120"></a>00120         { 0, -16, -16, -16,  64,   0,   0, -16},
<a name="l00121"></a>00121         { -16,   0, -16, -16,   0,  64, -16,   0},
<a name="l00122"></a>00122         { -16, -16,   0, -16,   0, -16,  64,   0},
<a name="l00123"></a>00123         { -16, -16, -16,   0, -16,   0,   0,  64}},
<a name="l00124"></a>00124       <span class="comment">//Type-1: Y Hanging</span>
<a name="l00125"></a>00125       {{  80,  -8,  16, -16,  -8, -24, -16, -24},
<a name="l00126"></a>00126         {  -8,  64,  -8,   0, -16,   0, -16, -16},
<a name="l00127"></a>00127         {  16,  -8,  16,   0,  -8,  -8,   0,  -8},
<a name="l00128"></a>00128         { -16,   0,   0,  64, -16, -16, -16,   0},
<a name="l00129"></a>00129         {  -8, -16,  -8, -16,  64,   0,   0, -16},
<a name="l00130"></a>00130         { -24,   0,  -8, -16,   0,  64, -16,   0},
<a name="l00131"></a>00131         { -16, -16,   0, -16,   0, -16,  64,   0},
<a name="l00132"></a>00132         { -24, -16,  -8,   0, -16,   0,   0,  64}},
<a name="l00133"></a>00133       <span class="comment">//Type-2: X and Y Hanging</span>
<a name="l00134"></a>00134       {{  88,  12,  12, -16, -16, -24, -24, -32},
<a name="l00135"></a>00135         {  12,  16,  -4,   0,  -8,   0,  -8,  -8},
<a name="l00136"></a>00136         {  12,  -4,  16,   0,  -8,  -8,   0,  -8},
<a name="l00137"></a>00137         { -16,   0,   0,  64, -16, -16, -16,   0},
<a name="l00138"></a>00138         { -16,  -8,  -8, -16,  64,   0,   0, -16},
<a name="l00139"></a>00139         { -24,   0,  -8, -16,   0,  64, -16,   0},
<a name="l00140"></a>00140         { -24,  -8,   0, -16,   0, -16,  64,   0},
<a name="l00141"></a>00141         { -32,  -8,  -8,   0, -16,   0,   0,  64}},
<a name="l00142"></a>00142       <span class="comment">//Type-3: X, Y and Z Hanging</span>
<a name="l00143"></a>00143       {{  88,   8,   8, -24,   8, -24, -24, -40},
<a name="l00144"></a>00144         {   8,  16,  -4,   0,  -4,   0,  -8,  -8},
<a name="l00145"></a>00145         {   8,  -4,  16,   0,  -4,  -8,   0,  -8},
<a name="l00146"></a>00146         { -24,   0,   0,  64,  -8, -16, -16,   0},
<a name="l00147"></a>00147         {   8,  -4,  -4,  -8,  16,   0,   0,  -8},
<a name="l00148"></a>00148         { -24,   0,  -8, -16,   0,  64, -16,   0},
<a name="l00149"></a>00149         { -24,  -8,   0, -16,   0, -16,  64,   0},
<a name="l00150"></a>00150         { -40,  -8,  -8,   0,  -8,   0,   0,  64}},
<a name="l00151"></a>00151       <span class="comment">//Type-4: XY and X and Y Hanging</span>
<a name="l00152"></a>00152       {{  84,  12,  12,   0, -20, -28, -28, -32},
<a name="l00153"></a>00153         {  12,  20,   0,   4, -12,  -4, -12,  -8},
<a name="l00154"></a>00154         {  12,   0,  20,   4, -12, -12,  -4,  -8},
<a name="l00155"></a>00155         {   0,   4,   4,   4,  -4,  -4,  -4,   0},
<a name="l00156"></a>00156         { -20, -12, -12,  -4,  64,   0,   0, -16},
<a name="l00157"></a>00157         { -28,  -4, -12,  -4,   0,  64, -16,   0},
<a name="l00158"></a>00158         { -28, -12,  -4,  -4,   0, -16,  64,   0},
<a name="l00159"></a>00159         { -32,  -8,  -8,   0, -16,   0,   0,  64}},
<a name="l00160"></a>00160       <span class="comment">//Type-5: XY and X and Y and Z Hanging</span>
<a name="l00161"></a>00161       {{  80,   6,   6,  -2,   6, -28, -28, -40},
<a name="l00162"></a>00162         {   6,  20,   0,   4,  -6,  -4, -12,  -8},
<a name="l00163"></a>00163         {   6,   0,  20,   4,  -6, -12,  -4,  -8},
<a name="l00164"></a>00164         {  -2,   4,   4,   4,  -2,  -4,  -4,   0},
<a name="l00165"></a>00165         {   6,  -6,  -6,  -2,  16,   0,   0,  -8},
<a name="l00166"></a>00166         { -28,  -4, -12,  -4,   0,  64, -16,   0},
<a name="l00167"></a>00167         { -28, -12,  -4,  -4,   0, -16,  64,   0},
<a name="l00168"></a>00168         { -40,  -8,  -8,   0,  -8,   0,   0,  64}},
<a name="l00169"></a>00169       <span class="comment">//Type-6:XY and YZ and X and Y and Z Hanging</span>
<a name="l00170"></a>00170       {{  70,   3,   2,  -3,   3, -32,  -3, -40},
<a name="l00171"></a>00171         {   3,  20,  -3,   4,  -9,  -4,  -3,  -8},
<a name="l00172"></a>00172         {   2,  -3,  22,   3,  -3, -16,   3,  -8},
<a name="l00173"></a>00173         {  -3,   4,   3,   4,  -3,  -4,  -1,   0},
<a name="l00174"></a>00174         {   3,  -9,  -3,  -3,  20,  -4,   4,  -8},
<a name="l00175"></a>00175         { -32,  -4, -16,  -4,  -4,  64,  -4,   0},
<a name="l00176"></a>00176         {  -3,  -3,   3,  -1,   4,  -4,   4,   0},
<a name="l00177"></a>00177         { -40,  -8,  -8,   0,  -8,   0,   0,  64}},
<a name="l00178"></a>00178       <span class="comment">//Type-7:All 6 Hanging</span>
<a name="l00179"></a>00179       {{  58,  -2,  -2,  -4,  -2,  -4,  -4, -40},
<a name="l00180"></a>00180         {  -2,  22,  -7,   3,  -7,   3,  -4,  -8},
<a name="l00181"></a>00181         {  -2,  -7,  22,   3,  -7,  -4,   3,  -8},
<a name="l00182"></a>00182         {  -4,   3,   3,   4,  -4,  -1,  -1,   0},
<a name="l00183"></a>00183         {  -2,  -7,  -7,  -4,  22,   3,   3,  -8},
<a name="l00184"></a>00184         {  -4,   3,  -4,  -1,   3,   4,  -1,   0},
<a name="l00185"></a>00185         {  -4,  -4,   3,  -1,   3,  -1,   4,   0},
<a name="l00186"></a>00186         { -40,  -8,  -8,   0,  -8,   0,   0,  64}}
<a name="l00187"></a>00187     };
<a name="l00188"></a>00188     <span class="keywordtype">int</span> ***Aijk = <span class="keyword">new</span> int2Ptr[8];
<a name="l00189"></a>00189     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;8;i++) {
<a name="l00190"></a>00190       Aijk[i] = <span class="keyword">new</span> int1Ptr[8];
<a name="l00191"></a>00191       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;8;j++) {
<a name="l00192"></a>00192         Aijk[i][j] = <span class="keyword">new</span> <span class="keywordtype">int</span>[8];
<a name="l00193"></a>00193         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0;k&lt;8;k++) {
<a name="l00194"></a>00194           Aijk[i][j][k] = Bijk[i][j][k];
<a name="l00195"></a>00195         }<span class="comment">//end k</span>
<a name="l00196"></a>00196       }<span class="comment">//end j</span>
<a name="l00197"></a>00197     }<span class="comment">//end i</span>
<a name="l00198"></a>00198     <a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a> = Aijk;
<a name="l00199"></a>00199   }
<a name="l00200"></a>00200   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="classstiffnessMatrix.html#174fb48ae4a6d22bd05cf59ac4f36c13">00203</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#174fb48ae4a6d22bd05cf59ac4f36c13">stiffnessMatrix::preMatVec</a>() {
<a name="l00204"></a>00204   <span class="comment">// nuVec should be set directly into matrix outside the loop ...</span>
<a name="l00205"></a>00205   <span class="keywordflow">if</span> (<a class="code" href="classot_1_1fem_1_1feMat.html#dc8c6b0e6d715bbc70339f9a08bb27b2">m_daType</a> == <a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6fed07c25adbae6025233c9d0e861e2df7">PETSC</a>) {
<a name="l00206"></a>00206     PetscScalar ***nuarray; <span class="comment">//</span>
<a name="l00207"></a>00207          <span class="comment">// int ierr;</span>
<a name="l00208"></a>00208          <span class="comment">// ierr = VecNorm(nuvec,NORM_INFINITY,&amp;m_nuval); CHKERRQ(ierr);</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordtype">int</span> ierr = DAVecGetArray(<a class="code" href="classot_1_1fem_1_1feMat.html#87a6821a9d62570de2ba74c64a864d42">m_DA</a>, nuvec, &amp;nuarray);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     m_nuarray = nuarray;
<a name="l00213"></a>00213     <span class="comment">// compute Hx</span>
<a name="l00214"></a>00214     PetscInt mx,my,mz;
<a name="l00215"></a>00215     ierr = DAGetInfo(<a class="code" href="classot_1_1fem_1_1feMat.html#87a6821a9d62570de2ba74c64a864d42">m_DA</a>,0, &amp;mx, &amp;my, &amp;mz, 0,0,0,0,0,0,0); CHKERRQ(ierr); 
<a name="l00216"></a>00216     CHKERRQ(ierr);
<a name="l00217"></a>00217     
<a name="l00218"></a>00218     m_dHx = <a class="code" href="classot_1_1fem_1_1feMat.html#42739ad7b45c6bab667bdb54f7a165d5">m_dLx</a>/(mx -1);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     m_dHx /= 192.0;
<a name="l00221"></a>00221   } <span class="keywordflow">else</span> {
<a name="l00222"></a>00222     PetscScalar *nuarray; 
<a name="l00223"></a>00223     <span class="comment">// Get nuarray</span>
<a name="l00224"></a>00224     <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#b3795ed86c2a14e75790d626426637cf">vecGetBuffer</a>(nuvec, nuarray, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>,<a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>);
<a name="l00225"></a>00225     m_nuarray = nuarray;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="comment">// compute Hx</span>
<a name="l00228"></a>00228     <span class="comment">// For octree Hx values will change per element, so has to be </span>
<a name="l00229"></a>00229     <span class="comment">// computed inside the loop.</span>
<a name="l00230"></a>00230          maxD = <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#f82f97af59d18d222fadc2d1fe4e8357">getMaxDepth</a>();
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     
<a name="l00233"></a>00233     <span class="comment">// Get the  x,y,z factors </span>
<a name="l00234"></a>00234     xFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (<a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#66b7464759a64ebfb009416c5fd6c0e7">getDimension</a>() &gt; 1) {
<a name="l00236"></a>00236       yFac = 1.0/((<span class="keywordtype">double</span>)(1u &lt;&lt; (maxD-1)));
<a name="l00237"></a>00237       <span class="keywordflow">if</span> (<a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#66b7464759a64ebfb009416c5fd6c0e7">getDimension</a>() &gt; 2) {
<a name="l00238"></a>00238         zFac = 1.0/((<span class="keywordtype">double</span>)(1u &lt;&lt; (maxD-1)));
<a name="l00239"></a>00239       }
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="classstiffnessMatrix.html#0606514a4a19e53dc53765095b4e3293">00246</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#7d78135455efac78f02a67a651ae745f">stiffnessMatrix::ElementalMatVec</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, PetscScalar *in, PetscScalar *out, <span class="keywordtype">double</span> scale) {
<a name="l00247"></a>00247   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lev = <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#f4bee91c22427cf82991a9e19b2089bd">getLevel</a>(i);
<a name="l00248"></a>00248   <span class="keywordtype">double</span> hx = xFac*(1u &lt;&lt; (maxD - lev));
<a name="l00249"></a>00249   <span class="keywordtype">double</span> hy = yFac*(1u &lt;&lt; (maxD - lev));
<a name="l00250"></a>00250   <span class="keywordtype">double</span> hz = zFac*(1u &lt;&lt; (maxD - lev));
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="keywordtype">double</span> fac11 = -hx*scale/192.0;
<a name="l00253"></a>00253   
<a name="l00254"></a>00254   stdElemType elemType;
<a name="l00255"></a>00255   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx[8];
<a name="l00256"></a>00256 
<a name="l00257"></a>00257   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hangingMask = <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#d8f0a54f94e0f0d46baf2f2399e78ce4">getHangingNodeIndex</a>(i);    <span class="comment">//  alignElementAndVertices(m_octDA, elemType, idx);       </span>
<a name="l00258"></a>00258   <span class="keywordtype">int</span> ***Aijk = (<span class="keywordtype">int</span> ***)<a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a>;
<a name="l00259"></a>00259   
<a name="l00260"></a>00260   <a class="code" href="classot_1_1fem_1_1feMatrix.html#08965766e4500cb7c3240002bd09c139">alignElementAndVertices</a>(<a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>, elemType, idx);       
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   PetscScalar *nuarray = (PetscScalar *)m_nuarray;
<a name="l00263"></a>00263   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0;k &lt; 8;k++) {
<a name="l00264"></a>00264     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;8;j++) {
<a name="l00265"></a>00265                 <span class="keywordtype">double</span> fac1 = nuarray[idx[k]]*fac11;
<a name="l00266"></a>00266       out[<a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>*idx[k]] +=  (fac1*(Aijk[elemType][k][j]))*in[<a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>*idx[j]];
<a name="l00267"></a>00267                 <span class="comment">//if(hangingMask) std::cout &lt;&lt; fac1*Aijk[elemType][k][j] &lt;&lt; " " ;</span>
<a name="l00268"></a>00268     }<span class="comment">//end for j</span>
<a name="l00269"></a>00269          <span class="comment">//      if(hangingMask) std::cout &lt;&lt; std::endl;</span>
<a name="l00270"></a>00270   }<span class="comment">//end for k</span>
<a name="l00271"></a>00271   <span class="comment">//  if(hangingMask) std::cout &lt;&lt; " /* ********************************************************************** */" &lt;&lt; std::endl;</span>
<a name="l00272"></a>00272   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="classstiffnessMatrix.html#7d78135455efac78f02a67a651ae745f">00275</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#7d78135455efac78f02a67a651ae745f">stiffnessMatrix::ElementalMatVec</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***in, PetscScalar ***out, <span class="keywordtype">double</span> scale){
<a name="l00276"></a>00276   <span class="keywordtype">int</span> dof= <a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>;
<a name="l00277"></a>00277   <span class="keywordtype">int</span> idx[8][3]={
<a name="l00278"></a>00278     {k, j, dof*i},
<a name="l00279"></a>00279     {k,j,dof*(i+1)},
<a name="l00280"></a>00280     {k,j+1,dof*i},
<a name="l00281"></a>00281     {k,j+1,dof*(i+1)},
<a name="l00282"></a>00282     {k+1, j, dof*i},
<a name="l00283"></a>00283     {k+1,j,dof*(i+1)},
<a name="l00284"></a>00284     {k+1,j+1,dof*i},
<a name="l00285"></a>00285     {k+1,j+1,dof*(i+1)}               
<a name="l00286"></a>00286   };             
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   <span class="keywordtype">double</span> stencilScale;
<a name="l00289"></a>00289   <span class="keywordtype">int</span> **Ajk = (<span class="keywordtype">int</span> **)<a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a>;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   PetscScalar ***nuarray = (PetscScalar ***)m_nuarray;
<a name="l00292"></a>00292   
<a name="l00293"></a>00293   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> q = 0; q &lt; 8; q++) {
<a name="l00294"></a>00294     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r = 0; r &lt; 8; r++) {
<a name="l00295"></a>00295       stencilScale = -(nuarray[k][j][i]*m_dHx)*scale;
<a name="l00296"></a>00296                 <span class="comment">// stencilScale = -(m_nuval*m_dHx)*scale;</span>
<a name="l00297"></a>00297                 <span class="comment">//              stencilScale = -(nuarray[k][j][dof*i]*m_dHx)*scale;</span>
<a name="l00298"></a>00298                 <span class="comment">//stencilScale = -(m_dHx)*scale;</span>
<a name="l00299"></a>00299       out[idx[q][0]][idx[q][1]][idx[q][2]] +=  stencilScale*Ajk[q][r]*in[idx[r][0]][idx[r][1]][idx[r][2]];
<a name="l00300"></a>00300       <span class="keywordflow">if</span> (dof &gt; 1)      
<a name="l00301"></a>00301         out[idx[q][0]][idx[q][1]][idx[q][2]+1] += 0.0;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303   }
<a name="l00304"></a>00304 <span class="preprocessor">#ifdef __DEBUG__</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>  <span class="comment">//            PetscPrintf(0,"stencil scale in stiffness matrix = %f\n",stencilScale);</span>
<a name="l00306"></a>00306 <span class="preprocessor">#endif</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>
<a name="l00308"></a>00308   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="classstiffnessMatrix.html#0ef04e20dd2ee914b28b9bfe7dd11bbe">00311</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#0ef04e20dd2ee914b28b9bfe7dd11bbe">stiffnessMatrix::postMatVec</a>() {
<a name="l00312"></a>00312   <span class="keywordflow">if</span> ( <a class="code" href="classot_1_1fem_1_1feMat.html#dc8c6b0e6d715bbc70339f9a08bb27b2">m_daType</a> == <a class="code" href="classot_1_1fem_1_1feMat.html#95541f37e5531f0287ce47b3bc83cb6fed07c25adbae6025233c9d0e861e2df7">PETSC</a>) {
<a name="l00313"></a>00313          PetscScalar ***nuarray = (PetscScalar ***)m_nuarray;
<a name="l00314"></a>00314     <span class="keywordtype">int</span> ierr = DAVecRestoreArray(<a class="code" href="classot_1_1fem_1_1feMat.html#87a6821a9d62570de2ba74c64a864d42">m_DA</a>, nuvec, &amp;nuarray);
<a name="l00315"></a>00315     CHKERRQ(ierr);
<a name="l00316"></a>00316   } <span class="keywordflow">else</span> {
<a name="l00317"></a>00317     PetscScalar *nuarray = (PetscScalar *)m_nuarray;
<a name="l00318"></a>00318     <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#27cec1eec5bec26ae265fd10e40692c1">vecRestoreBuffer</a>(nuvec, nuarray, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>,<a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>);
<a name="l00319"></a>00319   }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="classstiffnessMatrix.html#83a21a70bb07a70b689ea7800623f13d">00324</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#83a21a70bb07a70b689ea7800623f13d">stiffnessMatrix::ElementalMatGetDiagonal</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span> k, PetscScalar ***diag, <span class="keywordtype">double</span> scale) {
<a name="l00325"></a>00325   <span class="keywordtype">int</span> dof= <a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>;
<a name="l00326"></a>00326   <span class="keywordtype">int</span> idx[8][3]={
<a name="l00327"></a>00327     {k, j, dof*i},
<a name="l00328"></a>00328     {k,j,dof*(i+1)},
<a name="l00329"></a>00329     {k,j+1,dof*i},
<a name="l00330"></a>00330     {k,j+1,dof*(i+1)},
<a name="l00331"></a>00331     {k+1, j, dof*i},
<a name="l00332"></a>00332     {k+1,j,dof*(i+1)},
<a name="l00333"></a>00333     {k+1,j+1,dof*i},
<a name="l00334"></a>00334     {k+1,j+1,dof*(i+1)}               
<a name="l00335"></a>00335   };             
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   <span class="keywordtype">double</span> stencilScale;
<a name="l00338"></a>00338   <span class="keywordtype">int</span> **Ajk = (<span class="keywordtype">int</span> **)<a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a>;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340   PetscScalar ***nuarray = (PetscScalar ***)m_nuarray;
<a name="l00341"></a>00341   
<a name="l00342"></a>00342   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> q = 0; q &lt; 8; q++) {
<a name="l00343"></a>00343         <span class="comment">// stencilScale = -(m_nuval*m_dHx)*scale;</span>
<a name="l00344"></a>00344     stencilScale = -(nuarray[k][j][i]*m_dHx)*scale;
<a name="l00345"></a>00345     diag [idx[q][0]][idx[q][1]][idx[q][2]] +=  stencilScale*Ajk[q][q] ;
<a name="l00346"></a>00346         <span class="keywordflow">if</span> (dof &gt; 1)    
<a name="l00347"></a>00347       diag[idx[q][0]][idx[q][1]][idx[q][2]+1] += 0.0;
<a name="l00348"></a>00348   }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="comment">// std::cout &lt;&lt; "Nuval is " &lt;&lt; nuarray[k][j][i] &lt;&lt; std::endl;</span>
<a name="l00351"></a>00351   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a><a class="code" href="classstiffnessMatrix.html#0bdc91e7a7daba8ca1a7f01f10f83369">00354</a> <span class="keywordtype">bool</span> <a class="code" href="classstiffnessMatrix.html#83a21a70bb07a70b689ea7800623f13d">stiffnessMatrix::ElementalMatGetDiagonal</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, PetscScalar *diag, <span class="keywordtype">double</span> scale) {
<a name="l00355"></a>00355   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lev = <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#f4bee91c22427cf82991a9e19b2089bd">getLevel</a>(i);
<a name="l00356"></a>00356   <span class="keywordtype">double</span> hx = xFac*(1u &lt;&lt; (maxD - lev));
<a name="l00357"></a>00357   <span class="keywordtype">double</span> hy = yFac*(1u &lt;&lt; (maxD - lev));
<a name="l00358"></a>00358   <span class="keywordtype">double</span> hz = zFac*(1u &lt;&lt; (maxD - lev));
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="keywordtype">double</span> fac11 = -hx*scale/192.0;
<a name="l00361"></a>00361   
<a name="l00362"></a>00362   stdElemType elemType;
<a name="l00363"></a>00363   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx[8];
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hangingMask = <a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>-&gt;<a class="code" href="classot_1_1DA.html#d8f0a54f94e0f0d46baf2f2399e78ce4">getHangingNodeIndex</a>(i);    <span class="comment">//  alignElementAndVertices(m_octDA, elemType, idx);       </span>
<a name="l00366"></a>00366   <span class="keywordtype">int</span> ***Aijk = (<span class="keywordtype">int</span> ***)<a class="code" href="classot_1_1fem_1_1feMatrix.html#9c7ae6dd2c15f5c455b473fe638b0f86">m_stencil</a>;
<a name="l00367"></a>00367   
<a name="l00368"></a>00368   <a class="code" href="classot_1_1fem_1_1feMatrix.html#08965766e4500cb7c3240002bd09c139">alignElementAndVertices</a>(<a class="code" href="classot_1_1fem_1_1feMat.html#f26339ef6b6b9eb5f74bdd9e0c11d596">m_octDA</a>, elemType, idx);       
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   PetscScalar *nuarray = (PetscScalar *)m_nuarray;
<a name="l00371"></a>00371   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0;k &lt; 8;k++) {
<a name="l00372"></a>00372     <span class="keywordtype">double</span> fac1 = nuarray[idx[k]]*fac11;
<a name="l00373"></a>00373     diag[<a class="code" href="classot_1_1fem_1_1feMatrix.html#a2cf6e20fc8bc82f43dde9ec05ef4165">m_uiDof</a>*idx[k]] +=  (fac1*(Aijk[elemType][k][k]));
<a name="l00374"></a>00374   }<span class="comment">//end for k</span>
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 <span class="preprocessor">#endif </span><span class="comment">/*_STIFFNESSMATRIX_H_*/</span>
<a name="l00381"></a>00381 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Mar 23 19:58:48 2010 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
