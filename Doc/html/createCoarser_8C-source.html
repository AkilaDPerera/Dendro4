<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/createCoarser.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>createCoarser.C</h1><a href="createCoarser_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include "mpi.h"</span>
00003 <span class="preprocessor">#include "petsc.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="colors_8h.html">colors.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
00012 
<a name="l00013"></a><a class="code" href="createCoarser_8C.html#a0">00013</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="createCoarser_8C.html#a0">help</a>[] = <span class="stringliteral">"Solves 3D PBE using FEM, MG, DA and Matrix-Free methods.\n\n"</span>;
00014 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00015 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="createCoarser_8C.html#a1">00019</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00020   <span class="keywordtype">int</span> size, rank;
00021   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numPts;
00022   <span class="keywordtype">char</span> pFile[50],oFile[50];
00023   <span class="keywordtype">double</span> gSize[3];
00024   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ptsLen;
00025   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxNumPts= 1;
00026   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim=3;
00027   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth=30;
00028   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> locSz, totalSz;
00029   <span class="keywordtype">int</span> nlevels;
00030   std::vector&lt;ot::TreeNode&gt; linOct, balOct;
00031   std::vector&lt;double&gt; pts;
00032 
00033   PetscInitialize(&amp;argc,&amp;argv,0,<a class="code" href="createCoarser_8C.html#a0">help</a>);
00034   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00035 
00036   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00037 
00038 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00039 <span class="preprocessor"></span>  <span class="keywordtype">int</span> stages[3];
00040   PetscLogStageRegister(&amp;stages[0],<span class="stringliteral">"P2O."</span>);
00041   PetscLogStageRegister(&amp;stages[1],<span class="stringliteral">"Bal"</span>);  
00042   PetscLogStageRegister(&amp;stages[2],<span class="stringliteral">"Solve"</span>);  
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00046   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00047   <span class="keywordflow">if</span>(argc &lt; 2) {
00048     std::cerr &lt;&lt; <span class="stringliteral">"Usage: "</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">"inpfile  maxDepth[30] \</span>
00049 <span class="stringliteral">      dim[3] maxNumPtsPerOctant[1] nlevels[2] "</span> &lt;&lt; std::endl;
00050     <span class="keywordflow">return</span> -1;
00051   }
00052   <span class="keywordflow">if</span>(argc &gt; 2) {
00053     maxDepth = atoi(argv[2]);
00054   }
00055   <span class="keywordflow">if</span>(argc &gt; 3) {
00056     dim = atoi(argv[3]);
00057   }
00058   <span class="keywordflow">if</span>(argc &gt; 4) {
00059     maxNumPts = atoi(argv[4]);
00060   }
00061   <span class="keywordflow">if</span>(argc &gt; 5) {
00062     nlevels = atoi(argv[5]);
00063   }
00064 
00065   sprintf(pFile,<span class="stringliteral">"%s%d_%d.pts"</span>,argv[1],rank,size);
00066   sprintf(oFile,<span class="stringliteral">"%s_Out%d_%d.ot"</span>,argv[1],rank,size);
00067 
00068   <span class="comment">//Points2Octree....</span>
00069   MPI_Barrier(MPI_COMM_WORLD);  
00070   <span class="keywordflow">if</span>(!rank){
00071     std::cout &lt;&lt; <span class="stringliteral">" reading  "</span>&lt;&lt;pFile&lt;&lt;std::endl; <span class="comment">// Point size</span>
00072   }
00073   <a class="code" href="namespaceot.html#a48">ot::readPtsFromFile</a>(pFile, pts);
00074   <span class="keywordflow">if</span>(!rank){
00075     std::cout &lt;&lt; <span class="stringliteral">" finished reading  "</span>&lt;&lt;pFile&lt;&lt;std::endl; <span class="comment">// Point size</span>
00076   }
00077   MPI_Barrier(MPI_COMM_WORLD);  
00078   ptsLen = pts.size();
00079   std::vector&lt;ot::TreeNode&gt; tmpNodes;
00080   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;ptsLen;i+=3) {
00081     <span class="keywordflow">if</span>( (pts[i] &gt; 0.0) &amp;&amp;
00082         (pts[i+1] &gt; 0.0)  
00083         &amp;&amp; (pts[i+2] &gt; 0.0) &amp;&amp;
00084         ( ((<span class="keywordtype">unsigned</span> int)(pts[i]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00085         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+1]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00086         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+2]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth)) ) {
00087       tmpNodes.push_back( <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00088             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+1]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00089             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+2]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00090             maxDepth,dim,maxDepth) );
00091     }
00092   }
00093   pts.clear();
00094   par::removeDuplicates&lt;ot::TreeNode&gt;(tmpNodes,<span class="keyword">false</span>,MPI_COMM_WORLD);   
00095   linOct = tmpNodes;
00096   tmpNodes.clear();
00097   par::partitionW&lt;ot::TreeNode&gt;(linOct, NULL,MPI_COMM_WORLD);
00098   <span class="comment">// reduce and only print the total ...</span>
00099   locSz = linOct.size();
00100   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00101   MPI_Barrier(MPI_COMM_WORLD);  
00102   <span class="keywordflow">if</span>(rank==0) {
00103     std::cout&lt;&lt;<span class="stringliteral">"# pts= "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00104   }
00105   MPI_Barrier(MPI_COMM_WORLD);  
00106 
00107   pts.resize(3*(linOct.size()));
00108   ptsLen = (3*(linOct.size()));
00109   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00110     pts[3*i] = (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00111     pts[(3*i)+1] = (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00112     pts[(3*i)+2] = (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00113   }<span class="comment">//end for i</span>
00114   linOct.clear();
00115   gSize[0] = 1.;
00116   gSize[1] = 1.;
00117   gSize[2] = 1.;
00118 
00119   MPI_Barrier(MPI_COMM_WORLD);  
00120 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00121 <span class="preprocessor"></span>  PetscLogStagePush(stages[0]);
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span>  <a class="code" href="namespaceot.html#a35">ot::points2Octree</a>(pts, gSize, linOct, dim, maxDepth, maxNumPts, MPI_COMM_WORLD);
00124 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00125 <span class="preprocessor"></span>  PetscLogStagePop();
00126 <span class="preprocessor">#endif</span>
00127 <span class="preprocessor"></span>  <span class="comment">// reduce and only print the total ...</span>
00128   locSz = linOct.size();
00129   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00130   <span class="keywordflow">if</span>(rank==0) {
00131     std::cout&lt;&lt;<span class="stringliteral">"# of Unbalanced Octants: "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00132   }
00133   pts.clear();
00134 
00135   <span class="comment">//Balancing...</span>
00136   MPI_Barrier(MPI_COMM_WORLD);  
00137 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00138 <span class="preprocessor"></span>  PetscLogStagePush(stages[1]);
00139 <span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span>  <a class="code" href="namespaceot.html#a10">ot::balanceOctree</a> (linOct, balOct, dim, maxDepth, <span class="keyword">true</span>, MPI_COMM_WORLD, NULL, NULL);
00141 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00142 <span class="preprocessor"></span>  PetscLogStagePop();
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>  linOct.clear();
00145   <span class="comment">// compute total inp size and output size</span>
00146   locSz = balOct.size();
00147   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00148 
00149   <span class="keywordflow">if</span>(!rank) {
00150     std::cout &lt;&lt; <span class="stringliteral">"# of Balanced Octants: "</span>&lt;&lt; totalSz &lt;&lt; std::endl;       
00151   }
00152 
00153   MPI_Barrier(MPI_COMM_WORLD);  
00154 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00155 <span class="preprocessor"></span>  PetscLogStagePush(stages[2]);
00156 <span class="preprocessor">#endif</span>
00157 <span class="preprocessor"></span>
00158 
00159   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a>        *damg;    
00160   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       dof =1;<span class="comment">// degrees of freedom per node  </span>
00161 
00162   <span class="comment">// Note: The user context for all levels will be set separately later.</span>
00163   MPI_Barrier(MPI_COMM_WORLD);  
00164 
00165   <span class="keywordflow">if</span>(!rank) {
00166     std::cout&lt;&lt;<span class="stringliteral">"nlevels initial: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00167   }
00168 
00169   <a class="code" href="namespaceot.html#a103">ot::DAMGCreateAndSetDA</a>(PETSC_COMM_WORLD, nlevels, NULL, &amp;damg,
00170       balOct, dof, 1.5, <span class="keyword">false</span>, <span class="keyword">true</span>);
00171 
00172   <span class="keywordflow">if</span>(!rank) {
00173     std::cout&lt;&lt;<span class="stringliteral">"nlevels final: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00174   }
00175 
00176   MPI_Barrier(MPI_COMM_WORLD);  
00177 
00178   <span class="keywordflow">if</span>(!rank) {
00179     std::cout &lt;&lt; <span class="stringliteral">"Created DA for all levels."</span>&lt;&lt; std::endl;
00180   }
00181 
00182   MPI_Barrier(MPI_COMM_WORLD);
00183   <a class="code" href="namespaceot.html#a108">ot::PrintDAMG</a>(damg);
00184   MPI_Barrier(MPI_COMM_WORLD);
00185 
00186   <a class="code" href="classot_1_1DA.html">ot::DA</a>* dac = damg[0]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>;
00187 
00188   std::vector&lt;ot::TreeNode&gt; outputOct;
00189 
00190   <span class="keywordflow">if</span>(dac-&gt;<a class="code" href="classot_1_1DA.html#a5">iAmActive</a>()) {
00191     <span class="keywordtype">double</span> factor = (1.0/(static_cast&lt;double&gt;(1u &lt;&lt; maxDepth)));
00192     <span class="keywordflow">for</span>(dac-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::WRITABLE&gt;();
00193         dac-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>() &lt; dac-&gt;<a class="code" href="classot_1_1DA.html#z36_2">end</a>&lt;ot::DA_FLAGS::WRITABLE&gt;();
00194         dac-&gt;<a class="code" href="classot_1_1DA.html#z36_13">next</a>&lt;ot::DA_FLAGS::WRITABLE&gt;() ) {
00195       <a class="code" href="classPoint.html">Point</a> currPt = dac-&gt;<a class="code" href="classot_1_1DA.html#z31_3">getCurrentOffset</a>();
00196       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lev = dac-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(dac-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>());
00197       <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> tmpNode(currPt.<a class="code" href="classPoint.html#z52_1">xint</a>(), currPt.<a class="code" href="classPoint.html#z52_3">yint</a>(), currPt.<a class="code" href="classPoint.html#z52_5">zint</a>(), (lev-1), dim, maxDepth);
00198       outputOct.push_back(tmpNode); 
00199     } 
00200   }
00201 
00202   <a class="code" href="namespaceot.html#a53">ot::writeNodesToFile</a>(oFile, outputOct);
00203   outputOct.clear();
00204 
00205   <a class="code" href="omg_8C.html#a0">iC</a>(<a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg));
00206 
00207   <span class="keywordflow">if</span> (!rank) {
00208     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed DAMG"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00209   }
00210 
00211 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00212 <span class="preprocessor"></span>  PetscLogStagePop();
00213 <span class="preprocessor">#endif</span>
00214 <span class="preprocessor"></span>  balOct.clear();
00215 
00216   <span class="keywordflow">if</span> (!rank) {
00217     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Finalizing ..."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00218   }
00219 
00220   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00221   PetscFinalize();
00222 
00223 }<span class="comment">//end function</span>
00224 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:23 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
