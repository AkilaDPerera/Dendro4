<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/checkError.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>checkError.C</h1><a href="checkError_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include "mpi.h"</span>
00003 <span class="preprocessor">#include "petsc.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="omgJac_8h.html">omgJac.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="handleStencils_8h.html">handleStencils.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="colors_8h.html">colors.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
00014 
<a name="l00015"></a><a class="code" href="checkError_8C.html#a0">00015</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="checkError_8C.html#a0">help</a>[] = <span class="stringliteral">"Scalar Problem"</span>;
00016 
00017 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00018 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00023 <span class="preprocessor"></span><span class="comment">//user-defined variables</span>
00024 <span class="keywordtype">int</span> Jac1DiagEvent;
00025 <span class="keywordtype">int</span> Jac1MultEvent;
00026 <span class="keywordtype">int</span> Jac1FinestDiagEvent;
00027 <span class="keywordtype">int</span> Jac1FinestMultEvent;
00028 
00029 <span class="keywordtype">int</span> Jac2DiagEvent;
00030 <span class="keywordtype">int</span> Jac2MultEvent;
00031 <span class="keywordtype">int</span> Jac2FinestDiagEvent;
00032 <span class="keywordtype">int</span> Jac2FinestMultEvent;
00033 
00034 <span class="keywordtype">int</span> Jac3DiagEvent;
00035 <span class="keywordtype">int</span> Jac3MultEvent;
00036 <span class="keywordtype">int</span> Jac3FinestDiagEvent;
00037 <span class="keywordtype">int</span> Jac3FinestMultEvent;
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="omgJac_8C.html#a9">00040</a> <span class="keywordtype">double</span>***** LaplacianType1Stencil; 
<a name="l00041"></a><a class="code" href="omgJac_8C.html#a11">00041</a> <span class="keywordtype">double</span>**** LaplacianType2Stencil; 
<a name="l00042"></a><a class="code" href="omgJac_8C.html#a10">00042</a> <span class="keywordtype">double</span>***** MassType1Stencil; 
<a name="l00043"></a><a class="code" href="vecMass_8C.html#a5">00043</a> <span class="keywordtype">double</span>**** MassType2Stencil; 
<a name="l00044"></a><a class="code" href="omgRhs_8C.html#a2">00044</a> <span class="keywordtype">double</span>****** ShapeFnStencil;
<a name="l00045"></a><a class="code" href="omgRhs_8C.html#a3">00045</a> <span class="keywordtype">double</span>**** ShapeFnCoeffs;
00046 
00047 
<a name="l00048"></a><a class="code" href="checkError_8C.html#a7">00048</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00049   <span class="keywordtype">int</span> size, rank;
00050   <span class="keywordtype">bool</span> incCorner = 1;  
00051   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numPts;
00052   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> solveU = 0;
00053   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> writeB = 0;  
00054   <span class="keywordtype">char</span> Kstr[20];
00055   <span class="keywordtype">char</span> pFile[50],bFile[50],uFile[50];
00056   <span class="keywordtype">double</span> gSize[3];
00057   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ptsLen;
00058   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxNumPts= 1;
00059   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim=3;
00060   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth=30;
00061   <span class="keywordtype">bool</span> compressLut=<span class="keyword">true</span>;
00062   <span class="keywordtype">double</span> localTime, totalTime;
00063   <span class="keywordtype">double</span> startTime, endTime;
00064   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> locSz, totalSz;
00065   std::vector&lt;ot::TreeNode&gt; linOct, balOct;
00066   std::vector&lt;double&gt; pts;
00067   <span class="keywordtype">double</span> mgLoadFac = 2.0;
00068 
00069   PetscInitialize(&amp;argc,&amp;argv,<span class="stringliteral">"options"</span>,<a class="code" href="checkError_8C.html#a0">help</a>);
00070   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00071 
00072   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00073 
00074 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00075 <span class="preprocessor"></span>  PetscLogEventRegister(&amp;Jac1DiagEvent,<span class="stringliteral">"ODAmatDiag"</span>,PETSC_VIEWER_COOKIE);
00076   PetscLogEventRegister(&amp;Jac1MultEvent,<span class="stringliteral">"ODAmatMult"</span>,PETSC_VIEWER_COOKIE);
00077   PetscLogEventRegister(&amp;Jac1FinestDiagEvent,<span class="stringliteral">"ODAmatDiagFinest"</span>,PETSC_VIEWER_COOKIE);
00078   PetscLogEventRegister(&amp;Jac1FinestMultEvent,<span class="stringliteral">"ODAmatMultFinest"</span>,PETSC_VIEWER_COOKIE);
00079 
00080   PetscLogEventRegister(&amp;Jac2DiagEvent,<span class="stringliteral">"OMGmatDiag-2"</span>,PETSC_VIEWER_COOKIE);
00081   PetscLogEventRegister(&amp;Jac2MultEvent,<span class="stringliteral">"OMGmatMult-2"</span>,PETSC_VIEWER_COOKIE);
00082   PetscLogEventRegister(&amp;Jac2FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-2"</span>,PETSC_VIEWER_COOKIE);
00083   PetscLogEventRegister(&amp;Jac2FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-2"</span>,PETSC_VIEWER_COOKIE);
00084 
00085   PetscLogEventRegister(&amp;Jac3DiagEvent,<span class="stringliteral">"OMGmatDiag-3"</span>,PETSC_VIEWER_COOKIE);
00086   PetscLogEventRegister(&amp;Jac3MultEvent,<span class="stringliteral">"OMGmatMult-3"</span>,PETSC_VIEWER_COOKIE);
00087   PetscLogEventRegister(&amp;Jac3FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-3"</span>,PETSC_VIEWER_COOKIE);
00088   PetscLogEventRegister(&amp;Jac3FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-3"</span>,PETSC_VIEWER_COOKIE);
00089 
00090   <span class="keywordtype">int</span> stages[3];
00091   PetscLogStageRegister(&amp;stages[0],<span class="stringliteral">"P2O."</span>);
00092   PetscLogStageRegister(&amp;stages[1],<span class="stringliteral">"Bal"</span>);  
00093   PetscLogStageRegister(&amp;stages[2],<span class="stringliteral">"Solve"</span>);  
00094 <span class="preprocessor">#endif</span>
00095 <span class="preprocessor"></span>
00096   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00097   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00098   <span class="keywordflow">if</span>(argc &lt; 3) {
00099     std::cerr &lt;&lt; <span class="stringliteral">"Usage: "</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">"inpfile  maxDepth[30] solveU[0]\</span>
00100 <span class="stringliteral">      writeB[0] dim[3] maxNumPtsPerOctant[1] incCorner[1] compressLut[1] mgLoadFac[2.0] "</span> &lt;&lt; std::endl;
00101     <span class="keywordflow">return</span> -1;
00102   }
00103   <span class="keywordflow">if</span>(argc &gt; 2) {
00104     maxDepth = atoi(argv[2]);
00105   }
00106   <span class="keywordflow">if</span>(argc &gt; 3) {
00107     solveU = atoi(argv[3]);
00108   }
00109   <span class="keywordflow">if</span>(argc &gt; 4) {
00110     writeB = atoi(argv[4]);
00111   }
00112   <span class="keywordflow">if</span>(argc &gt; 5) {
00113     dim = atoi(argv[5]);
00114   }
00115   <span class="keywordflow">if</span>(argc &gt; 6) {
00116     maxNumPts = atoi(argv[6]);
00117   }
00118   <span class="keywordflow">if</span>(argc &gt; 7) { incCorner = (bool)(atoi(argv[7]));}  
00119   <span class="keywordflow">if</span>(argc &gt; 8) { compressLut = (bool)(atoi(argv[8]));}
00120   <span class="keywordflow">if</span>(argc &gt; 9) { mgLoadFac = atof(argv[9]); }
00121 
00122   strcpy(bFile,argv[1]);
00123   <a class="code" href="namespaceot.html#a55">ot::int2str</a>(rank,Kstr);
00124   strcat(bFile,Kstr);
00125   strcat(bFile,<span class="stringliteral">"_\0"</span>);
00126   <a class="code" href="namespaceot.html#a55">ot::int2str</a>(size,Kstr);
00127   strcat(bFile,Kstr);
00128   strcpy(pFile,bFile);
00129   strcpy(uFile,bFile);
00130   strcat(bFile,<span class="stringliteral">"_Bal.ot\0"</span>);
00131   strcat(pFile,<span class="stringliteral">".pts\0"</span>);
00132   strcat(uFile,<span class="stringliteral">".sol\0"</span>);
00133 
00134   <span class="comment">//Points2Octree....</span>
00135   MPI_Barrier(MPI_COMM_WORLD);  
00136   <span class="keywordflow">if</span>(!rank){
00137     std::cout &lt;&lt; <span class="stringliteral">" reading  "</span>&lt;&lt;pFile&lt;&lt;std::endl; <span class="comment">// Point size</span>
00138   }
00139   <a class="code" href="namespaceot.html#a48">ot::readPtsFromFile</a>(pFile, pts);
00140   <span class="keywordflow">if</span>(!rank){
00141     std::cout &lt;&lt; <span class="stringliteral">" finished reading  "</span>&lt;&lt;pFile&lt;&lt;std::endl; <span class="comment">// Point size</span>
00142   }
00143   MPI_Barrier(MPI_COMM_WORLD);  
00144   ptsLen = pts.size();
00145   std::vector&lt;ot::TreeNode&gt; tmpNodes;
00146   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;ptsLen;i+=3) {
00147     <span class="keywordflow">if</span>( (pts[i] &gt; 0.0) &amp;&amp;
00148         (pts[i+1] &gt; 0.0)  
00149         &amp;&amp; (pts[i+2] &gt; 0.0) &amp;&amp;
00150         ( ((<span class="keywordtype">unsigned</span> int)(pts[i]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00151         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+1]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00152         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+2]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth)) ) {
00153       tmpNodes.push_back( <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00154             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+1]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00155             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+2]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00156             maxDepth,dim,maxDepth) );
00157     }
00158   }
00159   pts.clear();
00160   par::removeDuplicates&lt;ot::TreeNode&gt;(tmpNodes,<span class="keyword">false</span>,MPI_COMM_WORLD);   
00161   linOct = tmpNodes;
00162   tmpNodes.clear();
00163   par::partitionW&lt;ot::TreeNode&gt;(linOct, NULL,MPI_COMM_WORLD);
00164   <span class="comment">// reduce and only print the total ...</span>
00165   locSz = linOct.size();
00166   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> totalNumPts;
00167   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalNumPts, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00168   MPI_Barrier(MPI_COMM_WORLD);  
00169   <span class="keywordflow">if</span>(rank==0) {
00170     std::cout&lt;&lt;<span class="stringliteral">"# pts= "</span> &lt;&lt; totalNumPts&lt;&lt;std::endl;
00171   }
00172   MPI_Barrier(MPI_COMM_WORLD);  
00173 
00174   PetscTruth setMatPropsUsingPts;
00175   PetscOptionsHasName(0,<span class="stringliteral">"-setMatPropsUsingPts"</span>,&amp;setMatPropsUsingPts);
00176 
00177   std::vector&lt;ot::TreeNode&gt; matPropNodes;
00178   <span class="keywordflow">if</span>(setMatPropsUsingPts) {
00179     matPropNodes = linOct;
00180   }
00181 
00182   pts.resize(3*(linOct.size()));
00183   ptsLen = (3*(linOct.size()));
00184 
00185   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00186     pts[3*i] = (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00187     pts[(3*i)+1] = (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00188     pts[(3*i)+2] = (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00189   }<span class="comment">//end for i</span>
00190   linOct.clear();
00191   gSize[0] = 1.;
00192   gSize[1] = 1.;
00193   gSize[2] = 1.;
00194 
00195   PetscTruth usingRegularOctree;
00196   PetscInt regLev;
00197   PetscOptionsHasName(0,<span class="stringliteral">"-useRegularOctreeAtLevel"</span>,&amp;usingRegularOctree);
00198   PetscOptionsGetInt(0,<span class="stringliteral">"-useRegularOctreeAtLevel"</span>,&amp;regLev,0);
00199 
00200   <span class="keywordflow">if</span>(usingRegularOctree) {
00201     <span class="keywordflow">if</span>(!rank) {
00202       std::cout&lt;&lt;<span class="stringliteral">"Creating Regular Fine Grid Octree."</span>&lt;&lt;std::endl;
00203     }
00204     balOct.clear();
00205     <a class="code" href="namespaceot.html#a41">createRegularOctree</a>(balOct,regLev,3,maxDepth,MPI_COMM_WORLD);
00206   } <span class="keywordflow">else</span> {   
00207     MPI_Barrier(MPI_COMM_WORLD);        
00208 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00209 <span class="preprocessor"></span>    PetscLogStagePush(stages[0]);
00210 <span class="preprocessor">#endif</span>
00211 <span class="preprocessor"></span>    startTime = MPI_Wtime();
00212     <a class="code" href="namespaceot.html#a35">ot::points2Octree</a>(pts, gSize, linOct, dim, maxDepth, maxNumPts, MPI_COMM_WORLD);
00213     endTime = MPI_Wtime();
00214 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00215 <span class="preprocessor"></span>    PetscLogStagePop();
00216 <span class="preprocessor">#endif</span>
00217 <span class="preprocessor"></span>    localTime = endTime - startTime;
00218     par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;totalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00219     <span class="keywordflow">if</span>(!rank){
00220       std::cout &lt;&lt;<span class="stringliteral">"P2n Time: "</span>&lt;&lt;totalTime &lt;&lt; std::endl;
00221     }
00222     <span class="comment">// reduce and only print the total ...</span>
00223     locSz = linOct.size();
00224     par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00225     <span class="keywordflow">if</span>(rank==0) {
00226       std::cout&lt;&lt;<span class="stringliteral">"# of Unbalanced Octants: "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00227     }
00228     pts.clear();
00229 
00230     <span class="comment">//Balancing...</span>
00231     MPI_Barrier(MPI_COMM_WORLD);        
00232 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00233 <span class="preprocessor"></span>    PetscLogStagePush(stages[1]);
00234 <span class="preprocessor">#endif</span>
00235 <span class="preprocessor"></span>    startTime = MPI_Wtime();
00236     <a class="code" href="namespaceot.html#a10">ot::balanceOctree</a> (linOct, balOct, dim, maxDepth, incCorner, MPI_COMM_WORLD, NULL, NULL);
00237     endTime = MPI_Wtime();
00238 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00239 <span class="preprocessor"></span>    PetscLogStagePop();
00240 <span class="preprocessor">#endif</span>
00241 <span class="preprocessor"></span>    linOct.clear();
00242   }
00243 
00244   PetscInt minCoarsestLevel = 0;
00245   PetscOptionsGetInt(0,<span class="stringliteral">"-minCoarsestLevel"</span>,&amp;minCoarsestLevel,0);
00246 
00247   assert(minCoarsestLevel &lt;= maxDepth);
00248 
00249   <span class="keywordflow">if</span>(!rank) {
00250     std::cout&lt;&lt;<span class="stringliteral">"min coarsest level reset to: "</span>&lt;&lt;minCoarsestLevel&lt;&lt;std::endl;
00251   }
00252 
00253   <span class="comment">//Since we only refine the coarse octants in an already balanced octree, the</span>
00254   <span class="comment">//2:1 balance constraint will be preserved after the following operation.</span>
00255   <span class="comment">//The following loop preserves the sorted order.</span>
00256   <span class="comment">//Linearity is preserved as well.</span>
00257   std::vector&lt;ot::TreeNode&gt; tmpBalOct;
00258   <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; balOct.size(); i++) {
00259     <span class="keywordflow">if</span>(balOct[i].getLevel() &gt;= minCoarsestLevel) {
00260       tmpBalOct.push_back(balOct[i]);
00261     } <span class="keywordflow">else</span> {     
00262       <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> currOct(balOct[i].getX(), balOct[i].getY(),
00263           balOct[i].getZ(), (minCoarsestLevel-1), dim, maxDepth);
00264       <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
00265         currOct.<a class="code" href="classot_1_1TreeNode.html#a2">addChildren</a>(tmpBalOct);
00266         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cNum = currOct.<a class="code" href="classot_1_1TreeNode.html#z19_3">getChildNumber</a>();       
00267         <span class="keywordflow">while</span>((cNum == 7) &amp;&amp; (balOct[i].isAncestor(currOct))) {
00268           <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> tmpNode = currOct.<a class="code" href="classot_1_1TreeNode.html#a9">getParent</a>();
00269           currOct = tmpNode;
00270           cNum = currOct.<a class="code" href="classot_1_1TreeNode.html#z19_3">getChildNumber</a>();
00271         }
00272         <span class="comment">//At this point, we need the first decendant (at level =</span>
00273         <span class="comment">//minCoarsestLevel-1) of the next brother of currOct </span>
00274         <span class="keywordflow">if</span>(balOct[i].isAncestor(currOct)) {
00275           <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> parOfCurr = currOct.<a class="code" href="classot_1_1TreeNode.html#a9">getParent</a>();
00276           std::vector&lt;ot::TreeNode&gt; tmpChildren;
00277           parOfCurr.<a class="code" href="classot_1_1TreeNode.html#a2">addChildren</a>(tmpChildren);
00278           currOct = <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>(tmpChildren[cNum+1].getX(), tmpChildren[cNum+1].getY(),
00279               tmpChildren[cNum+1].getZ(), (minCoarsestLevel-1), dim, maxDepth);
00280         } <span class="keywordflow">else</span> {
00281           <span class="keywordflow">break</span>;
00282         }
00283       }
00284     }
00285   }<span class="comment">//end for i</span>
00286   balOct = tmpBalOct;
00287   tmpBalOct.clear();
00288 
00289   <span class="keywordflow">if</span>(writeB) { 
00290     <a class="code" href="namespaceot.html#a53">ot::writeNodesToFile</a>(bFile,balOct);
00291   }
00292   <span class="comment">// compute total inp size and output size</span>
00293   locSz = balOct.size();
00294   localTime = endTime - startTime;
00295   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00296   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;totalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00297 
00298   <span class="keywordflow">if</span>(!rank) {
00299     std::cout &lt;&lt; <span class="stringliteral">"# of Balanced Octants: "</span>&lt;&lt; totalSz &lt;&lt; std::endl;       
00300     std::cout &lt;&lt; <span class="stringliteral">"bal Time: "</span>&lt;&lt;totalTime &lt;&lt; std::endl;
00301   }
00302 
00303   <span class="comment">//Solve ...</span>
00304   MPI_Barrier(MPI_COMM_WORLD);  
00305 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00306 <span class="preprocessor"></span>  PetscLogStagePush(stages[2]);
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>
00309   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a>        *damg;    
00310   <span class="keywordtype">int</span>       nlevels = 1; <span class="comment">//number of multigrid levels</span>
00311   PetscInt       numRefinements = 0;
00312   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       dof =1;<span class="comment">// degrees of freedom per node  </span>
00313 
00314   PetscInt nlevelsPetscInt = nlevels;
00315   PetscOptionsGetInt(0, <span class="stringliteral">"-nlevels"</span>, &amp;nlevelsPetscInt,0);
00316   nlevels = nlevelsPetscInt;
00317 
00318   PetscOptionsGetInt(0,<span class="stringliteral">"-numRefinements"</span>,&amp;numRefinements,0);
00319   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; numRefinements; i++) {
00320     std::vector&lt;ot::TreeNode&gt; tmpOct = balOct;
00321     balOct.clear();
00322     <a class="code" href="namespaceot.html#a39">ot::refineOctree</a>(tmpOct, balOct); 
00323   }
00324 
00325   MPI_Barrier(MPI_COMM_WORLD);  
00326 
00327   <span class="keywordflow">if</span>(!rank) {
00328     std::cout&lt;&lt;<span class="stringliteral">"nlevels initial: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00329   }
00330 
00331   <span class="comment">// Note: The user context for all levels will be set separately later.</span>
00332   <a class="code" href="namespaceot.html#a103">ot::DAMGCreateAndSetDA</a>(PETSC_COMM_WORLD, nlevels, NULL, &amp;damg,
00333       balOct, dof, mgLoadFac, compressLut, incCorner);
00334 
00335   <span class="keywordflow">if</span>(!rank) {
00336     std::cout&lt;&lt;<span class="stringliteral">"nlevels final: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00337   }
00338 
00339   MPI_Barrier(MPI_COMM_WORLD);  
00340 
00341   <span class="keywordflow">if</span>(!rank) {
00342     std::cout &lt;&lt; <span class="stringliteral">"Created DA for all levels."</span>&lt;&lt; std::endl;
00343   }
00344 
00345   MPI_Barrier(MPI_COMM_WORLD);
00346   <a class="code" href="namespaceot.html#a108">ot::PrintDAMG</a>(damg);
00347 
00348   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* allSizes = NULL;
00349 
00350   <span class="keywordflow">if</span>(!rank) {
00351     allSizes = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[6*size]; 
00352   }
00353 
00354   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev = 0; lev &lt; nlevels; lev++) {
00355     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> auxCtr = 0; auxCtr &lt; 2; auxCtr++) {
00356       <a class="code" href="classot_1_1DA.html">ot::DA</a>* currDa = NULL;
00357 
00358       <span class="keywordflow">if</span>(auxCtr == 0) {
00359         currDa = damg[lev]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>;
00360       }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(damg[lev]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o4">da_aux</a>) {
00361         currDa = damg[lev]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o4">da_aux</a>;
00362       } <span class="keywordflow">else</span> {
00363         <span class="keywordflow">break</span>;
00364       }
00365 
00366       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> localSizes[6];
00367 
00368       <span class="comment">//Pre-ghost size</span>
00369       localSizes[0] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_9">getIdxElementBegin</a>();
00370 
00371       <span class="comment">//Own element size</span>
00372       localSizes[2] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_5">getElementSize</a>();
00373 
00374       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> localTotalSize = currDa-&gt;<a class="code" href="classot_1_1DA.html#a2">getLocalBufferSize</a>();
00375 
00376       <span class="comment">//Post-ghost size</span>
00377       localSizes[1] = (localTotalSize - (currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_11">getIdxPostGhostBegin</a>()));
00378 
00379       <span class="comment">//Independent size</span>
00380       localSizes[3] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_12">getIndependentSize</a>();
00381 
00382       <span class="comment">//PreGhostElementSize</span>
00383       localSizes[4] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_22">getPreGhostElementSize</a>();
00384 
00385       <span class="comment">//Own Boundary size</span>
00386       localSizes[5] = ((currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_11">getIdxPostGhostBegin</a>()) - (currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_10">getIdxElementEnd</a>()));
00387 
00388       MPI_Gather(localSizes, 6, MPI_UNSIGNED, allSizes, 6,
00389           MPI_UNSIGNED, 0, MPI_COMM_WORLD);
00390 
00391       MPI_Barrier(MPI_COMM_WORLD);
00392 
00393       <span class="keywordflow">if</span>(!rank) {
00394         std::cout&lt;&lt;<span class="stringliteral">"Printing Info for lev: "</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">" auxCtr: "</span>&lt;&lt;auxCtr&lt;&lt;std::endl; 
00395         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; size; i++) {
00396           std::cout&lt;&lt;<span class="stringliteral">"Proc: "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">" PreGh: "</span>&lt;&lt;allSizes[6*i]
00397             &lt;&lt;<span class="stringliteral">" PostGh: "</span>&lt;&lt;allSizes[(6*i)+1]&lt;&lt;<span class="stringliteral">" own: "</span>
00398             &lt;&lt;allSizes[(6*i)+2]&lt;&lt;<span class="stringliteral">" Ind: "</span>&lt;&lt;allSizes[(6*i)+3]
00399             &lt;&lt;<span class="stringliteral">" preGhElems: "</span>&lt;&lt;allSizes[(6*i)+4]&lt;&lt;<span class="stringliteral">" LocalBnd: "</span>
00400             &lt;&lt;allSizes[(6*i)+5]&lt;&lt;std::endl;
00401           fflush(stdout);
00402         }
00403       }
00404       fflush(stdout);
00405     }<span class="comment">//end da or da_aux</span>
00406   }<span class="comment">//end lev</span>
00407 
00408   <span class="keywordflow">if</span>(!rank) {
00409     <span class="keyword">delete</span> [] allSizes;
00410   }
00411 
00412   MPI_Barrier(MPI_COMM_WORLD);
00413 
00414   <span class="keywordflow">if</span>(setMatPropsUsingPts) {
00415     PetscTruth setMatPropsAtCoarsest;
00416     PetscOptionsHasName(0,<span class="stringliteral">"-setMatPropsAtCoarsest"</span>,&amp;setMatPropsAtCoarsest);
00417     <span class="keywordflow">if</span>(setMatPropsAtCoarsest) {
00418       <span class="comment">//Coarsest is only 1 processor. So to align with coarse blocks, everything</span>
00419       <span class="comment">//must be sent to p0</span>
00420       <span class="keywordflow">if</span>(!rank) {
00421         par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00422             totalNumPts, MPI_COMM_WORLD);
00423       } <span class="keywordflow">else</span> {
00424         par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00425             0, MPI_COMM_WORLD);
00426       }
00427       matPropNodes.clear();
00428 
00429       std::vector&lt;double&gt; matPropPts(3*(linOct.size()));
00430       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00431         matPropPts[3*i] =
00432           (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00433         matPropPts[(3*i)+1] =
00434           (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00435         matPropPts[(3*i)+2] =
00436           (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00437       }<span class="comment">//end for i</span>
00438       linOct.clear();
00439 
00440       PetscReal lapFac = 0.0;
00441       PetscTruth optFound;
00442       PetscOptionsGetReal(<span class="stringliteral">"lap"</span>,<span class="stringliteral">"-MatPropFac"</span>,&amp;lapFac,&amp;optFound);
00443       std::vector&lt;double&gt; lapJumps((matPropPts.size()/3));
00444       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;lapJumps.size();i++) {
00445         lapJumps[i] = lapFac;
00446       }
00447       <a class="code" href="omgJac_8h.html#a2">SetCoarseToFineFromPts</a>(damg, matPropPts, lapJumps);
00448     } <span class="keywordflow">else</span> {
00449       <span class="keywordflow">if</span>(damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#a5">iAmActive</a>()) {
00450         <span class="keywordtype">int</span> npesActive;
00451         <span class="keywordtype">int</span> rankActive;
00452 
00453         MPI_Comm_size(damg[nlevels-1]-&gt;da-&gt;getCommActive(), &amp;npesActive);        
00454         MPI_Comm_rank(damg[nlevels-1]-&gt;da-&gt;getCommActive(), &amp;rankActive);        
00455 
00456         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> avgSize = (totalNumPts/npesActive);
00457         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remSize = (totalNumPts % npesActive);
00458 
00459         <span class="keywordflow">if</span>(rankActive &lt; remSize) {
00460           par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00461               (avgSize + 1), MPI_COMM_WORLD);
00462         } <span class="keywordflow">else</span> {
00463           par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00464               avgSize, MPI_COMM_WORLD);
00465         }
00466 
00467         matPropNodes.clear();
00468         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; linOct.size(); i++) {
00469           <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xpt, ypt, zpt;
00470           linOct[i].getAnchor(xpt,ypt,zpt);
00471           <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> tmpNode(xpt,ypt,zpt,(maxDepth+1),3,(maxDepth+1));
00472           matPropNodes.push_back(tmpNode); 
00473         }
00474         linOct.clear();
00475 
00476         std::vector&lt;ot::TreeNode&gt; minsArray(npesActive);
00477 
00478         std::vector&lt;ot::TreeNode&gt; blocks = damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#a0">getBlocks</a>();
00479 
00480         assert(!blocks.empty());
00481 
00482         <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> firstBlock = blocks[0];
00483 
00484         par::Mpi_Allgather&lt;ot::TreeNode&gt;(&amp;firstBlock, &amp;(*(minsArray.begin())), 1, 
00485             damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#z31_2">getCommActive</a>());
00486 
00487         <span class="keywordtype">int</span> *sendCnt = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00488         <span class="keywordtype">int</span> *recvCnt = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00489         <span class="keywordtype">int</span> *sendOffsets = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00490         <span class="keywordtype">int</span> *recvOffsets = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00491 
00492         <span class="comment">//compute the total number of nodes being sent to each proc ...</span>
00493         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; npesActive; i++) {
00494           sendCnt[i]=0;
00495           recvCnt[i]=0;
00496         }
00497 
00498         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blockCtr = 0;
00499         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tempCtr = 0; tempCtr &lt; matPropNodes.size(); tempCtr++) {
00500           <span class="keywordflow">while</span>( ((blockCtr + 1) &lt; npesActive) &amp;&amp;
00501               (matPropNodes[tempCtr] &gt;= minsArray[blockCtr+1]) ) {
00502             blockCtr++;
00503           }
00504           <span class="keywordflow">if</span> ( (blockCtr + 1) == npesActive) {
00505             sendCnt[blockCtr] += (matPropNodes.size() - tempCtr);
00506             <span class="keywordflow">break</span>;
00507           } <span class="keywordflow">else</span> {
00508             sendCnt[blockCtr]++;
00509           }
00510         }
00511 
00512         minsArray.clear();
00513 
00514         <span class="comment">// communicate with other procs how many you shall be sending and get how</span>
00515         <span class="comment">// many to recieve from whom.</span>
00516         par::Mpi_Alltoall&lt;int&gt;(sendCnt, recvCnt, 1, damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#z31_2">getCommActive</a>());
00517 
00518         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalRecv = 0;
00519         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; npesActive; i++) {
00520           totalRecv += recvCnt[i];
00521         }<span class="comment">//end for i</span>
00522 
00523         linOct.resize(totalRecv);
00524 
00525         sendOffsets[0] = 0;
00526         recvOffsets[0] = 0;
00527 
00528         <span class="comment">// compute offsets ...</span>
00529         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; npesActive; i++) {
00530           sendOffsets[i] = sendOffsets[i-1] + sendCnt[i-1];
00531           recvOffsets[i] = recvOffsets[i-1] + recvCnt[i-1];
00532         }<span class="comment">//end for i</span>
00533 
00534         <span class="comment">// perform All2Allv</span>
00535         par::Mpi_Alltoallv_sparse&lt;ot::TreeNode&gt;(&amp;(*(matPropNodes.begin())), sendCnt, sendOffsets,        
00536             &amp;(*(linOct.begin())), recvCnt, recvOffsets, damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#z31_2">getCommActive</a>());
00537 
00538         matPropNodes.clear();
00539 
00540         <span class="comment">// clean up ...</span>
00541         <span class="keyword">delete</span> [] sendCnt;
00542         sendCnt = NULL;
00543 
00544         <span class="keyword">delete</span> [] recvCnt;
00545         recvCnt = NULL;
00546 
00547         <span class="keyword">delete</span> [] sendOffsets;
00548         sendOffsets = NULL;
00549 
00550         <span class="keyword">delete</span> [] recvOffsets;
00551         recvOffsets = NULL;
00552 
00553       } <span class="keywordflow">else</span> {
00554         par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00555             0, MPI_COMM_WORLD);
00556         matPropNodes.clear();
00557       }
00558 
00559       std::vector&lt;double&gt; matPropPts(3*(linOct.size()));
00560       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00561         matPropPts[3*i] =
00562           (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00563         matPropPts[(3*i)+1] =
00564           (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00565         matPropPts[(3*i)+2] =
00566           (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00567       }<span class="comment">//end for i</span>
00568       linOct.clear();
00569 
00570       PetscReal lapFac = 0.0;
00571       PetscTruth optFound;
00572       PetscOptionsGetReal(<span class="stringliteral">"lap"</span>,<span class="stringliteral">"-MatPropFac"</span>,&amp;lapFac,&amp;optFound);
00573       std::vector&lt;double&gt; lapJumps((matPropPts.size()/3));
00574       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;lapJumps.size();i++) {
00575         lapJumps[i] = lapFac;
00576       }
00577       <a class="code" href="omgJac_8h.html#a3">SetUserContextsFromPts</a>(damg, matPropPts, lapJumps); 
00578     }
00579   } <span class="keywordflow">else</span> {
00580     <a class="code" href="omgJac_8h.html#a0">SetUserContexts</a>(damg);
00581   }
00582 
00583   MPI_Barrier(MPI_COMM_WORLD);
00584   <span class="keywordflow">if</span>(!rank) {
00585     std::cout &lt;&lt; <span class="stringliteral">"Set User Contexts all levels."</span>&lt;&lt; std::endl;
00586   }
00587 
00588   MPI_Barrier(MPI_COMM_WORLD);
00589 
00590   PetscInt       jacType = 1;
00591   PetscOptionsGetInt(0,<span class="stringliteral">"-jacType"</span>,&amp;jacType,0);
00592 
00593   MPI_Barrier(MPI_COMM_WORLD);
00594   <span class="keywordflow">if</span>(!rank) {
00595     std::cout &lt;&lt; <span class="stringliteral">"Creating stencils..."</span>&lt;&lt; std::endl;
00596   }
00597   MPI_Barrier(MPI_COMM_WORLD);
00598 
00599   <a class="code" href="handleType2Stencils_8C.html#a16">createLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00600 
00601   <a class="code" href="handleType2Stencils_8C.html#a12">createMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00602 
00603   <span class="keywordflow">if</span>(jacType == 3) {
00604     <a class="code" href="handleType1Stencils_8C.html#a4">createLmatType1</a>(<a class="code" href="checkError_8C.html#a1">LaplacianType1Stencil</a>);
00605     <a class="code" href="handleType1Stencils_8C.html#a0">createMmatType1</a>(<a class="code" href="checkError_8C.html#a3">MassType1Stencil</a>);
00606   }
00607   <a class="code" href="handleType2Stencils_8C.html#a4">createShFnMat</a>(<a class="code" href="checkError_8C.html#a5">ShapeFnStencil</a>);
00608   <a class="code" href="handleType2Stencils_8C.html#a0">createShapeFnCoeffs</a>(<a class="code" href="checkError_8C.html#a6">ShapeFnCoeffs</a>);
00609 
00610   MPI_Barrier(MPI_COMM_WORLD);
00611   <span class="keywordflow">if</span>(!rank) {
00612     std::cout &lt;&lt; <span class="stringliteral">"Created all stencils."</span>&lt;&lt; std::endl;
00613   }
00614   MPI_Barrier(MPI_COMM_WORLD);
00615 
00616   PetscInt rhsType = 2;
00617   PetscOptionsGetInt(0,<span class="stringliteral">"-rhsType"</span>,&amp;rhsType,0);
00618 
00619   <span class="comment">//Function handles</span>
00620   PetscErrorCode (*ComputeRHSHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Vec rhs) = NULL;
00621   PetscErrorCode (*CreateJacobianHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Mat *B) = NULL;
00622   PetscErrorCode (*ComputeJacobianHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Mat J, Mat B) = NULL;
00623 
00624   <span class="keywordflow">if</span>(rhsType == 0) {
00625     ComputeRHSHandle = ComputeRHS0;
00626   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 1) {
00627     ComputeRHSHandle = ComputeRHS1;
00628   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 2) {
00629     ComputeRHSHandle = ComputeRHS2;
00630   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 3) {
00631     ComputeRHSHandle = ComputeRHS3;
00632   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 4) {
00633     ComputeRHSHandle = ComputeRHS4;
00634   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 5) {
00635     ComputeRHSHandle = ComputeRHS5;
00636   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 6) {
00637     ComputeRHSHandle = ComputeRHS6;
00638   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 7) {
00639     ComputeRHSHandle = ComputeRHS7;
00640   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 8) {
00641     ComputeRHSHandle = ComputeRHS8;
00642   } <span class="keywordflow">else</span> {
00643     assert(<span class="keyword">false</span>);
00644   }
00645 
00646   <span class="keywordflow">if</span>(jacType == 1) {
00647     CreateJacobianHandle = CreateJacobian1;
00648     ComputeJacobianHandle = ComputeJacobian1;
00649   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 2) {
00650     CreateJacobianHandle = CreateJacobian2;
00651     ComputeJacobianHandle = ComputeJacobian2;
00652   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 3) {
00653     CreateJacobianHandle = CreateJacobian3;
00654     ComputeJacobianHandle = ComputeJacobian3;
00655     <span class="comment">//Skip the finest and the coarsest levels. For the other levels, J and B</span>
00656     <span class="comment">//must be different</span>
00657     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; (nlevels-1); i++) {
00658       <a class="code" href="namespaceot.html#a95">ot::DAMGCreateJMatrix</a>(damg[i], CreateJacobianHandle);
00659     }
00660   } <span class="keywordflow">else</span> {
00661     assert(<span class="keyword">false</span>);
00662   }
00663 
00664   <span class="comment">//Global Function Handles for using KSP_Shell (will be used @ the coarsest grid if not all</span>
00665   <span class="comment">//processors are active on the coarsest grid)</span>
00666   <span class="keywordflow">if</span> (jacType == 1) {
00667     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac1;
00668   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 2) {
00669     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac2;
00670   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 3) {
00671     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac3;
00672   } <span class="keywordflow">else</span> {
00673     assert(<span class="keyword">false</span>);
00674   }
00675 
00676   <a class="code" href="namespaceot.html#a96">ot::DAMGSetKSP</a>(damg, CreateJacobianHandle, ComputeJacobianHandle, ComputeRHSHandle);
00677 
00678   MPI_Barrier(MPI_COMM_WORLD);
00679   <span class="keywordflow">if</span>(!rank) {
00680     std::cout &lt;&lt; <span class="stringliteral">"Called DAMGSetKSP"</span>&lt;&lt; std::endl;
00681   }
00682   MPI_Barrier(MPI_COMM_WORLD);
00683 
00684   PetscReal norm2;
00685   PetscReal normInf;
00686 
00687   PetscTruth setRandomGuess = PETSC_FALSE;
00688   PetscOptionsHasName(0,<span class="stringliteral">"-setRandomGuess"</span>,&amp;setRandomGuess);
00689 
00690   <span class="keywordflow">if</span>(setRandomGuess) { 
00691     <a class="code" href="namespaceot.html#a98">ot::DAMGSetInitialGuess</a>(damg,ot::DAMGInitialGuessCurrent);
00692 
00693     PetscRandom rctx;  
00694     PetscRandomCreate(PETSC_COMM_WORLD,&amp;rctx);
00695     PetscRandomSetType(rctx,PETSCRAND48);
00696     PetscInt randomSeed = 12345;
00697     PetscOptionsGetInt(0,<span class="stringliteral">"-randomSeed"</span>,&amp;randomSeed,0);
00698     <span class="keywordflow">if</span>(!rank) {
00699       std::cout&lt;&lt;<span class="stringliteral">"Using Random Seed: "</span>&lt;&lt;randomSeed&lt;&lt;std::endl;
00700     }
00701     PetscRandomSetSeed(rctx,randomSeed);
00702     PetscRandomSeed(rctx);
00703     PetscRandomSetFromOptions(rctx);
00704 
00705     VecSetRandom((<a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg)),rctx);
00706 
00707     PetscRandomDestroy(rctx);
00708 
00709     VecNorm((<a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg)),NORM_INFINITY,&amp;normInf);
00710     VecNorm((<a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg)),NORM_2,&amp;norm2);
00711 
00712     MPI_Barrier(MPI_COMM_WORLD);
00713     <span class="keywordflow">if</span>(!rank) {
00714       std::cout &lt;&lt; <span class="stringliteral">"Solving with random intial guess"</span>&lt;&lt; std::endl;
00715       std::cout&lt;&lt;<span class="stringliteral">"Initial Norm2: "</span>&lt;&lt;norm2&lt;&lt;<span class="stringliteral">" NormInf: "</span>&lt;&lt;normInf&lt;&lt;std::endl;
00716     }
00717     MPI_Barrier(MPI_COMM_WORLD);
00718   }<span class="keywordflow">else</span> {
00719     MPI_Barrier(MPI_COMM_WORLD);
00720     <span class="keywordflow">if</span>(!rank) {
00721       std::cout &lt;&lt; <span class="stringliteral">"Solving with 0-intial guess"</span>&lt;&lt; std::endl;
00722     }
00723     MPI_Barrier(MPI_COMM_WORLD);
00724   }
00725 
00726   startTime = MPI_Wtime();
00727   <a class="code" href="namespaceot.html#a100">ot::DAMGSolve</a>(damg);
00728   endTime = MPI_Wtime();
00729 
00730   localTime = (endTime - startTime);
00731   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;totalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00732 
00733   MPI_Barrier(MPI_COMM_WORLD);
00734 
00735   <span class="keywordflow">if</span> (!rank) {
00736     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Done Solve"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00737     std::cout &lt;&lt; <span class="stringliteral">"Solve Time: "</span>&lt;&lt;totalTime &lt;&lt; std::endl;
00738   }
00739 
00740   MPI_Barrier(MPI_COMM_WORLD);
00741 
00742   <span class="keywordtype">double</span> error = <a class="code" href="omgRhs_8C.html#a16">ComputeError5</a>(<a class="code" href="omg_8h.html#a42">DAMGGetDA</a>(damg), <a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg));
00743 
00744   <span class="keywordflow">if</span>(!rank) {
00745     std::cout&lt;&lt;<span class="stringliteral">"L2 Error: "</span>&lt;&lt;error&lt;&lt;std::endl;
00746   }
00747 
00748   <span class="keywordtype">double</span> testError = <a class="code" href="omgRhs_8C.html#a17">TestError5</a>(<a class="code" href="omg_8h.html#a42">DAMGGetDA</a>(damg));
00749 
00750   <span class="keywordflow">if</span>(!rank) {
00751     std::cout&lt;&lt;<span class="stringliteral">"Test Error: "</span>&lt;&lt;testError&lt;&lt;std::endl;
00752   }
00753 
00754   <a class="code" href="handleType2Stencils_8C.html#a26">destroyLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00755   <a class="code" href="handleType2Stencils_8C.html#a27">destroyMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00756   <span class="keywordflow">if</span>(jacType == 3) {
00757     <a class="code" href="handleType1Stencils_8C.html#a8">destroyLmatType1</a>(<a class="code" href="checkError_8C.html#a1">LaplacianType1Stencil</a>);
00758     <a class="code" href="handleType1Stencils_8C.html#a9">destroyMmatType1</a>(<a class="code" href="checkError_8C.html#a3">MassType1Stencil</a>);
00759   }
00760   <a class="code" href="handleType2Stencils_8C.html#a29">destroyShFnMat</a>(<a class="code" href="checkError_8C.html#a5">ShapeFnStencil</a>);
00761   <a class="code" href="handleType2Stencils_8C.html#a25">destroyShapeFnCoeffs</a>(<a class="code" href="checkError_8C.html#a6">ShapeFnCoeffs</a>);
00762 
00763   <span class="keywordflow">if</span> (!rank) {
00764     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed Stencils"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00765   }
00766 
00767   <a class="code" href="omgNeumann_8C.html#a13">DestroyUserContexts</a>(damg);
00768 
00769   <span class="keywordflow">if</span> (!rank) {
00770     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed User Contexts."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00771   }
00772 
00773   MPI_Barrier(MPI_COMM_WORLD);
00774 
00775   <a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg);
00776 
00777   <span class="keywordflow">if</span> (!rank) {
00778     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed DAMG"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00779   }
00780   MPI_Barrier(MPI_COMM_WORLD);
00781 
00782 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00783 <span class="preprocessor"></span>  PetscLogStagePop();
00784 <span class="preprocessor">#endif</span>
00785 <span class="preprocessor"></span>  balOct.clear();
00786 
00787   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00788   <span class="keywordflow">if</span> (!rank) {
00789     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Finalizing ..."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00790   }
00791   MPI_Barrier(MPI_COMM_WORLD);
00792   PetscFinalize();
00793 }<span class="comment">//end function</span>
00794 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:22 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
