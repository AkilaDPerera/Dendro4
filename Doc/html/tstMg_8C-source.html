<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/tstMg.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>tstMg.C</h1><a href="tstMg_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include "mpi.h"</span>
00003 <span class="preprocessor">#include "petsc.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="omgJac_8h.html">omgJac.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="handleStencils_8h.html">handleStencils.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="colors_8h.html">colors.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
00014 
<a name="l00015"></a><a class="code" href="tstMg_8C.html#a0">00015</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="tstMg_8C.html#a0">help</a>[] = <span class="stringliteral">"Scalar Problem"</span>;
00016 
00017 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00018 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00023 <span class="preprocessor"></span><span class="comment">//user-defined variables</span>
00024 <span class="keywordtype">int</span> Jac1DiagEvent;
00025 <span class="keywordtype">int</span> Jac1MultEvent;
00026 <span class="keywordtype">int</span> Jac1FinestDiagEvent;
00027 <span class="keywordtype">int</span> Jac1FinestMultEvent;
00028 
00029 <span class="keywordtype">int</span> Jac2DiagEvent;
00030 <span class="keywordtype">int</span> Jac2MultEvent;
00031 <span class="keywordtype">int</span> Jac2FinestDiagEvent;
00032 <span class="keywordtype">int</span> Jac2FinestMultEvent;
00033 
00034 <span class="keywordtype">int</span> Jac3DiagEvent;
00035 <span class="keywordtype">int</span> Jac3MultEvent;
00036 <span class="keywordtype">int</span> Jac3FinestDiagEvent;
00037 <span class="keywordtype">int</span> Jac3FinestMultEvent;
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="tstMg_8C.html#a1">00040</a> <span class="keywordtype">double</span>***** LaplacianType1Stencil; 
<a name="l00041"></a><a class="code" href="tstMg_8C.html#a2">00041</a> <span class="keywordtype">double</span>**** LaplacianType2Stencil; 
<a name="l00042"></a><a class="code" href="tstMg_8C.html#a3">00042</a> <span class="keywordtype">double</span>***** MassType1Stencil; 
<a name="l00043"></a><a class="code" href="tstMg_8C.html#a4">00043</a> <span class="keywordtype">double</span>**** MassType2Stencil; 
<a name="l00044"></a><a class="code" href="tstMg_8C.html#a5">00044</a> <span class="keywordtype">double</span>****** ShapeFnStencil;
<a name="l00045"></a><a class="code" href="tstMg_8C.html#a6">00045</a> <span class="keywordtype">double</span>**** ShapeFnCoeffs;
00046 
<a name="l00047"></a><a class="code" href="tstMg_8C.html#a7">00047</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00048   <span class="keywordtype">int</span> size, rank;
00049   <span class="keywordtype">bool</span> incCorner = 1;  
00050   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numPts;
00051   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> solveU = 0;
00052   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> writeB = 0;  
00053   <span class="keywordtype">char</span> Kstr[20];
00054   <span class="keywordtype">char</span> pFile[50],bFile[50],uFile[50];
00055   <span class="keywordtype">double</span> gSize[3];
00056   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ptsLen;
00057   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxNumPts= 1;
00058   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim=3;
00059   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth=30;
00060   <span class="keywordtype">bool</span> compressLut=<span class="keyword">true</span>;
00061   <span class="keywordtype">double</span> localTime, totalTime;
00062   <span class="keywordtype">double</span> startTime, endTime;
00063   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> locSz, totalSz;
00064   std::vector&lt;ot::TreeNode&gt; linOct, balOct;
00065   std::vector&lt;double&gt; pts;
00066   <span class="keywordtype">double</span> mgLoadFac = 2.0;
00067 
00068   PetscInitialize(&amp;argc,&amp;argv,<span class="stringliteral">"options"</span>,<a class="code" href="tstMg_8C.html#a0">help</a>);
00069   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00070 
00071   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00072 
00073 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00074 <span class="preprocessor"></span>  PetscLogEventRegister(&amp;Jac1DiagEvent,<span class="stringliteral">"ODAmatDiag"</span>,PETSC_VIEWER_COOKIE);
00075   PetscLogEventRegister(&amp;Jac1MultEvent,<span class="stringliteral">"ODAmatMult"</span>,PETSC_VIEWER_COOKIE);
00076   PetscLogEventRegister(&amp;Jac1FinestDiagEvent,<span class="stringliteral">"ODAmatDiagFinest"</span>,PETSC_VIEWER_COOKIE);
00077   PetscLogEventRegister(&amp;Jac1FinestMultEvent,<span class="stringliteral">"ODAmatMultFinest"</span>,PETSC_VIEWER_COOKIE);
00078 
00079   PetscLogEventRegister(&amp;Jac2DiagEvent,<span class="stringliteral">"OMGmatDiag-2"</span>,PETSC_VIEWER_COOKIE);
00080   PetscLogEventRegister(&amp;Jac2MultEvent,<span class="stringliteral">"OMGmatMult-2"</span>,PETSC_VIEWER_COOKIE);
00081   PetscLogEventRegister(&amp;Jac2FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-2"</span>,PETSC_VIEWER_COOKIE);
00082   PetscLogEventRegister(&amp;Jac2FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-2"</span>,PETSC_VIEWER_COOKIE);
00083 
00084   PetscLogEventRegister(&amp;Jac3DiagEvent,<span class="stringliteral">"OMGmatDiag-3"</span>,PETSC_VIEWER_COOKIE);
00085   PetscLogEventRegister(&amp;Jac3MultEvent,<span class="stringliteral">"OMGmatMult-3"</span>,PETSC_VIEWER_COOKIE);
00086   PetscLogEventRegister(&amp;Jac3FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-3"</span>,PETSC_VIEWER_COOKIE);
00087   PetscLogEventRegister(&amp;Jac3FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-3"</span>,PETSC_VIEWER_COOKIE);
00088 
00089   <span class="keywordtype">int</span> stages[3];
00090   PetscLogStageRegister(&amp;stages[0],<span class="stringliteral">"P2O."</span>);
00091   PetscLogStageRegister(&amp;stages[1],<span class="stringliteral">"Bal"</span>);  
00092   PetscLogStageRegister(&amp;stages[2],<span class="stringliteral">"Solve"</span>);  
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>
00095   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00096   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00097   <span class="keywordflow">if</span>(argc &lt; 3) {
00098     std::cerr &lt;&lt; <span class="stringliteral">"Usage: "</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">"inpfile  maxDepth[30] solveU[0]\</span>
00099 <span class="stringliteral">      writeB[0] dim[3] maxNumPtsPerOctant[1] incCorner[1] compressLut[1] mgLoadFac[2.0] "</span> &lt;&lt; std::endl;
00100     <span class="keywordflow">return</span> -1;
00101   }
00102   <span class="keywordflow">if</span>(argc &gt; 2) {
00103     maxDepth = atoi(argv[2]);
00104   }
00105   <span class="keywordflow">if</span>(argc &gt; 3) {
00106     solveU = atoi(argv[3]);
00107   }
00108   <span class="keywordflow">if</span>(argc &gt; 4) {
00109     writeB = atoi(argv[4]);
00110   }
00111   <span class="keywordflow">if</span>(argc &gt; 5) {
00112     dim = atoi(argv[5]);
00113   }
00114   <span class="keywordflow">if</span>(argc &gt; 6) {
00115     maxNumPts = atoi(argv[6]);
00116   }
00117   <span class="keywordflow">if</span>(argc &gt; 7) { incCorner = (bool)(atoi(argv[7]));}  
00118   <span class="keywordflow">if</span>(argc &gt; 8) { compressLut = (bool)(atoi(argv[8]));}
00119   <span class="keywordflow">if</span>(argc &gt; 9) { mgLoadFac = atof(argv[9]); }
00120 
00121   strcpy(bFile,argv[1]);
00122   <a class="code" href="namespaceot.html#a55">ot::int2str</a>(rank,Kstr);
00123   strcat(bFile,Kstr);
00124   strcat(bFile,<span class="stringliteral">"_\0"</span>);
00125   <a class="code" href="namespaceot.html#a55">ot::int2str</a>(size,Kstr);
00126   strcat(bFile,Kstr);
00127   strcpy(pFile,bFile);
00128   strcpy(uFile,bFile);
00129   strcat(bFile,<span class="stringliteral">"_Bal.ot\0"</span>);
00130   strcat(pFile,<span class="stringliteral">".pts\0"</span>);
00131   strcat(uFile,<span class="stringliteral">".sol\0"</span>);
00132 
00133   <span class="comment">//Points2Octree....</span>
00134   MPI_Barrier(MPI_COMM_WORLD);  
00135   <span class="keywordflow">if</span>(!rank){
00136     std::cout &lt;&lt; <span class="stringliteral">" reading  "</span>&lt;&lt;pFile&lt;&lt;std::endl; <span class="comment">// Point size</span>
00137   }
00138   <a class="code" href="namespaceot.html#a48">ot::readPtsFromFile</a>(pFile, pts);
00139   <span class="keywordflow">if</span>(!rank){
00140     std::cout &lt;&lt; <span class="stringliteral">" finished reading  "</span>&lt;&lt;pFile&lt;&lt;std::endl; <span class="comment">// Point size</span>
00141   }
00142   MPI_Barrier(MPI_COMM_WORLD);  
00143   ptsLen = pts.size();
00144   std::vector&lt;ot::TreeNode&gt; tmpNodes;
00145   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;ptsLen;i+=3) {
00146     <span class="keywordflow">if</span>( (pts[i] &gt; 0.0) &amp;&amp;
00147         (pts[i+1] &gt; 0.0)  
00148         &amp;&amp; (pts[i+2] &gt; 0.0) &amp;&amp;
00149         ( ((<span class="keywordtype">unsigned</span> int)(pts[i]*((double)(1u&lt;&lt;maxDepth)))) &lt; (1u&lt;&lt;maxDepth))  &amp;&amp;
00150         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+1]*((double)(1u&lt;&lt;maxDepth)))) &lt; (1u&lt;&lt;maxDepth))  &amp;&amp;
00151         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+2]*((double)(1u&lt;&lt;maxDepth)))) &lt; (1u&lt;&lt;maxDepth)) ) {
00152       tmpNodes.push_back( <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i]*(<span class="keywordtype">double</span>)(1u&lt;&lt;maxDepth)),
00153             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+1]*(<span class="keywordtype">double</span>)(1u&lt;&lt;maxDepth)),
00154             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+2]*(<span class="keywordtype">double</span>)(1u&lt;&lt;maxDepth)),
00155             maxDepth,dim,maxDepth) );
00156     }
00157   }
00158   pts.clear();
00159   par::removeDuplicates&lt;ot::TreeNode&gt;(tmpNodes,<span class="keyword">false</span>,MPI_COMM_WORLD);   
00160   linOct = tmpNodes;
00161   tmpNodes.clear();
00162   par::partitionW&lt;ot::TreeNode&gt;(linOct, NULL,MPI_COMM_WORLD);
00163   <span class="comment">// reduce and only print the total ...</span>
00164   locSz = linOct.size();
00165   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> totalNumPts;
00166   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalNumPts, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00167   MPI_Barrier(MPI_COMM_WORLD);  
00168   <span class="keywordflow">if</span>(rank==0) {
00169     std::cout&lt;&lt;<span class="stringliteral">"# pts= "</span> &lt;&lt; totalNumPts&lt;&lt;std::endl;
00170   }
00171   MPI_Barrier(MPI_COMM_WORLD);  
00172 
00173   PetscTruth setMatPropsUsingPts;
00174   PetscOptionsHasName(0,<span class="stringliteral">"-setMatPropsUsingPts"</span>,&amp;setMatPropsUsingPts);
00175 
00176   std::vector&lt;ot::TreeNode&gt; matPropNodes;
00177   <span class="keywordflow">if</span>(setMatPropsUsingPts) {
00178     matPropNodes = linOct;
00179   }
00180 
00181   pts.resize(3*(linOct.size()));
00182   ptsLen = (3*(linOct.size()));
00183 
00184   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00185     pts[3*i] = (((double)(linOct[i].getX())) + 0.5)/((double)(1u&lt;&lt;maxDepth));
00186     pts[(3*i)+1] = (((double)(linOct[i].getY())) +0.5)/((double)(1u&lt;&lt;maxDepth));
00187     pts[(3*i)+2] = (((double)(linOct[i].getZ())) +0.5)/((double)(1u&lt;&lt;maxDepth));
00188   }<span class="comment">//end for i</span>
00189   linOct.clear();
00190   gSize[0] = 1.;
00191   gSize[1] = 1.;
00192   gSize[2] = 1.;
00193 
00194   PetscTruth usingRegularOctree;
00195   PetscInt regLev;
00196   PetscOptionsHasName(0,<span class="stringliteral">"-useRegularOctreeAtLevel"</span>,&amp;usingRegularOctree);
00197   PetscOptionsGetInt(0,<span class="stringliteral">"-useRegularOctreeAtLevel"</span>,&amp;regLev,0);
00198 
00199   <span class="keywordflow">if</span>(usingRegularOctree) {
00200     <span class="keywordflow">if</span>(!rank) {
00201       std::cout&lt;&lt;<span class="stringliteral">"Creating Regular Fine Grid Octree."</span>&lt;&lt;std::endl;
00202     }
00203     balOct.clear();
00204     <a class="code" href="namespaceot.html#a41">createRegularOctree</a>(balOct,regLev,3,maxDepth,MPI_COMM_WORLD);
00205   } <span class="keywordflow">else</span> {   
00206     MPI_Barrier(MPI_COMM_WORLD);        
00207 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00208 <span class="preprocessor"></span>    PetscLogStagePush(stages[0]);
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>    startTime = MPI_Wtime();
00211     <a class="code" href="namespaceot.html#a35">ot::points2Octree</a>(pts, gSize, linOct, dim, maxDepth, maxNumPts, MPI_COMM_WORLD);
00212     endTime = MPI_Wtime();
00213 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00214 <span class="preprocessor"></span>    PetscLogStagePop();
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>    localTime = endTime - startTime;
00217     par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;totalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00218     <span class="keywordflow">if</span>(!rank){
00219       std::cout &lt;&lt;<span class="stringliteral">"P2n Time: "</span>&lt;&lt;totalTime &lt;&lt; std::endl;
00220     }
00221     <span class="comment">// reduce and only print the total ...</span>
00222     locSz = linOct.size();
00223     par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00224     <span class="keywordflow">if</span>(rank==0) {
00225       std::cout&lt;&lt;<span class="stringliteral">"# of Unbalanced Octants: "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00226     }
00227     pts.clear();
00228 
00229     <span class="comment">//Balancing...</span>
00230     MPI_Barrier(MPI_COMM_WORLD);        
00231 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00232 <span class="preprocessor"></span>    PetscLogStagePush(stages[1]);
00233 <span class="preprocessor">#endif</span>
00234 <span class="preprocessor"></span>    startTime = MPI_Wtime();
00235     <a class="code" href="namespaceot.html#a10">ot::balanceOctree</a> (linOct, balOct, dim, maxDepth, incCorner, MPI_COMM_WORLD, NULL, NULL);
00236     endTime = MPI_Wtime();
00237 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00238 <span class="preprocessor"></span>    PetscLogStagePop();
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>    linOct.clear();
00241   }
00242 
00243   <span class="keywordflow">if</span>(writeB) { 
00244     <a class="code" href="namespaceot.html#a53">ot::writeNodesToFile</a>(bFile,balOct);
00245   }
00246   <span class="comment">// compute total inp size and output size</span>
00247   locSz = balOct.size();
00248   localTime = endTime - startTime;
00249   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;locSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00250   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;totalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00251 
00252   <span class="keywordflow">if</span>(!rank) {
00253     std::cout &lt;&lt; <span class="stringliteral">"# of Balanced Octants: "</span>&lt;&lt; totalSz &lt;&lt; std::endl;       
00254     std::cout &lt;&lt; <span class="stringliteral">"bal Time: "</span>&lt;&lt;totalTime &lt;&lt; std::endl;
00255   }
00256 
00257   <span class="comment">//Solve ...</span>
00258   MPI_Barrier(MPI_COMM_WORLD);  
00259 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00260 <span class="preprocessor"></span>  PetscLogStagePush(stages[2]);
00261 <span class="preprocessor">#endif</span>
00262 <span class="preprocessor"></span>
00263   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a>        *damg;    
00264   <span class="keywordtype">int</span>       nlevels = 1; <span class="comment">//number of multigrid levels</span>
00265   PetscInt       numRefinements = 0;
00266   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       dof =1;<span class="comment">// degrees of freedom per node  </span>
00267 
00268   PetscInt nlevelsPetscInt = nlevels;
00269   PetscOptionsGetInt(0, <span class="stringliteral">"-nlevels"</span>, &amp;nlevelsPetscInt, 0);
00270   nlevels = nlevelsPetscInt;
00271 
00272   PetscOptionsGetInt(0,<span class="stringliteral">"-numRefinements"</span>,&amp;numRefinements,0);
00273   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; numRefinements; i++) {
00274     std::vector&lt;ot::TreeNode&gt; tmpOct = balOct;
00275     balOct.clear();
00276     <a class="code" href="namespaceot.html#a39">ot::refineOctree</a>(tmpOct, balOct); 
00277   }
00278 
00279   MPI_Barrier(MPI_COMM_WORLD);  
00280 
00281   <span class="keywordflow">if</span>(!rank) {
00282     std::cout&lt;&lt;<span class="stringliteral">"nlevels initial: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00283   }
00284 
00285   <span class="comment">// Note: The user context for all levels will be set separately later.</span>
00286   <a class="code" href="namespaceot.html#a103">ot::DAMGCreateAndSetDA</a>(PETSC_COMM_WORLD, nlevels, NULL, &amp;damg,
00287       balOct, dof, mgLoadFac, compressLut, incCorner);
00288 
00289   <span class="keywordflow">if</span>(!rank) {
00290     std::cout&lt;&lt;<span class="stringliteral">"nlevels final: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00291   }
00292 
00293   MPI_Barrier(MPI_COMM_WORLD);  
00294 
00295   <span class="keywordflow">if</span>(!rank) {
00296     std::cout &lt;&lt; <span class="stringliteral">"Created DA for all levels."</span>&lt;&lt; std::endl;
00297   }
00298 
00299   MPI_Barrier(MPI_COMM_WORLD);
00300   <a class="code" href="namespaceot.html#a108">ot::PrintDAMG</a>(damg);
00301 
00302   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* allSizes = NULL;
00303 
00304   <span class="keywordflow">if</span>(!rank) {
00305     allSizes = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[6*size]; 
00306   }
00307 
00308   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev = 0; lev &lt; nlevels; lev++) {
00309     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> auxCtr = 0; auxCtr &lt; 2; auxCtr++) {
00310       <a class="code" href="classot_1_1DA.html">ot::DA</a>* currDa = NULL;
00311 
00312       <span class="keywordflow">if</span>(auxCtr == 0) {
00313         currDa = damg[lev]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>;
00314       }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(damg[lev]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o4">da_aux</a>) {
00315         currDa = damg[lev]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o4">da_aux</a>;
00316       } <span class="keywordflow">else</span> {
00317         <span class="keywordflow">break</span>;
00318       }
00319 
00320       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> localSizes[6];
00321 
00322       <span class="comment">//Pre-ghost size</span>
00323       localSizes[0] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_9">getIdxElementBegin</a>();
00324 
00325       <span class="comment">//Own element size</span>
00326       localSizes[2] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_5">getElementSize</a>();
00327 
00328       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> localTotalSize = currDa-&gt;<a class="code" href="classot_1_1DA.html#a2">getLocalBufferSize</a>();
00329 
00330       <span class="comment">//Post-ghost size</span>
00331       localSizes[1] = (localTotalSize - (currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_11">getIdxPostGhostBegin</a>()));
00332 
00333       <span class="comment">//Independent size</span>
00334       localSizes[3] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_12">getIndependentSize</a>();
00335 
00336       <span class="comment">//PreGhostElementSize</span>
00337       localSizes[4] = currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_22">getPreGhostElementSize</a>();
00338 
00339       <span class="comment">//Own Boundary size</span>
00340       localSizes[5] = ((currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_11">getIdxPostGhostBegin</a>()) - (currDa-&gt;<a class="code" href="classot_1_1DA.html#z31_10">getIdxElementEnd</a>()));
00341 
00342       MPI_Gather(localSizes, 6, MPI_UNSIGNED, allSizes, 6,
00343           MPI_UNSIGNED, 0, MPI_COMM_WORLD);
00344 
00345       MPI_Barrier(MPI_COMM_WORLD);
00346 
00347       <span class="comment">/*</span>
00348 <span class="comment">      if(!rank) {</span>
00349 <span class="comment">        std::cout&lt;&lt;"Printing Info for lev: "&lt;&lt;lev&lt;&lt;" auxCtr: "&lt;&lt;auxCtr&lt;&lt;std::endl; </span>
00350 <span class="comment">        for(int i = 0; i &lt; size; i++) {</span>
00351 <span class="comment">          std::cout&lt;&lt;"Proc: "&lt;&lt;i&lt;&lt;" PreGh: "&lt;&lt;allSizes[6*i]</span>
00352 <span class="comment">            &lt;&lt;" PostGh: "&lt;&lt;allSizes[(6*i)+1]&lt;&lt;" own: "</span>
00353 <span class="comment">            &lt;&lt;allSizes[(6*i)+2]&lt;&lt;" Ind: "&lt;&lt;allSizes[(6*i)+3]</span>
00354 <span class="comment">            &lt;&lt;" preGhElems: "&lt;&lt;allSizes[(6*i)+4]&lt;&lt;" LocalBnd: "</span>
00355 <span class="comment">            &lt;&lt;allSizes[(6*i)+5]&lt;&lt;std::endl;</span>
00356 <span class="comment">          fflush(stdout);</span>
00357 <span class="comment">        }</span>
00358 <span class="comment">      }</span>
00359 <span class="comment">      */</span>
00360       fflush(stdout);
00361     }<span class="comment">//end da or da_aux</span>
00362   }<span class="comment">//end lev</span>
00363 
00364   <span class="keywordflow">if</span>(!rank) {
00365     <span class="keyword">delete</span> [] allSizes;
00366   }
00367 
00368   MPI_Barrier(MPI_COMM_WORLD);
00369 
00370   <span class="keywordflow">if</span>(setMatPropsUsingPts) {
00371     PetscTruth setMatPropsAtCoarsest;
00372     PetscOptionsHasName(0,<span class="stringliteral">"-setMatPropsAtCoarsest"</span>,&amp;setMatPropsAtCoarsest);
00373     <span class="keywordflow">if</span>(setMatPropsAtCoarsest) {
00374       <span class="comment">//Coarsest is only 1 processor. So to align with coarse blocks, everything</span>
00375       <span class="comment">//must be sent to p0</span>
00376       <span class="keywordflow">if</span>(!rank) {
00377         par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00378             totalNumPts, MPI_COMM_WORLD);
00379       } <span class="keywordflow">else</span> {
00380         par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00381             0, MPI_COMM_WORLD);
00382       }
00383       matPropNodes.clear();
00384 
00385       std::vector&lt;double&gt; matPropPts(3*(linOct.size()));
00386       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00387         matPropPts[3*i] =
00388           (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00389         matPropPts[(3*i)+1] =
00390           (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00391         matPropPts[(3*i)+2] =
00392           (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00393       }<span class="comment">//end for i</span>
00394       linOct.clear();
00395 
00396       PetscReal lapFac = 0.0;
00397       PetscTruth optFound;
00398       PetscOptionsGetReal(<span class="stringliteral">"lap"</span>,<span class="stringliteral">"-MatPropFac"</span>,&amp;lapFac,&amp;optFound);
00399       std::vector&lt;double&gt; lapJumps((matPropPts.size()/3));
00400       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;lapJumps.size();i++) {
00401         lapJumps[i] = lapFac;
00402       }
00403       <a class="code" href="omgJac_8h.html#a2">SetCoarseToFineFromPts</a>(damg, matPropPts, lapJumps);
00404     } <span class="keywordflow">else</span> {
00405       <span class="keywordflow">if</span>(damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#a5">iAmActive</a>()) {
00406         <span class="keywordtype">int</span> npesActive;
00407         <span class="keywordtype">int</span> rankActive;
00408 
00409         MPI_Comm_size(damg[nlevels-1]-&gt;da-&gt;getCommActive(), &amp;npesActive);        
00410         MPI_Comm_rank(damg[nlevels-1]-&gt;da-&gt;getCommActive(), &amp;rankActive);        
00411 
00412         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> avgSize = (totalNumPts/npesActive);
00413         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remSize = (totalNumPts % npesActive);
00414 
00415         <span class="keywordflow">if</span>(rankActive &lt; remSize) {
00416           par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00417               (avgSize + 1), MPI_COMM_WORLD);
00418         } <span class="keywordflow">else</span> {
00419           par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00420               avgSize, MPI_COMM_WORLD);
00421         }
00422 
00423         matPropNodes.clear();
00424         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; linOct.size(); i++) {
00425           <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xpt, ypt, zpt;
00426           linOct[i].getAnchor(xpt,ypt,zpt);
00427           <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> tmpNode(xpt,ypt,zpt,(maxDepth+1),3,(maxDepth+1));
00428           matPropNodes.push_back(tmpNode); 
00429         }
00430         linOct.clear();
00431 
00432         std::vector&lt;ot::TreeNode&gt; minsArray(npesActive);
00433 
00434         std::vector&lt;ot::TreeNode&gt; blocks = damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#a0">getBlocks</a>();
00435 
00436         assert(!blocks.empty());
00437 
00438         <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a> firstBlock = blocks[0];
00439 
00440         par::Mpi_Allgather&lt;ot::TreeNode&gt;(&amp;firstBlock, &amp;(*(minsArray.begin())), 1,
00441             damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#z31_2">getCommActive</a>());
00442 
00443         <span class="keywordtype">int</span> *sendCnt = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00444         <span class="keywordtype">int</span> *recvCnt = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00445         <span class="keywordtype">int</span> *sendOffsets = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00446         <span class="keywordtype">int</span> *recvOffsets = <span class="keyword">new</span> <span class="keywordtype">int</span>[npesActive];
00447 
00448         <span class="comment">//compute the total number of nodes being sent to each proc ...</span>
00449         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; npesActive; i++) {
00450           sendCnt[i]=0;
00451           recvCnt[i]=0;
00452         }
00453 
00454         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blockCtr = 0;
00455         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tempCtr = 0; tempCtr &lt; matPropNodes.size(); tempCtr++) {
00456           <span class="keywordflow">while</span>( ((blockCtr + 1) &lt; npesActive) &amp;&amp;
00457               (matPropNodes[tempCtr] &gt;= minsArray[blockCtr+1]) ) {
00458             blockCtr++;
00459           }
00460           <span class="keywordflow">if</span> ( (blockCtr + 1) == npesActive) {
00461             sendCnt[blockCtr] += (matPropNodes.size() - tempCtr);
00462             <span class="keywordflow">break</span>;
00463           } <span class="keywordflow">else</span> {
00464             sendCnt[blockCtr]++;
00465           }
00466         }
00467 
00468         minsArray.clear();
00469 
00470         <span class="comment">// communicate with other procs how many you shall be sending and get how</span>
00471         <span class="comment">// many to recieve from whom.</span>
00472         par::Mpi_Alltoall&lt;int&gt;(sendCnt, recvCnt, 1, damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#z31_2">getCommActive</a>());
00473 
00474         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalRecv = 0;
00475         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; npesActive; i++) {
00476           totalRecv += recvCnt[i];
00477         }<span class="comment">//end for i</span>
00478 
00479         linOct.resize(totalRecv);
00480 
00481         sendOffsets[0] = 0;
00482         recvOffsets[0] = 0;
00483 
00484         <span class="comment">// compute offsets ...</span>
00485         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; npesActive; i++) {
00486           sendOffsets[i] = sendOffsets[i-1] + sendCnt[i-1];
00487           recvOffsets[i] = recvOffsets[i-1] + recvCnt[i-1];
00488         }<span class="comment">//end for i</span>
00489 
00490         <span class="comment">// perform All2Allv</span>
00491         par::Mpi_Alltoallv_sparse&lt;ot::TreeNode&gt;(&amp;(*(matPropNodes.begin())), sendCnt, sendOffsets,        
00492             &amp;(*(linOct.begin())), recvCnt, recvOffsets, damg[nlevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>-&gt;<a class="code" href="classot_1_1DA.html#z31_2">getCommActive</a>());
00493 
00494         matPropNodes.clear();
00495 
00496         <span class="comment">// clean up ...</span>
00497         <span class="keyword">delete</span> [] sendCnt;
00498         sendCnt = NULL;
00499 
00500         <span class="keyword">delete</span> [] recvCnt;
00501         recvCnt = NULL;
00502 
00503         <span class="keyword">delete</span> [] sendOffsets;
00504         sendOffsets = NULL;
00505 
00506         <span class="keyword">delete</span> [] recvOffsets;
00507         recvOffsets = NULL;
00508 
00509       } <span class="keywordflow">else</span> {
00510         par::scatterValues&lt;ot::TreeNode&gt;(matPropNodes, linOct,
00511             0, MPI_COMM_WORLD);
00512         matPropNodes.clear();
00513       }
00514 
00515       std::vector&lt;double&gt; matPropPts(3*(linOct.size()));
00516       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;linOct.size();i++) {
00517         matPropPts[3*i] =
00518           (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00519         matPropPts[(3*i)+1] =
00520           (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00521         matPropPts[(3*i)+2] =
00522           (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00523       }<span class="comment">//end for i</span>
00524       linOct.clear();
00525 
00526       PetscReal lapFac = 0.0;
00527       PetscTruth optFound;
00528       PetscOptionsGetReal(<span class="stringliteral">"lap"</span>,<span class="stringliteral">"-MatPropFac"</span>,&amp;lapFac,&amp;optFound);
00529       std::vector&lt;double&gt; lapJumps((matPropPts.size()/3));
00530       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;lapJumps.size();i++) {
00531         lapJumps[i] = lapFac;
00532       }
00533       <a class="code" href="omgJac_8h.html#a3">SetUserContextsFromPts</a>(damg, matPropPts, lapJumps); 
00534     }
00535   } <span class="keywordflow">else</span> {
00536     <a class="code" href="omgJac_8h.html#a0">SetUserContexts</a>(damg);
00537   }
00538 
00539   MPI_Barrier(MPI_COMM_WORLD);
00540   <span class="keywordflow">if</span>(!rank) {
00541     std::cout &lt;&lt; <span class="stringliteral">"Set User Contexts all levels."</span>&lt;&lt; std::endl;
00542   }
00543 
00544   MPI_Barrier(MPI_COMM_WORLD);
00545 
00546   PetscInt       jacType = 1;
00547   PetscOptionsGetInt(0,<span class="stringliteral">"-jacType"</span>,&amp;jacType,0);
00548 
00549   MPI_Barrier(MPI_COMM_WORLD);
00550   <span class="keywordflow">if</span>(!rank) {
00551     std::cout &lt;&lt; <span class="stringliteral">"Creating stencils..."</span>&lt;&lt; std::endl;
00552   }
00553   MPI_Barrier(MPI_COMM_WORLD);
00554 
00555   <a class="code" href="handleType2Stencils_8C.html#a16">createLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00556 
00557   <a class="code" href="handleType2Stencils_8C.html#a12">createMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00558 
00559   <span class="keywordflow">if</span>(jacType == 3) {
00560     <a class="code" href="handleType1Stencils_8C.html#a4">createLmatType1</a>(<a class="code" href="checkError_8C.html#a1">LaplacianType1Stencil</a>);
00561     <a class="code" href="handleType1Stencils_8C.html#a0">createMmatType1</a>(<a class="code" href="checkError_8C.html#a3">MassType1Stencil</a>);
00562   }
00563   <a class="code" href="handleType2Stencils_8C.html#a4">createShFnMat</a>(<a class="code" href="checkError_8C.html#a5">ShapeFnStencil</a>);
00564   <a class="code" href="handleType2Stencils_8C.html#a0">createShapeFnCoeffs</a>(<a class="code" href="checkError_8C.html#a6">ShapeFnCoeffs</a>);
00565 
00566   MPI_Barrier(MPI_COMM_WORLD);
00567   <span class="keywordflow">if</span>(!rank) {
00568     std::cout &lt;&lt; <span class="stringliteral">"Created all stencils."</span>&lt;&lt; std::endl;
00569   }
00570   MPI_Barrier(MPI_COMM_WORLD);
00571 
00572   PetscInt rhsType = 2;
00573   PetscOptionsGetInt(0,<span class="stringliteral">"-rhsType"</span>,&amp;rhsType,0);
00574 
00575   <span class="comment">//Function handles</span>
00576   PetscErrorCode (*ComputeRHSHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Vec rhs) = NULL;
00577   PetscErrorCode (*CreateJacobianHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Mat *B) = NULL;
00578   PetscErrorCode (*ComputeJacobianHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Mat J, Mat B) = NULL;
00579 
00580   <span class="keywordflow">if</span>(rhsType == 0) {
00581     ComputeRHSHandle = ComputeRHS0;
00582   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 1) {
00583     ComputeRHSHandle = ComputeRHS1;
00584   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 2) {
00585     ComputeRHSHandle = ComputeRHS2;
00586   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 3) {
00587     ComputeRHSHandle = ComputeRHS3;
00588   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 4) {
00589     ComputeRHSHandle = ComputeRHS4;
00590   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 5) {
00591     ComputeRHSHandle = ComputeRHS5;
00592   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 6) {
00593     ComputeRHSHandle = ComputeRHS6;
00594   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 7) {
00595     ComputeRHSHandle = ComputeRHS7;
00596   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 8) {
00597     ComputeRHSHandle = ComputeRHS8;
00598   } <span class="keywordflow">else</span> {
00599     assert(<span class="keyword">false</span>);
00600   }
00601 
00602   <span class="keywordflow">if</span>(jacType == 1) {
00603     CreateJacobianHandle = CreateJacobian1;
00604     ComputeJacobianHandle = ComputeJacobian1;
00605   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 2) {
00606     CreateJacobianHandle = CreateJacobian2;
00607     ComputeJacobianHandle = ComputeJacobian2;
00608   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 3) {
00609     CreateJacobianHandle = CreateJacobian3;
00610     ComputeJacobianHandle = ComputeJacobian3;
00611     <span class="comment">//Skip the finest and the coarsest levels. For the other levels, J and B</span>
00612     <span class="comment">//must be different</span>
00613     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; (nlevels-1); i++) {
00614       <a class="code" href="namespaceot.html#a95">ot::DAMGCreateJMatrix</a>(damg[i], CreateJacobianHandle);
00615     }
00616   } <span class="keywordflow">else</span> {
00617     assert(<span class="keyword">false</span>);
00618   }
00619 
00620   <span class="comment">//Global Function Handles for using KSP_Shell (will be used @ the coarsest grid if not all</span>
00621   <span class="comment">//processors are active on the coarsest grid)</span>
00622   <span class="keywordflow">if</span> (jacType == 1) {
00623     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac1;
00624   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 2) {
00625     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac2;
00626   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 3) {
00627     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac3;
00628   } <span class="keywordflow">else</span> {
00629     assert(<span class="keyword">false</span>);
00630   }
00631 
00632   <a class="code" href="namespaceot.html#a96">ot::DAMGSetKSP</a>(damg, CreateJacobianHandle, ComputeJacobianHandle, ComputeRHSHandle);
00633 
00634   MPI_Barrier(MPI_COMM_WORLD);
00635   <span class="keywordflow">if</span>(!rank) {
00636     std::cout &lt;&lt; <span class="stringliteral">"Called DAMGSetKSP"</span>&lt;&lt; std::endl;
00637   }
00638   MPI_Barrier(MPI_COMM_WORLD);
00639 
00640   PetscReal norm2;
00641   PetscReal normInf;
00642 
00643   PetscTruth setRandomGuess = PETSC_FALSE;
00644   PetscOptionsHasName(0,<span class="stringliteral">"-setRandomGuess"</span>,&amp;setRandomGuess);
00645 
00646   <span class="keywordflow">if</span>(setRandomGuess) { 
00647     <a class="code" href="namespaceot.html#a98">ot::DAMGSetInitialGuess</a>(damg,ot::DAMGInitialGuessCurrent);
00648 
00649     PetscRandom rctx;  
00650     PetscRandomCreate(PETSC_COMM_WORLD,&amp;rctx);
00651     PetscRandomSetType(rctx,PETSCRAND48);
00652     PetscInt randomSeed = 12345;
00653     PetscOptionsGetInt(0,<span class="stringliteral">"-randomSeed"</span>,&amp;randomSeed,0);
00654     <span class="keywordflow">if</span>(!rank) {
00655       std::cout&lt;&lt;<span class="stringliteral">"Using Random Seed: "</span>&lt;&lt;randomSeed&lt;&lt;std::endl;
00656     }
00657     PetscRandomSetSeed(rctx,randomSeed);
00658     PetscRandomSeed(rctx);
00659     PetscRandomSetFromOptions(rctx);
00660 
00661     VecSetRandom((<a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg)),rctx);
00662 
00663     PetscRandomDestroy(rctx);
00664 
00665     VecNorm((<a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg)),NORM_INFINITY,&amp;normInf);
00666     VecNorm((<a class="code" href="omg_8h.html#a36">DAMGGetx</a>(damg)),NORM_2,&amp;norm2);
00667 
00668     MPI_Barrier(MPI_COMM_WORLD);
00669     <span class="keywordflow">if</span>(!rank) {
00670       std::cout &lt;&lt; <span class="stringliteral">"Solving with random intial guess"</span>&lt;&lt; std::endl;
00671       std::cout&lt;&lt;<span class="stringliteral">"Initial Norm2: "</span>&lt;&lt;norm2&lt;&lt;<span class="stringliteral">" NormInf: "</span>&lt;&lt;normInf&lt;&lt;std::endl;
00672     }
00673     MPI_Barrier(MPI_COMM_WORLD);
00674   }<span class="keywordflow">else</span> {
00675     MPI_Barrier(MPI_COMM_WORLD);
00676     <span class="keywordflow">if</span>(!rank) {
00677       std::cout &lt;&lt; <span class="stringliteral">"Solving with 0-intial guess"</span>&lt;&lt; std::endl;
00678     }
00679     MPI_Barrier(MPI_COMM_WORLD);
00680   }
00681 
00682   startTime = MPI_Wtime();
00683   <a class="code" href="namespaceot.html#a100">ot::DAMGSolve</a>(damg);
00684   endTime = MPI_Wtime();
00685 
00686   localTime = (endTime - startTime);
00687   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;totalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00688 
00689   MPI_Barrier(MPI_COMM_WORLD);
00690 
00691   <span class="keywordflow">if</span> (!rank) {
00692     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Done Solve"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00693     std::cout &lt;&lt; <span class="stringliteral">"Solve Time: "</span>&lt;&lt;totalTime &lt;&lt; std::endl;
00694   }
00695 
00696   MPI_Barrier(MPI_COMM_WORLD);
00697 
00698   <a class="code" href="handleType2Stencils_8C.html#a26">destroyLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00699   <a class="code" href="handleType2Stencils_8C.html#a27">destroyMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00700   <span class="keywordflow">if</span>(jacType == 3) {
00701     <a class="code" href="handleType1Stencils_8C.html#a8">destroyLmatType1</a>(<a class="code" href="checkError_8C.html#a1">LaplacianType1Stencil</a>);
00702     <a class="code" href="handleType1Stencils_8C.html#a9">destroyMmatType1</a>(<a class="code" href="checkError_8C.html#a3">MassType1Stencil</a>);
00703   }
00704   <a class="code" href="handleType2Stencils_8C.html#a29">destroyShFnMat</a>(<a class="code" href="checkError_8C.html#a5">ShapeFnStencil</a>);
00705   <a class="code" href="handleType2Stencils_8C.html#a25">destroyShapeFnCoeffs</a>(<a class="code" href="checkError_8C.html#a6">ShapeFnCoeffs</a>);
00706 
00707   <span class="keywordflow">if</span> (!rank) {
00708     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed Stencils"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00709   }
00710 
00711   <a class="code" href="omgNeumann_8C.html#a13">DestroyUserContexts</a>(damg);
00712 
00713   <span class="keywordflow">if</span> (!rank) {
00714     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed User Contexts."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00715   }
00716 
00717   MPI_Barrier(MPI_COMM_WORLD);
00718 
00719   <a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg);
00720 
00721   <span class="keywordflow">if</span> (!rank) {
00722     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed DAMG"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00723   }
00724   MPI_Barrier(MPI_COMM_WORLD);
00725 
00726 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00727 <span class="preprocessor"></span>  PetscLogStagePop();
00728 <span class="preprocessor">#endif</span>
00729 <span class="preprocessor"></span>  balOct.clear();
00730 
00731   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00732   <span class="keywordflow">if</span> (!rank) {
00733     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Finalizing ..."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00734   }
00735   MPI_Barrier(MPI_COMM_WORLD);
00736   PetscFinalize();
00737 }<span class="comment">//end function</span>
00738 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:26 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
