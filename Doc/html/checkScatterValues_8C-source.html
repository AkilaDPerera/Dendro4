<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/src/test/checkScatterValues.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000013.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000023.html">test</a></div>
<h1>checkScatterValues.C</h1><a href="checkScatterValues_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include "mpi.h"</span>
00003 <span class="preprocessor">#include &lt;iostream&gt;</span>
00004 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00005 <span class="preprocessor">#include &lt;ctime&gt;</span>
00006 <span class="preprocessor">#include "petscvec.h"</span>
00007 <span class="preprocessor">#include "<a class="code" href="dtypes_8h.html">dtypes.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
00012 
<a name="l00013"></a><a class="code" href="checkScatterValues_8C.html#a0">00013</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00014 
00015   <span class="keywordtype">int</span> rank, npes;
00016 
00017   PetscInitialize(&amp;argc,&amp;argv,NULL,NULL);
00018 
00019   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00020   MPI_Comm_size(MPI_COMM_WORLD,&amp;npes);
00021 
00022   <span class="comment">//PETSc Vec Version...</span>
00023   {
00024     <span class="comment">//Ensure that total size of the vectors are the same.</span>
00025     srand( time(NULL) );
00026     <span class="keywordtype">int</span> inSz = (rank+1)*( rand() % atoi(argv[1]) );
00027 
00028     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" inSz: "</span>&lt;&lt;inSz&lt;&lt;std::endl;
00029 
00030     Vec in;
00031     VecCreate(MPI_COMM_WORLD,&amp;in);
00032     VecSetSizes(in,inSz,PETSC_DECIDE);
00033     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Created Vec (in) "</span>&lt;&lt;std::endl;
00034     <span class="keywordflow">if</span>(npes &gt; 1) {
00035       VecSetType(in,VECMPI);
00036       std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Type: MPI "</span>&lt;&lt;std::endl;
00037     }<span class="keywordflow">else</span> {
00038       VecSetType(in,VECSEQ);
00039       std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Type: SEQ "</span>&lt;&lt;std::endl;
00040     }
00041 
00042     <span class="keywordtype">int</span> offRank;
00043 
00044     <span class="keywordflow">if</span>(!rank) {
00045       srand( time(NULL) );
00046       offRank = ( rand() % npes );
00047     }
00048 
00049     par::Mpi_Bcast&lt;int&gt;(&amp;offRank,1,0,MPI_COMM_WORLD);
00050 
00051     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" offRank: "</span>&lt;&lt;offRank&lt;&lt;std::endl;
00052 
00053     <span class="keywordtype">int</span> *inSizes = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00054     par::Mpi_Allgather&lt;int&gt;(&amp;inSz, inSizes, 1, MPI_COMM_WORLD);         
00055 
00056     <span class="keywordtype">int</span> *inDisps = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00057     inDisps[0] = 0;
00058     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; npes; i++) {
00059       inDisps[i] = inDisps[i-1] + inSizes[i-1];
00060     }
00061 
00062     <span class="comment">//CYCLIC SHIFT.</span>
00063     <span class="keywordtype">int</span> outSz = inSizes[(rank + offRank)%npes];
00064 
00065     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" outSz: "</span>&lt;&lt;outSz&lt;&lt;std::endl;
00066 
00067     Vec out;
00068     VecCreate(MPI_COMM_WORLD, &amp;out);
00069     VecSetSizes(out,outSz,PETSC_DECIDE);
00070     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Created Vec (out) "</span>&lt;&lt;std::endl;
00071     <span class="keywordflow">if</span>(npes &gt; 1) {
00072       VecSetType(out,VECMPI);
00073       std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Type: MPI "</span>&lt;&lt;std::endl;
00074     }<span class="keywordflow">else</span> {
00075       VecSetType(out,VECSEQ);
00076       std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Type: SEQ "</span>&lt;&lt;std::endl;
00077     }
00078 
00079     <span class="keywordtype">int</span> *outSizes = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00080     par::Mpi_Allgather&lt;int&gt;(&amp;outSz, outSizes, 1, MPI_COMM_WORLD);       
00081 
00082     <span class="keywordtype">int</span> *outDisps = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00083     outDisps[0] = 0;
00084     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; npes; i++) {
00085       outDisps[i] = outDisps[i-1] + outSizes[i-1];
00086     }
00087 
00088     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> totalInSz;
00089     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> totalOutSz;
00090 
00091     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> inSzCopy = inSz;
00092     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> outSzCopy = outSz;
00093 
00094     par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;inSzCopy, &amp;totalInSz, 1, MPI_SUM,0, MPI_COMM_WORLD);   
00095     par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;outSzCopy, &amp;totalOutSz, 1, MPI_SUM,0, MPI_COMM_WORLD);
00096 
00097     <span class="keywordflow">if</span>(!rank) {
00098       assert(totalInSz == totalOutSz);
00099       std::cout&lt;&lt;<span class="stringliteral">"Global sizes of in and out match."</span>&lt;&lt;std::endl;
00100     }
00101 
00102 
00103     PetscScalar * inArr;
00104     VecZeroEntries(in);
00105     VecGetArray(in,&amp;inArr);
00106 
00107     srand( time(NULL) );
00108     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; inSz; i++) {
00109       inArr[i] = ((double)(rank+1))*(((double)rand())/((double)RAND_MAX));
00110     }
00111 
00112     PetscScalar *fullInArr = NULL;      
00113     <span class="keywordflow">if</span>(!rank) {
00114       fullInArr = <span class="keyword">new</span> PetscScalar[totalInSz];           
00115     }
00116 
00117     MPI_Gatherv(inArr,inSz,<a class="code" href="classpar_1_1Mpi__datatype.html">par::Mpi_datatype&lt;PetscScalar&gt;</a>::value(),
00118         fullInArr,inSizes,inDisps,
00119         <a class="code" href="classpar_1_1Mpi__datatype.html">par::Mpi_datatype&lt;PetscScalar&gt;</a>::value(),0,MPI_COMM_WORLD);
00120 
00121     VecRestoreArray(in,&amp;inArr);
00122     <span class="keyword">delete</span> [] inSizes;  
00123     <span class="keyword">delete</span> [] inDisps;  
00124 
00125     <span class="keywordtype">int</span> *sendSz = NULL;
00126     <span class="keywordtype">int</span> *sendOff = NULL;
00127     <span class="keywordtype">int</span> *recvSz = NULL;
00128     <span class="keywordtype">int</span> *recvOff = NULL;
00129 
00130     <a class="code" href="namespaceot.html#a112">ot::scatterValues</a>(in, out, inSz, outSz, sendSz, sendOff, recvSz, recvOff, MPI_COMM_WORLD);
00131 
00132     PetscInt tmpSzIn, tmpSzOut;
00133     VecGetLocalSize(in, &amp;tmpSzIn);
00134     VecGetLocalSize(out, &amp;tmpSzOut);
00135 
00136     assert(tmpSzIn == inSz);
00137     assert(tmpSzOut == outSz);
00138 
00139     MPI_Barrier(MPI_COMM_WORLD);
00140     <span class="keywordflow">if</span>(!rank) {
00141       std::cout&lt;&lt;<span class="stringliteral">"The local sizes are preserved."</span>&lt;&lt;std::endl;
00142     }
00143 
00144     VecDestroy(in);
00145 
00146     PetscScalar* outArr;
00147     VecGetArray(out,&amp;outArr);
00148 
00149     PetscScalar* fullOutArr = NULL;
00150     <span class="keywordflow">if</span>(!rank) {
00151       fullOutArr = <span class="keyword">new</span> PetscScalar[totalOutSz];
00152     }
00153 
00154     MPI_Gatherv(outArr, outSz, <a class="code" href="classpar_1_1Mpi__datatype.html">par::Mpi_datatype&lt;PetscScalar&gt;</a>::value(),
00155         fullOutArr, outSizes, outDisps, <a class="code" href="classpar_1_1Mpi__datatype.html">par::Mpi_datatype&lt;PetscScalar&gt;</a>::value(),
00156         0,MPI_COMM_WORLD);
00157 
00158     <span class="keyword">delete</span> [] outSizes;
00159     <span class="keyword">delete</span> [] outDisps;         
00160     VecRestoreArray(out,&amp;outArr);
00161     VecDestroy(out);
00162 
00163     <span class="keywordflow">if</span>(!rank) {
00164       <span class="keywordflow">for</span>(<a class="code" href="dendro_8h.html#a0">DendroIntL</a> i = 0; i &lt; totalInSz; i++) {
00165         assert(fullInArr[i] == fullOutArr[i]);
00166       }
00167       <span class="keyword">delete</span> [] fullInArr;      
00168       <span class="keyword">delete</span> [] fullOutArr;
00169       std::cout&lt;&lt;<span class="stringliteral">"Passed Vec Version."</span>&lt;&lt;std::endl;
00170     }
00171   }<span class="comment">//end PETSc version</span>
00172 
00173   MPI_Barrier(MPI_COMM_WORLD);
00174 
00175   <span class="comment">//STL version...</span>
00176   {
00177     <span class="comment">//Ensure that total size of the vectors are the same.</span>
00178     srand( time(NULL) );
00179     <span class="keywordtype">int</span> inSz = (rank+1)*( rand() % atoi(argv[1]) );
00180 
00181     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" inSz: "</span>&lt;&lt;inSz&lt;&lt;std::endl;
00182 
00183     std::vector&lt;int&gt; in(inSz);
00184     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Created std::vec (in) "</span>&lt;&lt;std::endl;
00185 
00186     <span class="keywordtype">int</span> offRank;
00187 
00188     <span class="keywordflow">if</span>(!rank) {
00189       srand( time(NULL) );
00190       offRank = ( rand() % npes );
00191     }
00192 
00193     par::Mpi_Bcast&lt;int&gt;(&amp;offRank,1,0,MPI_COMM_WORLD);
00194 
00195     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" offRank: "</span>&lt;&lt;offRank&lt;&lt;std::endl;
00196 
00197     <span class="keywordtype">int</span> *inSizes = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00198     par::Mpi_Allgather&lt;int&gt;(&amp;inSz, inSizes, 1, MPI_COMM_WORLD);         
00199 
00200     <span class="keywordtype">int</span> *inDisps = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00201     inDisps[0] = 0;
00202     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; npes; i++) {
00203       inDisps[i] = inDisps[i-1] + inSizes[i-1];
00204     }
00205 
00206     <span class="comment">//CYCLIC SHIFT.</span>
00207     <span class="keywordtype">int</span> outSz = inSizes[(rank + offRank)%npes];
00208 
00209     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" outSz: "</span>&lt;&lt;outSz&lt;&lt;std::endl;
00210 
00211     std::vector&lt;int&gt; out(outSz);
00212     std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">" Created std::vec (out) "</span>&lt;&lt;std::endl;
00213 
00214     <span class="keywordtype">int</span> *outSizes = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00215     par::Mpi_Allgather&lt;int&gt;(&amp;outSz, outSizes, 1, MPI_COMM_WORLD);       
00216 
00217     <span class="keywordtype">int</span> *outDisps = <span class="keyword">new</span> <span class="keywordtype">int</span>[npes];
00218     outDisps[0] = 0;
00219     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; npes; i++) {
00220       outDisps[i] = outDisps[i-1] + outSizes[i-1];
00221     }
00222 
00223     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> totalInSz;
00224     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> totalOutSz;
00225 
00226     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> inSzCopy = inSz;
00227     <a class="code" href="dendro_8h.html#a0">DendroIntL</a> outSzCopy = outSz;
00228 
00229     par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;inSzCopy, &amp;totalInSz, 1, MPI_SUM,0, MPI_COMM_WORLD);   
00230     par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;outSzCopy, &amp;totalOutSz, 1, MPI_SUM,0, MPI_COMM_WORLD);
00231 
00232     <span class="keywordflow">if</span>(!rank) {
00233       assert(totalInSz == totalOutSz);
00234       std::cout&lt;&lt;<span class="stringliteral">"Global sizes of in and out match."</span>&lt;&lt;std::endl;
00235     }
00236 
00237     srand( time(NULL) );
00238     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; inSz; i++) {
00239       in[i] = rand()*(rank+1);
00240     }
00241 
00242     <span class="keywordtype">int</span> *fullInArr = NULL;      
00243     <span class="keywordflow">if</span>(!rank) {
00244       fullInArr = <span class="keyword">new</span> <span class="keywordtype">int</span>[totalInSz];           
00245     }
00246 
00247     MPI_Gatherv(&amp;(*in.begin()),inSz,MPI_INT,fullInArr,inSizes,inDisps,MPI_INT,0,MPI_COMM_WORLD);
00248 
00249     <span class="keyword">delete</span> [] inSizes;  
00250     <span class="keyword">delete</span> [] inDisps;  
00251 
00252     par::scatterValues&lt;int&gt;(in, out, outSz, MPI_COMM_WORLD);
00253 
00254     <span class="keywordtype">int</span> tmpSzIn = in.size();
00255     <span class="keywordtype">int</span> tmpSzOut = out.size();
00256 
00257     assert(tmpSzIn == inSz);
00258     assert(tmpSzOut == outSz);
00259 
00260     MPI_Barrier(MPI_COMM_WORLD);
00261     <span class="keywordflow">if</span>(!rank) {
00262       std::cout&lt;&lt;<span class="stringliteral">"The local sizes are preserved."</span>&lt;&lt;std::endl;
00263     }
00264 
00265     in.clear();
00266 
00267     <span class="keywordtype">int</span> *fullOutArr = NULL;
00268     <span class="keywordflow">if</span>(!rank) {
00269       fullOutArr = <span class="keyword">new</span> <span class="keywordtype">int</span>[totalOutSz];
00270     }
00271 
00272     MPI_Gatherv(&amp;(*out.begin()),outSz,MPI_INT,fullOutArr,outSizes,outDisps,MPI_INT,0,MPI_COMM_WORLD);
00273 
00274     <span class="keyword">delete</span> [] outSizes;
00275     <span class="keyword">delete</span> [] outDisps;         
00276 
00277     out.clear();
00278 
00279     <span class="keywordflow">if</span>(!rank) {
00280       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; totalInSz; i++) {
00281         assert(fullInArr[i] == fullOutArr[i]);
00282       }
00283       <span class="keyword">delete</span> [] fullInArr;      
00284       <span class="keyword">delete</span> [] fullOutArr;
00285       std::cout&lt;&lt;<span class="stringliteral">"Passed STL Version."</span>&lt;&lt;std::endl;
00286     }
00287   }<span class="comment">//end STL version</span>
00288 
00289   MPI_Barrier(MPI_COMM_WORLD);
00290 
00291   PetscFinalize();
00292 
00293 }<span class="comment">//end main</span>
00294 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:34 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
