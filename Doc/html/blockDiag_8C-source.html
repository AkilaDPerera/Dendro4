<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/src/pc/blockDiag.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000013.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000020.html">pc</a></div>
<h1>blockDiag.C</h1><a href="blockDiag_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00007 <span class="preprocessor">#include "petscmat.h"</span>
00008 <span class="preprocessor">#include "petscpc.h"</span>
00009 <span class="preprocessor">#include "<a class="code" href="blockDiag_8h.html">blockDiag.h</a>"</span>
00010 <span class="preprocessor">#include &lt;cassert&gt;</span>
00011 
00012 <span class="keyword">namespace </span>ot {
00013 
00014   <span class="keyword">extern</span> void (*getDofAndNodeSizeForPC_BlockDiag)(Mat pcMat,
00015       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp; dof, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp; nodeSize);
00016 
00017   <span class="keyword">extern</span> void (*computeInvBlockDiagEntriesForPC_BlockDiag)(Mat pcMat,
00018       <span class="keywordtype">double</span> **invBlockDiagEntries);
00019 
00020 
<a name="l00021"></a><a class="code" href="namespaceot.html#a129">00021</a>   PetscErrorCode <a class="code" href="namespaceot.html#a129">PCSetUp_BlockDiag</a>(PC pc) {
00022 
00023     PetscFunctionBegin;
00024     <a class="code" href="structot_1_1PC__BlockDiag.html">PC_BlockDiag</a>* data = static_cast&lt;PC_BlockDiag*&gt;(pc-&gt;data);
00025 
00026     Mat pcMat = pc-&gt;pmat;
00027     PetscTruth isshell;
00028     PetscTypeCompare((PetscObject)pcMat, MATSHELL, &amp;isshell);
00029 
00030     <span class="keywordflow">if</span>(!isshell) {
00031       SETERRQ(PETSC_ERR_SUP,<span class="stringliteral">" Expected a MATSHELL."</span>);
00032       assert(<span class="keyword">false</span>);
00033     }
00034 
00035     <span class="keywordflow">if</span>(pc-&gt;setupcalled == 0) {
00036       <span class="keywordflow">if</span>(getDofAndNodeSizeForPC_BlockDiag) {
00037         (*getDofAndNodeSizeForPC_BlockDiag)(pcMat, data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>, data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>);
00038       } <span class="keywordflow">else</span> {
00039         SETERRQ(PETSC_ERR_USER,<span class="stringliteral">" Expected function to be set: getDofAndNodeSizeForPC_BlockDiag"</span>);
00040         assert(<span class="keyword">false</span>);
00041       }
00042 
00043       <span class="comment">//Allocate memory</span>
00044       assert(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a> == NULL);
00045       <span class="keywordflow">if</span>((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>) &amp;&amp; (data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>)) {
00046         <span class="keyword">typedef</span> <span class="keywordtype">double</span>* doublePtr;
00047         data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a> = <span class="keyword">new</span> doublePtr[(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>)];
00048         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; ((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>)); i++) {
00049           data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>[i] = <span class="keyword">new</span> <span class="keywordtype">double</span>[data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>];
00050         }
00051         PetscLogObjectMemory(pc, (((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>))*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00052       }
00053 
00054       <span class="keywordflow">if</span>(computeInvBlockDiagEntriesForPC_BlockDiag) {
00055         (*computeInvBlockDiagEntriesForPC_BlockDiag)(pcMat, data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>);
00056       } <span class="keywordflow">else</span> {
00057         SETERRQ(PETSC_ERR_USER,
00058             <span class="stringliteral">" Expected function to be set: computeInvBlockDiagEntriesForPC_BlockDiag"</span>);
00059         assert(<span class="keyword">false</span>);
00060       }
00061     }
00062     PetscFunctionReturn(0);
00063   }
00064 
<a name="l00065"></a><a class="code" href="namespaceot.html#a130">00065</a>   PetscErrorCode <a class="code" href="namespaceot.html#a130">PCApply_BlockDiag</a>(PC pc, Vec x, Vec y) {
00066 
00067     PetscFunctionBegin;
00068     <a class="code" href="structot_1_1PC__BlockDiag.html">PC_BlockDiag</a>* data = static_cast&lt;PC_BlockDiag*&gt;(pc-&gt;data);
00069 
00070     <span class="keywordflow">if</span>(!(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>)) {
00071       <a class="code" href="namespaceot.html#a129">PCSetUp_BlockDiag</a>(pc);
00072     }
00073 
00074     <span class="comment">//y = invBlockDiagEntries*x</span>
00075     VecZeroEntries(y);
00076     PetscScalar *yArr = NULL;
00077     PetscScalar *xArr = NULL;
00078     VecGetArray(y, &amp;yArr);
00079     VecGetArray(x, &amp;xArr);
00080     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>; i++) {
00081       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0; j &lt; data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>; j++) {
00082         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 0; k &lt; data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>; k++) {
00083           yArr[((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*i) + j] += 
00084             ((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>[((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*i) + j][k])*
00085              xArr[((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*i) + k]);
00086         }
00087       }
00088     }
00089     VecRestoreArray(y, &amp;yArr);
00090     VecRestoreArray(x, &amp;xArr);
00091 
00092     PetscFunctionReturn(0);
00093   }
00094 
<a name="l00095"></a><a class="code" href="namespaceot.html#a131">00095</a>   PetscErrorCode <a class="code" href="namespaceot.html#a131">PCCreate_BlockDiag</a>(PC pc) {
00096 
00097     PetscFunctionBegin;
00098     <a class="code" href="structot_1_1PC__BlockDiag.html">PC_BlockDiag</a>* data = <span class="keyword">new</span> <a class="code" href="structot_1_1PC__BlockDiag.html">PC_BlockDiag</a>;
00099 
00100     pc-&gt;data = (<span class="keywordtype">void</span>*)(data);
00101 
00102     PetscLogObjectMemory(pc, <span class="keyword">sizeof</span>(<a class="code" href="structot_1_1PC__BlockDiag.html">PC_BlockDiag</a>));
00103 
00104     <span class="comment">//Initialize Data</span>
00105     data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a> = 0;
00106     data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a> = 0;
00107     data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a> = NULL;
00108 
00109     pc-&gt;ops-&gt;apply = PCApply_BlockDiag;
00110     pc-&gt;ops-&gt;setup = PCSetUp_BlockDiag;
00111     pc-&gt;ops-&gt;destroy = PCDestroy_BlockDiag;
00112     pc-&gt;ops-&gt;setfromoptions = PCSetFromOptions_BlockDiag;
00113     pc-&gt;ops-&gt;applytranspose = NULL;
00114     pc-&gt;ops-&gt;view = NULL;
00115     pc-&gt;ops-&gt;applyrichardson = NULL;
00116     pc-&gt;ops-&gt;applysymmetricleft = NULL;
00117     pc-&gt;ops-&gt;applysymmetricright = NULL;
00118 
00119     PetscFunctionReturn(0);
00120   }
00121 
<a name="l00122"></a><a class="code" href="namespaceot.html#a132">00122</a>   PetscErrorCode <a class="code" href="namespaceot.html#a132">PCDestroy_BlockDiag</a>(PC pc) {
00123 
00124     PetscFunctionBegin;
00125     <a class="code" href="structot_1_1PC__BlockDiag.html">PC_BlockDiag</a>* data = static_cast&lt;PC_BlockDiag*&gt;(pc-&gt;data);
00126 
00127     <span class="keywordflow">if</span>(data) {
00128 
00129       <span class="keywordflow">if</span>(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>) {
00130         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; ((data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o0">dof</a>)*(data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o2">nodeSize</a>)); i++) {
00131           <span class="keyword">delete</span> [] (data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>[i]);
00132           data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>[i] = NULL;
00133         }
00134         <span class="keyword">delete</span> [] (data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a>);
00135         data-&gt;<a class="code" href="structot_1_1PC__BlockDiag.html#o1">invBlockDiagEntries</a> = NULL;
00136       }
00137 
00138       <span class="keyword">delete</span> data;
00139       data = NULL;
00140 
00141     }
00142 
00143     PetscFunctionReturn(0);
00144   }
00145 
<a name="l00146"></a><a class="code" href="namespaceot.html#a133">00146</a>   PetscErrorCode <a class="code" href="namespaceot.html#a133">PCSetFromOptions_BlockDiag</a>(PC pc) {
00147     PetscFunctionBegin;
00148     PetscFunctionReturn(0);
00149   }
00150 
00151 } <span class="comment">//end namespace </span>
00152 
00153 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:33 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
