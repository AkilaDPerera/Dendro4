<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/omgNeumann_ex2.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>omgNeumann_ex2.C</h1><a href="omgNeumann__ex2_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00002 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="Point_8h.html">Point.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="octUtils_8h.html">octUtils.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="handleStencils_8h.html">handleStencils.h</a>"</span>
00010 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00011 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00013 <span class="preprocessor">#include &lt;sstream&gt;</span>
00014 <span class="preprocessor">#include "<a class="code" href="omgNeumann_8h.html">omgNeumann.h</a>"</span>
00015 
00016 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00017 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00020 <span class="preprocessor"></span>
00021 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00022 <span class="preprocessor"></span>
00023 <span class="keywordtype">int</span> Jac2DiagEvent;
00024 <span class="keywordtype">int</span> Jac2MultEvent;
00025 <span class="keywordtype">int</span> Jac2FinestDiagEvent;
00026 <span class="keywordtype">int</span> Jac2FinestMultEvent;
00027 
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="omgNeumann__ex2_8C.html#a0">00030</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a> = 1;  <span class="comment">// frequency for test purposes</span>
00031 
00032 
<a name="l00033"></a><a class="code" href="omgNeumann__ex2_8C.html#a1">00033</a> <span class="keywordtype">void</span> <a class="code" href="omgNeumann__ex3_8C.html#a1">CalcVarCoef</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; pts, std::vector&lt;double&gt; &amp; coef)
00034 {
00035   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0,j=0; i&lt;pts.size(); i+=3,j+=2)
00036   {
00037     coef[j] = 2.0;
00038     coef[j+1] = 2*( pts[i]*pts[i] + pts[i+1]*pts[i+1] + pts[i+2]*pts[i+2] );
00039   }
00040 }
00041 
<a name="l00042"></a><a class="code" href="omgNeumann__ex2_8C.html#a2">00042</a> <span class="keywordtype">void</span> <a class="code" href="omgNeumann__ex3_8C.html#a2">CalcVarRHS</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; pts, std::vector&lt;double&gt; &amp; rhs)
00043 {
00044   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0,j=0; i&lt;pts.size(); i+=3,j++)
00045    rhs[j] = 2*(pts[i]*pts[i] + pts[i+1]*pts[i+1] + pts[i+2]*pts[i+2]<span class="comment">/*mass_factor*/</span> + 3*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*M_PI) * cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i])* cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+1])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+2]); 
00046 }
00047 
<a name="l00048"></a><a class="code" href="omgNeumann__ex2_8C.html#a3">00048</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv )
00049 {
00050   PetscInitialize(&amp;argc,&amp;argv,<span class="stringliteral">"options"</span>,<span class="stringliteral">"DENDRO example\n"</span>);
00051   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00052 
00053   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00054 
00055   <span class="keywordtype">int</span> size, rank;
00056   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00057   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00058 
00059   <span class="keywordflow">if</span> (argc&lt;2) 
00060   {
00061     std::cout&lt;&lt;<span class="stringliteral">"Usage: mpirun -np &lt;numProcs&gt; "</span>&lt;&lt;argv[0]&lt;&lt;<span class="stringliteral">" &lt;filePrefix&gt;"</span>&lt;&lt;std::endl;
00062     <span class="keywordflow">return</span>(-1);
00063   }
00064 
00065   std::ostringstream fName;
00066   fName&lt;&lt;argv[1]&lt;&lt;rank&lt;&lt;<span class="stringliteral">"_"</span>&lt;&lt;size&lt;&lt;<span class="stringliteral">".pts"</span>;
00067 
00068   std::vector&lt;double&gt; pts;
00069   <a class="code" href="namespaceot.html#a48">ot::readPtsFromFile</a>(const_cast&lt;char*&gt;(fName.str().c_str()), pts);
00070   
00071   Vec sol;
00072   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> * damg;
00073   
00074   <span class="comment">// This function pointer will be called while setting up the solver on the coarsest grid if not all processes are active on the coarse grid </span>
00075   ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac2;
00076 
00077   <a class="code" href="omgNeumann_8h.html#a0">solve_neumann</a>(
00078     <span class="comment">/* input parameters: */</span>
00079      pts,
00080      <a class="code" href="omgNeumann__2spheres_8C.html#a7">CalcVarCoef</a>,
00081      <a class="code" href="omgNeumann__2spheres_8C.html#a8">CalcVarRHS</a>,
00082      30, <span class="comment">/* upper bound */</span>
00083 
00084      <span class="comment">/* output parameters */</span>
00085      sol,
00086      damg
00087     );
00088  
00089   <span class="comment">// compare solution with the exact one</span>
00090   <span class="keywordtype">unsigned</span> numMultigridLevels = damg[0]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o17">totalLevels</a>;
00091   <a class="code" href="classot_1_1DA.html">ot::DA</a>* da=damg[numMultigridLevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>;
00092   PetscScalar *solArray;
00093   da-&gt;<a class="code" href="classot_1_1DA.html#z35_11">vecGetBuffer</a>(sol,solArray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,1);
00094   <span class="keywordtype">double</span> maxDiff = 0;
00095   <span class="keywordtype">unsigned</span> maxDepth=da-&gt;<a class="code" href="classot_1_1DA.html#z31_16">getMaxDepth</a>()-1;
00096 
00097   <span class="keywordflow">if</span>(da-&gt;<a class="code" href="classot_1_1DA.html#a5">iAmActive</a>())
00098   { 
00099     <span class="comment">// first loop over those octants which do not contain ghost nodes.</span>
00100     <span class="keywordflow">for</span>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::INDEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>() &lt; da-&gt;<a class="code" href="classot_1_1DA.html#z36_2">end</a>&lt;ot::DA_FLAGS::INDEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_13">next</a>&lt;ot::DA_FLAGS::INDEPENDENT&gt;())  
00101     {
00102       <a class="code" href="classPoint.html">Point</a> pt = da-&gt;<a class="code" href="classot_1_1DA.html#z31_3">getCurrentOffset</a>();
00103       <span class="keywordtype">unsigned</span> levelhere = da-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>()) - 1;
00104       <span class="keywordtype">double</span> hxOct = ldexp(1.0,-levelhere);
00105       <span class="keywordtype">double</span> x = ldexp(pt.<a class="code" href="classPoint.html#z52_0">x</a>(),-maxDepth );
00106       <span class="keywordtype">double</span> y = ldexp(pt.<a class="code" href="classPoint.html#z52_2">y</a>(),-maxDepth );
00107       <span class="keywordtype">double</span> z = ldexp(pt.<a class="code" href="classPoint.html#z52_4">z</a>(),-maxDepth );
00108 
00109       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
00110       da-&gt;<a class="code" href="classot_1_1DA.html#z36_7">getNodeIndices</a>(indices); 
00111 
00112       <span class="keywordtype">double</span> coord[8][3] = {
00113         {0.0,0.0,0.0},
00114         {1.0,0.0,0.0},
00115         {0.0,1.0,0.0},
00116         {1.0,1.0,0.0},
00117         {0.0,0.0,1.0},
00118         {1.0,0.0,1.0},
00119         {0.0,1.0,1.0},
00120         {1.0,1.0,1.0}
00121       };
00122 
00123       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hn = da-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>());
00124 
00125       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 8; i++)
00126         <span class="keywordflow">if</span> (!(hn &amp; (1 &lt;&lt; i)))
00127         {
00128           <span class="keywordtype">double</span> xhere, yhere, zhere;
00129           xhere = x + coord[i][0]*hxOct; 
00130           yhere = y + coord[i][1]*hxOct; 
00131           zhere = z + coord[i][2]*hxOct; 
00132 
00133           <span class="keywordtype">double</span> currDiff = fabs ( solArray[indices[i]] - cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*xhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*yhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*zhere) );      
00134           <span class="keywordflow">if</span> (maxDiff &lt; currDiff)
00135             maxDiff=currDiff;
00136         }
00137     }  
00138     
00139     <span class="comment">// now loop over those octants which DO contain ghost nodes; now we need to  check if the node is ghost, and skip it if it is</span>
00140     size_t myFirstNode = da-&gt;<a class="code" href="classot_1_1DA.html#z31_9">getIdxElementBegin</a>();
00141     size_t postFirstNode = da-&gt;<a class="code" href="classot_1_1DA.html#z31_11">getIdxPostGhostBegin</a>();
00142     <span class="keywordflow">for</span>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::DEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>() &lt; da-&gt;<a class="code" href="classot_1_1DA.html#z36_2">end</a>&lt;ot::DA_FLAGS::DEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_13">next</a>&lt;ot::DA_FLAGS::DEPENDENT&gt;())  
00143     {
00144       <a class="code" href="classPoint.html">Point</a> pt = da-&gt;<a class="code" href="classot_1_1DA.html#z31_3">getCurrentOffset</a>();
00145       <span class="keywordtype">unsigned</span> levelhere = da-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>()) - 1;
00146       <span class="keywordtype">double</span> hxOct = ldexp(1.0,-levelhere);
00147       <span class="keywordtype">double</span> x = ldexp(pt.<a class="code" href="classPoint.html#z52_0">x</a>(),-maxDepth );
00148       <span class="keywordtype">double</span> y = ldexp(pt.<a class="code" href="classPoint.html#z52_2">y</a>(),-maxDepth );
00149       <span class="keywordtype">double</span> z = ldexp(pt.<a class="code" href="classPoint.html#z52_4">z</a>(),-maxDepth );
00150 
00151       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
00152       da-&gt;<a class="code" href="classot_1_1DA.html#z36_7">getNodeIndices</a>(indices); 
00153 
00154       <span class="keywordtype">double</span> coord[8][3] = {
00155         {0.0,0.0,0.0},
00156         {1.0,0.0,0.0},
00157         {0.0,1.0,0.0},
00158         {1.0,1.0,0.0},
00159         {0.0,0.0,1.0},
00160         {1.0,0.0,1.0},
00161         {0.0,1.0,1.0},
00162         {1.0,1.0,1.0}
00163       };
00164 
00165       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hn = da-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>());
00166 
00167       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 8; i++)
00168         <span class="keywordflow">if</span> ( indices[i]&gt;=myFirstNode &amp;&amp; indices[i]&lt;postFirstNode &amp;&amp; !(hn &amp; (1 &lt;&lt; i)) )
00169         {
00170           <span class="keywordtype">double</span> xhere, yhere, zhere;
00171           xhere = x + coord[i][0]*hxOct; 
00172           yhere = y + coord[i][1]*hxOct; 
00173           zhere = z + coord[i][2]*hxOct; 
00174 
00175           <span class="keywordtype">double</span> currDiff = fabs ( solArray[indices[i]] - cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*xhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*yhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*zhere) );      
00176           <span class="keywordflow">if</span> (maxDiff &lt; currDiff)
00177              maxDiff=currDiff;
00178         }
00179     }  
00180   }
00181   da-&gt;<a class="code" href="classot_1_1DA.html#z35_13">vecRestoreBuffer</a>(sol,solArray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,1); 
00182 
00183   <span class="keywordflow">if</span> (!rank)
00184   {
00185     <span class="keywordtype">double</span> gMaxDiff;
00186     par::Mpi_Reduce&lt;double&gt;(&amp;maxDiff, &amp;gMaxDiff, 1, MPI_MAX, 0, MPI_COMM_WORLD);  
00187     std::cout&lt;&lt;<span class="stringliteral">"Maximum difference: "</span>&lt;&lt;gMaxDiff&lt;&lt;std::endl;
00188   }
00189   <span class="keywordflow">else</span> {
00190     par::Mpi_Reduce&lt;double&gt;(&amp;maxDiff, &amp;maxDiff, 1, MPI_MAX, 0, MPI_COMM_WORLD);  
00191   }
00192     
00193   <span class="keywordtype">double</span> solmax,solmin;
00194   VecMax(sol,NULL,&amp;solmax);
00195   VecMin(sol,NULL,&amp;solmin);
00196 
00197   <span class="keywordflow">if</span> (!rank)
00198     std::cout&lt;&lt;<span class="stringliteral">"solution min: "</span> &lt;&lt; solmin &lt;&lt; <span class="stringliteral">"; solution max: "</span> &lt;&lt; solmax &lt;&lt; std::endl;
00199 
00200   <span class="comment">// destroy multigrid context; this destroys the solution as well </span>
00201   <a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg);
00202   
00203   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00204   PetscFinalize();
00205   <span class="keywordflow">return</span> 0;
00206 }
00207 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:25 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
