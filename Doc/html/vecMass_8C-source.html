<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/vecMass.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>vecMass.C</h1><a href="vecMass_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00007 <span class="preprocessor">#include "petsc.h"</span>
00008 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="vecMass_8h.html">vecMass.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="elasticityJac_8h.html">elasticityJac.h</a>"</span>
00012 
00013 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00014 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span> vecMassDiagEvent;
00015 <span class="keyword">extern</span> <span class="keywordtype">int</span> vecMassMultEvent;
00016 <span class="keyword">extern</span> <span class="keywordtype">int</span> vecMassFinestDiagEvent;
00017 <span class="keyword">extern</span> <span class="keywordtype">int</span> vecMassFinestMultEvent;
00018 <span class="preprocessor">#endif</span>
00019 <span class="preprocessor"></span>
00020 <span class="keyword">extern</span> <span class="keywordtype">double</span>**** MassType2Stencil; 
00021 
<a name="l00022"></a><a class="code" href="vecMass_8h.html#a0">00022</a> PetscErrorCode <a class="code" href="vecMass_8h.html#a0">CreateConstVecMass</a>(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg, Mat *jac) {
00023   PetscFunctionBegin;
00024   PetscInt buildFullCoarseMat;
00025   <span class="keywordtype">int</span> totalLevels;
00026   PetscTruth flg;
00027   PetscOptionsGetInt(PETSC_NULL,<span class="stringliteral">"-buildFullCoarseMat"</span>,&amp;buildFullCoarseMat,&amp;flg);
00028   totalLevels = damg-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o10">nlevels</a>;
00029   <a class="code" href="classot_1_1DA.html">ot::DA</a>* da = damg-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>;
00030   <span class="keywordflow">if</span>((totalLevels == damg-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o10">nlevels</a>) &amp;&amp; buildFullCoarseMat) {
00031     <span class="comment">//This is the coarsest.</span>
00032     <span class="keywordtype">int</span> myRank;
00033     MPI_Comm_rank(MPI_COMM_WORLD,&amp;myRank);
00034     <span class="keywordflow">if</span>(!myRank) {
00035       std::cout&lt;&lt;<span class="stringliteral">"Building Full vecMass Mat."</span>&lt;&lt;std::endl;
00036     }
00037     <span class="keywordflow">if</span>(!(da-&gt;<a class="code" href="classot_1_1DA.html#z35_0">computedLocalToGlobal</a>())) {
00038       da-&gt;<a class="code" href="classot_1_1DA.html#z35_3">computeLocalToGlobalMappings</a>();
00039     }
00040     <span class="keywordtype">char</span> matType[30];
00041     PetscTruth typeFound;
00042     PetscOptionsGetString(PETSC_NULL,<span class="stringliteral">"-fullJacMatType"</span>,matType,30,&amp;typeFound);
00043     <span class="keywordflow">if</span>(!typeFound) {
00044       std::cout&lt;&lt;<span class="stringliteral">"I need a MatType for the full matrix!"</span>&lt;&lt;std::endl;
00045       assert(<span class="keyword">false</span>);
00046     } 
00047     da-&gt;<a class="code" href="classot_1_1DA.html#z35_6">createMatrix</a>(*jac, matType, 3);
00048     <span class="keywordflow">if</span>(!myRank) {
00049       std::cout&lt;&lt;<span class="stringliteral">"Finished Building Full vecMass Mat."</span>&lt;&lt;std::endl;
00050     }
00051   }<span class="keywordflow">else</span> {  
00052     <span class="comment">//The size this processor owns ( without ghosts).</span>
00053     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  m,n;
00054     m=n=(3*(da-&gt;<a class="code" href="classot_1_1DA.html#z31_18">getNodeSize</a>()));
00055     MatCreateShell(damg-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o2">comm</a>, m ,n, PETSC_DETERMINE, PETSC_DETERMINE, damg, jac);
00056     MatShellSetOperation(*jac ,MATOP_MULT, (<span class="keywordtype">void</span> (*)(<span class="keywordtype">void</span>)) <a class="code" href="vecMass_8C.html#a9">ConstVecMassMatMult</a>);
00057     MatShellSetOperation(*jac ,MATOP_GET_DIAGONAL, (<span class="keywordtype">void</span> (*)(<span class="keywordtype">void</span>)) <a class="code" href="vecMass_8C.html#a8">ConstVecMassMatGetDiagonal</a>);
00058     MatShellSetOperation(*jac ,MATOP_DESTROY, (<span class="keywordtype">void</span> (*)(<span class="keywordtype">void</span>)) <a class="code" href="vecMass_8C.html#a7">ConstVecMassMatDestroy</a>);
00059   }
00060   PetscFunctionReturn(0);
00061 }<span class="comment">//end fn.</span>
00062 
<a name="l00063"></a><a class="code" href="vecMass_8h.html#a4">00063</a> PetscErrorCode <a class="code" href="vecMass_8h.html#a4">ConstVecMassMatDestroy</a>(Mat J) {
00064   PetscFunctionBegin;
00065   <span class="comment">//Nothing to be done here. No new pointers were created during creation. </span>
00066   PetscFunctionReturn(0);
00067 }
00068 
<a name="l00069"></a><a class="code" href="vecMass_8C.html#a0">00069</a> <span class="preprocessor">#define VEC_MASS_ELEM_DIAG_BLOCK {\</span>
00070 <span class="preprocessor">  unsigned int idx = da-&gt;curr();\</span>
00071 <span class="preprocessor">  unsigned int lev = da-&gt;getLevel(idx);\</span>
00072 <span class="preprocessor">  double h = hFac*(1u &lt;&lt; (maxD - lev));\</span>
00073 <span class="preprocessor">  double fac = h*h*h/8.0;\</span>
00074 <span class="preprocessor">  unsigned int indices[8];\</span>
00075 <span class="preprocessor">  da-&gt;getNodeIndices(indices);\</span>
00076 <span class="preprocessor">  unsigned char childNum = da-&gt;getChildNumber();\</span>
00077 <span class="preprocessor">  unsigned char hnMask = da-&gt;getHangingNodeIndex(idx);\</span>
00078 <span class="preprocessor">  unsigned char elemType = 0;\</span>
00079 <span class="preprocessor">  GET_ETYPE_BLOCK(elemType,hnMask,childNum)\</span>
00080 <span class="preprocessor">  for(int k = 0; k &lt; 8; k++) {\</span>
00081 <span class="preprocessor">    if(bdyArr[indices[k]]) {\</span>
00082 <span class="preprocessor">      </span><span class="comment">/*Dirichlet Node*/</span>\
00083       for(int dof = 0; dof &lt; 3; dof++) {\
00084         diagArr[(3*indices[k])+dof] = 1.0;\
00085       } <span class="comment">/*end dof*/</span>\
00086     } else { \
00087       for(int dof = 0; dof &lt; 3; dof++) {\
00088         diagArr[(3*indices[k])+dof] += (fac*(MassType2Stencil[childNum][elemType][k][k]));\
00089       } <span class="comment">/*end dof*/</span>\
00090     }\
00091   } <span class="comment">/*end k*/</span>\
00092 }
00093 
<a name="l00094"></a><a class="code" href="vecMass_8C.html#a1">00094</a> <span class="preprocessor">#define VEC_MASS_DIAG_BLOCK {\</span>
00095 <span class="preprocessor">  ot::DA* da = damg-&gt;da;\</span>
00096 <span class="preprocessor">  iC(VecZeroEntries(diag));\</span>
00097 <span class="preprocessor">  PetscScalar *diagArr;\</span>
00098 <span class="preprocessor">  unsigned char* bdyArr = data-&gt;bdyArr;\</span>
00099 <span class="preprocessor">  </span><span class="comment">/*Nodal,Non-Ghosted,Write,3 dof*/</span>\
00100   da-&gt;vecGetBuffer(diag, diagArr, false, false, false, 3);\
00101   unsigned int maxD;\
00102   double hFac;\
00103   if(da-&gt;iAmActive()) {\
00104     maxD = (da-&gt;getMaxDepth());\
00105     hFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));\
00106     <span class="comment">/*Loop through All Elements including ghosted*/</span>\
00107     for(da-&gt;init&lt;ot::DA_FLAGS::ALL&gt;(); da-&gt;curr() &lt; da-&gt;end&lt;ot::DA_FLAGS::ALL&gt;(); da-&gt;next&lt;ot::DA_FLAGS::ALL&gt;()) {\
00108       VEC_MASS_ELEM_DIAG_BLOCK\
00109     } <span class="comment">/*end i*/</span>\
00110   } <span class="comment">/*end if active*/</span>\
00111   da-&gt;vecRestoreBuffer(diag, diagArr, false, false, false, 3);\
00112   <span class="comment">/*2 IOP = 1 FLOP. Loop counters are included too.*/</span>\
00113   PetscLogFlops(93*(da-&gt;getGhostedElementSize()));\
00114 }
00115 
<a name="l00116"></a><a class="code" href="vecMass_8h.html#a3">00116</a> PetscErrorCode <a class="code" href="vecMass_8h.html#a3">ConstVecMassMatGetDiagonal</a>(Mat J, Vec diag) {
00117   PetscFunctionBegin;
00118 
00119   PetscLogEventBegin(vecMassDiagEvent,diag,0,0,0);
00120 
00121   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg;
00122   <a class="code" href="omg_8C.html#a0">iC</a>(MatShellGetContext(J, (<span class="keywordtype">void</span>**)(&amp;damg)));
00123 
00124   <a class="code" href="structElasticityData.html">ElasticityData</a>* data = (static_cast&lt;ElasticityData*&gt;(damg-&gt;user));
00125 
00126   <span class="keywordtype">bool</span> isFinestLevel = (damg-&gt;nlevels == 1);
00127 
00128   <span class="keywordflow">if</span>(isFinestLevel) {
00129     PetscLogEventBegin(vecMassFinestDiagEvent,diag,0,0,0);
00130   }
00131 
00132   <a class="code" href="vecMass_8C.html#a1">VEC_MASS_DIAG_BLOCK</a> 
00133 
00134     <span class="keywordflow">if</span>(isFinestLevel) {
00135       PetscLogEventEnd(vecMassFinestDiagEvent,diag,0,0,0);
00136     }
00137 
00138   PetscLogEventEnd(vecMassDiagEvent,diag,0,0,0);
00139 
00140   PetscFunctionReturn(0);
00141 }
00142 
<a name="l00143"></a><a class="code" href="vecMass_8C.html#a2">00143</a> <span class="preprocessor">#define VEC_MASS_ELEM_MULT_BLOCK {\</span>
00144 <span class="preprocessor">  unsigned int idx = da-&gt;curr();\</span>
00145 <span class="preprocessor">  unsigned int lev = da-&gt;getLevel(idx);\</span>
00146 <span class="preprocessor">  double h = hFac*(1u &lt;&lt; (maxD - lev));\</span>
00147 <span class="preprocessor">  double fac = h*h*h/8.0;\</span>
00148 <span class="preprocessor">  unsigned int indices[8];\</span>
00149 <span class="preprocessor">  da-&gt;getNodeIndices(indices);\</span>
00150 <span class="preprocessor">  unsigned char childNum = da-&gt;getChildNumber();\</span>
00151 <span class="preprocessor">  unsigned char hnMask = da-&gt;getHangingNodeIndex(idx);\</span>
00152 <span class="preprocessor">  unsigned char elemType = 0;\</span>
00153 <span class="preprocessor">  GET_ETYPE_BLOCK(elemType, hnMask, childNum)\</span>
00154 <span class="preprocessor">  for(int k = 0;k &lt; 8;k++) {\</span>
00155 <span class="preprocessor">    if(bdyArr[indices[k]]) {\</span>
00156 <span class="preprocessor">      </span><span class="comment">/*Dirichlet Node Row*/</span>\
00157       for(int dof = 0; dof &lt; 3; dof++) {\
00158         outArr[(3*indices[k]) + dof] =  inArr[(3*indices[k]) + dof];\
00159       }<span class="comment">/*end for dof*/</span>\
00160     } else {\
00161       for(int j=0;j&lt;8;j++) {\
00162         <span class="comment">/*Avoid Dirichlet Node Columns*/</span>\
00163         if(!(bdyArr[indices[j]])) {\
00164           for(int dof = 0; dof &lt; 3; dof++) {\
00165             outArr[(3*indices[k]) + dof] += (fac*(MassType2Stencil[childNum][elemType][k][j])\
00166                 *inArr[(3*indices[j]) + dof]);\
00167           }<span class="comment">/*end for dof*/</span>\
00168         }\
00169       }<span class="comment">/*end for j*/</span>\
00170     }\
00171   }<span class="comment">/*end for k*/</span>\
00172 }
00173 
<a name="l00174"></a><a class="code" href="vecMass_8C.html#a3">00174</a> <span class="preprocessor">#define VEC_MASS_MULT_BLOCK {\</span>
00175 <span class="preprocessor">  ot::DA* da = damg-&gt;da;\</span>
00176 <span class="preprocessor">  iC(VecZeroEntries(out));\</span>
00177 <span class="preprocessor">  unsigned int maxD;\</span>
00178 <span class="preprocessor">  double hFac;\</span>
00179 <span class="preprocessor">  if(da-&gt;iAmActive()) {\</span>
00180 <span class="preprocessor">    maxD = da-&gt;getMaxDepth();\</span>
00181 <span class="preprocessor">    hFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));\</span>
00182 <span class="preprocessor">  }\</span>
00183 <span class="preprocessor">  PetscScalar *outArr=NULL;\</span>
00184 <span class="preprocessor">  PetscScalar *inArr=NULL;\</span>
00185 <span class="preprocessor">  unsigned char* bdyArr = data-&gt;bdyArr;\</span>
00186 <span class="preprocessor">  </span><span class="comment">/*Nodal,Non-Ghosted,Read,3 dof*/</span>\
00187   da-&gt;vecGetBuffer(in, inArr, false, false, true, 3);\
00188   if(da-&gt;iAmActive()) {\
00189     da-&gt;ReadFromGhostsBegin&lt;PetscScalar&gt;(inArr, 3);\
00190   }\
00191   <span class="comment">/*Nodal,Non-Ghosted,Write,3 dof*/</span>\
00192   da-&gt;vecGetBuffer(out, outArr, false, false, false, 3);\
00193   <span class="comment">/*Loop through All Independent Elements*/</span>\
00194   if(da-&gt;iAmActive()) {\
00195     for(da-&gt;init&lt;ot::DA_FLAGS::INDEPENDENT&gt;();\
00196         da-&gt;curr() &lt; da-&gt;end&lt;ot::DA_FLAGS::INDEPENDENT&gt;(); da-&gt;next&lt;ot::DA_FLAGS::INDEPENDENT&gt;() ) {\
00197       VEC_MASS_ELEM_MULT_BLOCK\
00198     } <span class="comment">/*end independent*/</span>\
00199   } <span class="comment">/*end if active*/</span>\
00200   if(da-&gt;iAmActive()) {\
00201     da-&gt;ReadFromGhostsEnd&lt;PetscScalar&gt;(inArr);\
00202   }\
00203   <span class="comment">/*Loop through All Dependent Elements,*/</span>\
00204   <span class="comment">/*i.e. Elements which have atleast one*/</span>\
00205   <span class="comment">/*vertex owned by this processor and at least one*/</span>\
00206   <span class="comment">/*vertex not owned by this processor.*/</span>\
00207   if(da-&gt;iAmActive()) {\
00208     for(da-&gt;init&lt;ot::DA_FLAGS::DEPENDENT&gt;();\
00209         da-&gt;curr() &lt; da-&gt;end&lt;ot::DA_FLAGS::DEPENDENT&gt;();  da-&gt;next&lt;ot::DA_FLAGS::DEPENDENT&gt;() ) {\
00210       VEC_MASS_ELEM_MULT_BLOCK\
00211     } <span class="comment">/*end loop for dependent elems*/</span>\
00212   } <span class="comment">/*end if active*/</span>\
00213   da-&gt;vecRestoreBuffer(in, inArr, false, false, true, 3);\
00214   da-&gt;vecRestoreBuffer(out, outArr, false, false, false, 3);\
00215   <span class="comment">/*2 IOP = 1 FLOP. Loop counters are included too.*/</span>\
00216   PetscLogFlops(1095*(da-&gt;getGhostedElementSize()));\
00217 }
00218 
<a name="l00219"></a><a class="code" href="vecMass_8h.html#a2">00219</a> PetscErrorCode <a class="code" href="vecMass_8h.html#a2">ConstVecMassMatMult</a>(Mat J, Vec in, Vec out)
00220 {
00221   PetscFunctionBegin;
00222 
00223   PetscLogEventBegin(vecMassMultEvent,in,out,0,0);
00224 
00225   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg;
00226   <a class="code" href="omg_8C.html#a0">iC</a>(MatShellGetContext(J, (<span class="keywordtype">void</span>**)(&amp;damg)));
00227 
00228   <a class="code" href="structElasticityData.html">ElasticityData</a>* data = (static_cast&lt;ElasticityData*&gt;(damg-&gt;user));
00229 
00230   <span class="keywordtype">bool</span> isFinestLevel = (damg-&gt;nlevels == 1);
00231 
00232   <span class="keywordflow">if</span>(isFinestLevel) {
00233     PetscLogEventBegin(vecMassFinestMultEvent,in,out,0,0);
00234   }
00235 
00236   <a class="code" href="vecMass_8C.html#a3">VEC_MASS_MULT_BLOCK</a> 
00237 
00238     <span class="keywordflow">if</span>(isFinestLevel) {
00239       PetscLogEventEnd(vecMassFinestMultEvent,in,out,0,0);
00240     }
00241 
00242   PetscLogEventEnd(vecMassMultEvent,in,out,0,0);
00243 
00244   PetscFunctionReturn(0);
00245 }
00246 
<a name="l00247"></a><a class="code" href="vecMass_8C.html#a4">00247</a> <span class="preprocessor">#define BUILD_FULL_VEC_MASS_BLOCK {\</span>
00248 <span class="preprocessor">  ot::DA* da = damg-&gt;da;\</span>
00249 <span class="preprocessor">  MatZeroEntries(B);\</span>
00250 <span class="preprocessor">  std::vector&lt;ot::MatRecord&gt; records;\</span>
00251 <span class="preprocessor">  unsigned int maxD;\</span>
00252 <span class="preprocessor">  double hFac;\</span>
00253 <span class="preprocessor">  if(da-&gt;iAmActive()) {\</span>
00254 <span class="preprocessor">    maxD = da-&gt;getMaxDepth();\</span>
00255 <span class="preprocessor">    hFac = 1.0/((double)(1u &lt;&lt; (maxD-1)));\</span>
00256 <span class="preprocessor">  }\</span>
00257 <span class="preprocessor">  unsigned char* bdyArr = data-&gt;bdyArr;\</span>
00258 <span class="preprocessor">  if(da-&gt;iAmActive()) {\</span>
00259 <span class="preprocessor">    for(da-&gt;init&lt;ot::DA_FLAGS::WRITABLE&gt;();\</span>
00260 <span class="preprocessor">        da-&gt;curr() &lt; da-&gt;end&lt;ot::DA_FLAGS::WRITABLE&gt;();  da-&gt;next&lt;ot::DA_FLAGS::WRITABLE&gt;()) {\</span>
00261 <span class="preprocessor">      unsigned int idx = da-&gt;curr();\</span>
00262 <span class="preprocessor">      unsigned int lev = da-&gt;getLevel(idx);\</span>
00263 <span class="preprocessor">      double h = hFac*(1u &lt;&lt; (maxD - lev));\</span>
00264 <span class="preprocessor">      double fac = h/2.0;\</span>
00265 <span class="preprocessor">      unsigned int indices[8];\</span>
00266 <span class="preprocessor">      da-&gt;getNodeIndices(indices);\</span>
00267 <span class="preprocessor">      unsigned char childNum = da-&gt;getChildNumber();\</span>
00268 <span class="preprocessor">      unsigned char hnMask = da-&gt;getHangingNodeIndex(idx);\</span>
00269 <span class="preprocessor">      unsigned char elemType = 0;\</span>
00270 <span class="preprocessor">      GET_ETYPE_BLOCK(elemType, hnMask, childNum)\</span>
00271 <span class="preprocessor">      for(int k = 0;k &lt; 8;k++) {\</span>
00272 <span class="preprocessor">        </span><span class="comment">/*Avoid Dirichlet Node Rows during ADD_VALUES loop.*/</span>\
00273         <span class="comment">/*Need a separate INSERT_VALUES loop for those*/</span>\
00274         if(!(bdyArr[indices[k]])) {\
00275           for(int j=0;j&lt;8;j++) {\
00276             if(!(bdyArr[indices[j]])) {\
00277               for(int dof = 0; dof &lt; 3; dof++) {\
00278                 ot::MatRecord currRec;\
00279                 currRec.rowIdx = indices[k];\
00280                 currRec.colIdx = indices[j];\
00281                 currRec.rowDim = dof;\
00282                 currRec.colDim = dof;\
00283                 currRec.val = (fac*(MassType2Stencil[childNum][elemType][k][j]));\
00284                 records.push_back(currRec);\
00285               } <span class="comment">/*end for dof*/</span>\
00286             }\
00287           } <span class="comment">/*end for j*/</span>\
00288         }\
00289       } <span class="comment">/*end for k*/</span>\
00290       if(records.size() &gt; 1000) {\
00291         <span class="comment">/*records will be cleared inside the function*/</span>\
00292         da-&gt;setValuesInMatrix(B, records, 3, ADD_VALUES);\
00293       }\
00294     } <span class="comment">/*end writable*/</span>\
00295   } <span class="comment">/*end if active*/</span>\
00296   da-&gt;setValuesInMatrix(B, records, 3, ADD_VALUES);\
00297   MatAssemblyBegin(B, MAT_FLUSH_ASSEMBLY);\
00298   MatAssemblyEnd(B, MAT_FLUSH_ASSEMBLY);\
00299   if(da-&gt;iAmActive()) {\
00300     for(da-&gt;init&lt;ot::DA_FLAGS::WRITABLE&gt;();\
00301         da-&gt;curr() &lt; da-&gt;end&lt;ot::DA_FLAGS::WRITABLE&gt;();  da-&gt;next&lt;ot::DA_FLAGS::WRITABLE&gt;()) {\
00302       unsigned int idx = da-&gt;curr();\
00303       unsigned int lev = da-&gt;getLevel(idx);\
00304       double h = hFac*(1u &lt;&lt; (maxD - lev));\
00305       double fac = h/2.0;\
00306       unsigned int indices[8];\
00307       da-&gt;getNodeIndices(indices);\
00308       unsigned char childNum = da-&gt;getChildNumber();\
00309       unsigned char hnMask = da-&gt;getHangingNodeIndex(idx);\
00310       unsigned char elemType = 0;\
00311       GET_ETYPE_BLOCK(elemType, hnMask, childNum)\
00312       for(int k = 0; k &lt; 8; k++) {\
00313         <span class="comment">/*Insert values for Dirichlet Node Rows only.*/</span>\
00314         if(bdyArr[indices[k]]) {\
00315           for(int dof = 0; dof &lt; 3; dof++) {\
00316             ot::MatRecord currRec;\
00317             currRec.rowIdx = indices[k];\
00318             currRec.colIdx = indices[k];\
00319             currRec.rowDim = dof;\
00320             currRec.colDim = dof;\
00321             currRec.val = 1.0;\
00322             records.push_back(currRec);\
00323           } <span class="comment">/*end for dof*/</span>\
00324         }\
00325       } <span class="comment">/*end for k*/</span>\
00326       if(records.size() &gt; 1000) {\
00327         <span class="comment">/*records will be cleared inside the function*/</span>\
00328         da-&gt;setValuesInMatrix(B, records, 3, INSERT_VALUES);\
00329       }\
00330     } <span class="comment">/*end writable*/</span>\
00331   } <span class="comment">/*end if active*/</span>\
00332   da-&gt;setValuesInMatrix(B, records, 3, INSERT_VALUES);\
00333   MatAssemblyBegin(B, MAT_FINAL_ASSEMBLY);\
00334   MatAssemblyEnd(B, MAT_FINAL_ASSEMBLY);\
00335 }
00336 
<a name="l00337"></a><a class="code" href="vecMass_8h.html#a1">00337</a> PetscErrorCode <a class="code" href="vecMass_8h.html#a1">ComputeConstVecMass</a>(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg, Mat J, Mat B) {
00338   <span class="comment">//For matShells nothing to be done here.</span>
00339   PetscFunctionBegin;
00340 
00341   PetscTruth isshell;
00342   PetscTypeCompare((PetscObject)B, MATSHELL, &amp;isshell);
00343   <span class="keywordflow">if</span>(isshell) {
00344     PetscFunctionReturn(0);
00345   }
00346 
00347   <a class="code" href="structElasticityData.html">ElasticityData</a>* data = (static_cast&lt;ElasticityData*&gt;(damg-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o18">user</a>));
00348 
00349   <span class="comment">//Assuming that B and J are the same.</span>
00350 
00351   <a class="code" href="vecMass_8C.html#a4">BUILD_FULL_VEC_MASS_BLOCK</a> 
00352 
00353     PetscFunctionReturn(0);
00354 }
00355 
00356 <span class="preprocessor">#undef BUILD_FULL_VEC_MASS_BLOCK </span>
00357 <span class="preprocessor"></span><span class="preprocessor">#undef VEC_MASS_MULT_BLOCK </span>
00358 <span class="preprocessor"></span><span class="preprocessor">#undef VEC_MASS_DIAG_BLOCK </span>
00359 <span class="preprocessor"></span><span class="preprocessor">#undef VEC_MASS_ELEM_DIAG_BLOCK </span>
00360 <span class="preprocessor"></span><span class="preprocessor">#undef VEC_MASS_ELEM_MULT_BLOCK </span>
00361 <span class="preprocessor"></span>
00362 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:27 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
