<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/testConBalAndCoarsen.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>testConBalAndCoarsen.C</h1><a href="testConBalAndCoarsen_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include "mpi.h"</span>
00003 <span class="preprocessor">#include "petsc.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="octUtils_8h.html">octUtils.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
00010 
00011 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00014 <span class="preprocessor"></span>
00015 <span class="keywordtype">double</span> <a class="code" href="testElasMatVec_8C.html#a8">gaussian</a>(<span class="keywordtype">double</span> mean, <span class="keywordtype">double</span> std_deviation);
00016 
<a name="l00017"></a><a class="code" href="testConBalAndCoarsen_8C.html#a1">00017</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00018   <span class="keywordtype">int</span> size, rank;
00019   <span class="keywordtype">double</span> startTime, endTime;
00020   <span class="keywordtype">double</span> localTime, globalTime;
00021   <span class="keywordtype">double</span> gSize[3];
00022   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> local_num_pts = 5000;
00023   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim = 3;
00024   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth = 30;
00025   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxNumPts = 1;
00026   <span class="keywordtype">bool</span> incCorner = 1;  
00027   std::vector&lt;ot::TreeNode&gt; linOct;
00028   std::vector&lt;ot::TreeNode&gt; balOct;
00029   std::vector&lt;ot::TreeNode&gt; coarseOct;
00030   std::vector&lt;ot::TreeNode&gt; tmpNodes;
00031   std::vector&lt;double&gt; pts;
00032   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ptsLen;
00033   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> localSz, totalSz;
00034 
00035   PetscInitialize(&amp;argc, &amp;argv, <span class="stringliteral">"options"</span>, NULL);
00036   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00037 
00038 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00039 <span class="preprocessor"></span>  <span class="keywordtype">int</span> stages[4];
00040   PetscLogStageRegister(&amp;stages[0], <span class="stringliteral">"Main"</span>);
00041   PetscLogStageRegister(&amp;stages[1], <span class="stringliteral">"P2O"</span>);
00042   PetscLogStageRegister(&amp;stages[2], <span class="stringliteral">"Bal"</span>);
00043   PetscLogStageRegister(&amp;stages[3], <span class="stringliteral">"Coarsen"</span>);
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00047 <span class="preprocessor"></span>  PetscLogStagePush(stages[0]);
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
00050   MPI_Comm_size(MPI_COMM_WORLD, &amp;size);
00051   MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);
00052 
00053   <span class="keywordflow">if</span>(argc &gt; 1) {
00054     local_num_pts = atoi(argv[1]);
00055   }
00056 
00057   <span class="keywordflow">if</span>(argc &gt; 2) {
00058     dim = atoi(argv[2]);
00059   }
00060 
00061   <span class="keywordflow">if</span>(argc &gt; 3) {
00062     maxDepth = atoi(argv[3]);
00063   }
00064 
00065   <span class="keywordflow">if</span>(argc &gt; 4) {
00066     maxNumPts = atoi(argv[4]);
00067   }
00068 
00069   <span class="keywordflow">if</span>(argc &gt; 5) {
00070     incCorner = (bool)(atoi(argv[5]));
00071   }
00072 
00073   MPI_Barrier(MPI_COMM_WORLD);
00074   <span class="keywordflow">if</span>(!rank){
00075     std::cout &lt;&lt; <span class="stringliteral">"Creating points on the fly... "</span>&lt;&lt;std::endl;
00076   }
00077 
00078   startTime = MPI_Wtime();
00079 
00080   srand48(0x12345678 + 76543*rank);
00081 
00082   pts.resize(3*local_num_pts);
00083   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;3*local_num_pts; i++) {
00084     pts[i]= <a class="code" href="testElasMatVec_8C.html#a8">gaussian</a>(0.5, 0.16);
00085   }
00086 
00087   MPI_Barrier(MPI_COMM_WORLD);
00088   <span class="keywordflow">if</span>(!rank){
00089     std::cout &lt;&lt; <span class="stringliteral">" finished creating points  "</span>&lt;&lt;std::endl; <span class="comment">// Point size</span>
00090   }
00091   endTime = MPI_Wtime();
00092   localTime = endTime - startTime;
00093   <span class="keywordflow">if</span>(!rank){
00094     std::cout &lt;&lt;<span class="stringliteral">"point generation time: "</span>&lt;&lt;localTime &lt;&lt; std::endl;
00095   }
00096 
00097   ptsLen = pts.size();
00098   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; ptsLen; i+=3) {
00099     <span class="keywordflow">if</span>( (pts[i] &gt; 0.0) &amp;&amp;
00100         (pts[i+1] &gt; 0.0)
00101         &amp;&amp; (pts[i+2] &gt; 0.0) &amp;&amp;
00102         ( ((<span class="keywordtype">unsigned</span> int)(pts[i]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00103         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+1]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00104         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+2]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth)) ) {
00105       tmpNodes.push_back( <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00106             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+1]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00107             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+2]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00108             maxDepth,dim,maxDepth) );
00109     }
00110   }
00111   pts.clear();
00112 
00113   par::removeDuplicates&lt;ot::TreeNode&gt;(tmpNodes,<span class="keyword">false</span>,MPI_COMM_WORLD);
00114   linOct = tmpNodes;
00115   tmpNodes.clear();
00116   par::partitionW&lt;ot::TreeNode&gt;(linOct, NULL,MPI_COMM_WORLD);
00117   <span class="comment">// reduce and only print the total ...</span>
00118   localSz = linOct.size();
00119   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00120   <span class="keywordflow">if</span>(rank==0) {
00121     std::cout&lt;&lt;<span class="stringliteral">"# pts= "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00122   }
00123 
00124   pts.resize(3*(linOct.size()));
00125   ptsLen = (3*(linOct.size()));
00126   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; linOct.size(); i++) {
00127     pts[3*i] = (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00128     pts[(3*i)+1] = (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00129     pts[(3*i)+2] = (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00130   }<span class="comment">//end for i</span>
00131   linOct.clear();
00132 
00133   gSize[0] = 1.0;
00134   gSize[1] = 1.0;
00135   gSize[2] = 1.0;
00136 
00137 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00138 <span class="preprocessor"></span>  PetscLogStagePop();
00139 <span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span>
00141   MPI_Barrier(MPI_COMM_WORLD);  
00142 
00143 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00144 <span class="preprocessor"></span>  PetscLogStagePush(stages[1]);
00145 <span class="preprocessor">#endif</span>
00146 <span class="preprocessor"></span>  startTime = MPI_Wtime();
00147   <a class="code" href="namespaceot.html#a35">ot::points2Octree</a>(pts, gSize, linOct, dim, maxDepth, maxNumPts, MPI_COMM_WORLD);
00148   endTime = MPI_Wtime();
00149   localTime = endTime - startTime;
00150 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00151 <span class="preprocessor"></span>  PetscLogStagePop();
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>  par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;globalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00154   <span class="keywordflow">if</span>(!rank){
00155     std::cout &lt;&lt;<span class="stringliteral">"P2n Time: "</span>&lt;&lt;globalTime &lt;&lt; <span class="stringliteral">"secs "</span> &lt;&lt; std::endl;
00156   }
00157   pts.clear();
00158 
00159   localSz = linOct.size();
00160   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00161   <span class="keywordflow">if</span>(rank==0) {
00162     std::cout&lt;&lt;<span class="stringliteral">"linOct.size = "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00163   }
00164 
00165   MPI_Barrier(MPI_COMM_WORLD);  
00166 
00167 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00168 <span class="preprocessor"></span>  PetscLogStagePush(stages[2]);
00169 <span class="preprocessor">#endif</span>
00170 <span class="preprocessor"></span>  startTime = MPI_Wtime();
00171   <a class="code" href="namespaceot.html#a10">ot::balanceOctree</a> (linOct, balOct, dim, maxDepth, incCorner, MPI_COMM_WORLD, NULL, NULL);
00172   endTime = MPI_Wtime();
00173   localTime = endTime - startTime;
00174 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00175 <span class="preprocessor"></span>  PetscLogStagePop();
00176 <span class="preprocessor">#endif</span>
00177 <span class="preprocessor"></span>  par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;globalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00178   <span class="keywordflow">if</span>(!rank){
00179     std::cout &lt;&lt;<span class="stringliteral">"Bal Time: "</span>&lt;&lt;globalTime &lt;&lt; <span class="stringliteral">"secs "</span> &lt;&lt; std::endl;
00180   }
00181   linOct.clear();
00182 
00183   localSz = balOct.size();
00184   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00185   <span class="keywordflow">if</span>(rank==0) {
00186     std::cout&lt;&lt;<span class="stringliteral">"balOct.size = "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00187   }
00188 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00189 <span class="preprocessor"></span>  PetscLogStagePush(stages[3]);
00190 <span class="preprocessor">#endif</span>
00191 <span class="preprocessor"></span>  startTime = MPI_Wtime();
00192   <a class="code" href="namespaceot.html#a31">ot::coarsenOctree</a>(balOct, coarseOct, dim, maxDepth, MPI_COMM_WORLD, <span class="keyword">false</span>, NULL, NULL);
00193   endTime = MPI_Wtime();
00194   localTime = endTime - startTime;
00195 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00196 <span class="preprocessor"></span>  PetscLogStagePop();
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>  par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;globalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00199   <span class="keywordflow">if</span>(!rank){
00200     std::cout &lt;&lt;<span class="stringliteral">"coarse Time: "</span>&lt;&lt;globalTime &lt;&lt; <span class="stringliteral">"secs "</span> &lt;&lt; std::endl;
00201   }
00202   balOct.clear();
00203 
00204   localSz = coarseOct.size();
00205   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00206   <span class="keywordflow">if</span>(rank==0) {
00207     std::cout&lt;&lt;<span class="stringliteral">"coarseOct.size = "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00208   }
00209   coarseOct.clear();
00210 
00211   PetscFinalize();
00212 }<span class="comment">//end main</span>
00213 
00214 <span class="keywordtype">double</span> <a class="code" href="testElasMatVec_8C.html#a8">gaussian</a>(<span class="keywordtype">double</span> mean, <span class="keywordtype">double</span> std_deviation) {
00215   <span class="keyword">static</span> <span class="keywordtype">double</span> t1 = 0, t2=0;
00216   <span class="keywordtype">double</span> x1, x2, x3, r;
00217 
00218   <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00219 
00220   <span class="comment">// reuse previous calculations</span>
00221   <span class="keywordflow">if</span>(t1) {
00222     <span class="keyword">const</span> <span class="keywordtype">double</span> tmp = t1;
00223     t1 = 0;
00224     <span class="keywordflow">return</span> mean + std_deviation * tmp;
00225   }
00226   <span class="keywordflow">if</span>(t2) {
00227     <span class="keyword">const</span> <span class="keywordtype">double</span> tmp = t2;
00228     t2 = 0;
00229     <span class="keywordflow">return</span> mean + std_deviation * tmp;
00230   }
00231 
00232   <span class="comment">// pick randomly a point inside the unit disk</span>
00233   <span class="keywordflow">do</span> {
00234     x1 = 2 * drand48() - 1;
00235     x2 = 2 * drand48() - 1;
00236     x3 = 2 * drand48() - 1;
00237     r = x1 * x1 + x2 * x2 + x3*x3;
00238   } <span class="keywordflow">while</span>(r &gt;= 1);
00239 
00240   <span class="comment">// Box-Muller transform</span>
00241   r = sqrt(-2.0 * log(r) / r);
00242 
00243   <span class="comment">// save for next call</span>
00244   t1 = (r * x2);
00245   t2 = (r * x3);
00246 
00247   <span class="keywordflow">return</span> mean + (std_deviation * r * x1);
00248 }<span class="comment">//end gaussian</span>
00249 
00250 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:26 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
