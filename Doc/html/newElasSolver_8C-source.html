<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/newElasSolver.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>newElasSolver.C</h1><a href="newElasSolver_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00007 <span class="preprocessor">#include "mpi.h"</span>
00008 <span class="preprocessor">#include "petsc.h"</span>
00009 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00010 <span class="preprocessor">#include &lt;vector&gt;</span>
00011 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="handleStencils_8h.html">handleStencils.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="elasticityJac_8h.html">elasticityJac.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="omgJac_8h.html">omgJac.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="colors_8h.html">colors.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="dendro_8h.html">dendro.h</a>"</span>
00020 
<a name="l00021"></a><a class="code" href="newElasSolver_8C.html#a1">00021</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="newElasSolver_8C.html#a1">help</a>[] = <span class="stringliteral">"Solves static Navier-Lame equations\</span>
00022 <span class="stringliteral">                      using FEM, MG, DA and Matrix-Free methods.\n\n"</span>;
00023 
00024 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00025 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#ifndef iC</span>
<a name="l00030"></a><a class="code" href="newElasSolver_8C.html#a0">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define iC(fun) {CHKERRQ(fun);}</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00034 <span class="preprocessor"></span><span class="keywordtype">int</span> elasticityDiagEvent;
00035 <span class="keywordtype">int</span> elasticityMultEvent;
00036 <span class="keywordtype">int</span> elasticityFinestDiagEvent;
00037 <span class="keywordtype">int</span> elasticityFinestMultEvent;
00038 
00039 <span class="keywordtype">int</span> vecMassDiagEvent;
00040 <span class="keywordtype">int</span> vecMassMultEvent;
00041 <span class="keywordtype">int</span> vecMassFinestDiagEvent;
00042 <span class="keywordtype">int</span> vecMassFinestMultEvent;
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00046 <span class="preprocessor"></span><span class="comment">//user-defined variables</span>
00047 <span class="keywordtype">int</span> Jac1DiagEvent;
00048 <span class="keywordtype">int</span> Jac1MultEvent;
00049 <span class="keywordtype">int</span> Jac1FinestDiagEvent;
00050 <span class="keywordtype">int</span> Jac1FinestMultEvent;
00051 
00052 <span class="keywordtype">int</span> Jac2DiagEvent;
00053 <span class="keywordtype">int</span> Jac2MultEvent;
00054 <span class="keywordtype">int</span> Jac2FinestDiagEvent;
00055 <span class="keywordtype">int</span> Jac2FinestMultEvent;
00056 
00057 <span class="keywordtype">int</span> Jac3DiagEvent;
00058 <span class="keywordtype">int</span> Jac3MultEvent;
00059 <span class="keywordtype">int</span> Jac3FinestDiagEvent;
00060 <span class="keywordtype">int</span> Jac3FinestMultEvent;
00061 <span class="preprocessor">#endif</span>
00062 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="newElasSolver_8C.html#a2">00063</a> <span class="keywordtype">double</span>***** LaplacianType1Stencil; 
<a name="l00064"></a><a class="code" href="newElasSolver_8C.html#a3">00064</a> <span class="keywordtype">double</span>**** LaplacianType2Stencil; 
<a name="l00065"></a><a class="code" href="newElasSolver_8C.html#a4">00065</a> <span class="keywordtype">double</span>***** MassType1Stencil; 
<a name="l00066"></a><a class="code" href="newElasSolver_8C.html#a5">00066</a> <span class="keywordtype">double</span>**** MassType2Stencil; 
<a name="l00067"></a><a class="code" href="newElasSolver_8C.html#a6">00067</a> <span class="keywordtype">double</span>****** ShapeFnStencil;
<a name="l00068"></a><a class="code" href="newElasSolver_8C.html#a7">00068</a> <span class="keywordtype">double</span>**** ShapeFnCoeffs;
00069 
<a name="l00070"></a><a class="code" href="newElasSolver_8C.html#a8">00070</a> <span class="keywordtype">double</span>**** GradDivType2Stencil; 
00071 
00072 <span class="keywordtype">double</span> <a class="code" href="testElasMatVec_8C.html#a8">gaussian</a>(<span class="keywordtype">double</span> mean, <span class="keywordtype">double</span> std_deviation);
00073 
<a name="l00074"></a><a class="code" href="newElasSolver_8C.html#a10">00074</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00075   <span class="keywordtype">int</span> size, rank;
00076   <span class="keywordtype">bool</span> incCorner = 1;  
00077   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> local_num_pts = 5000;
00078   <span class="keywordtype">double</span> gSize[3];
00079   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ptsLen;
00080   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxNumPts = 1;
00081   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim = 3;
00082   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth = 30;
00083   <span class="keywordtype">bool</span> compressLut = <span class="keyword">false</span>;
00084   <span class="keywordtype">double</span> localTime, globalTime;
00085   <span class="keywordtype">double</span> startTime, endTime;
00086   <a class="code" href="dendro_8h.html#a0">DendroIntL</a> localSz, totalSz;
00087   std::vector&lt;ot::TreeNode&gt; linOct, balOct;
00088   std::vector&lt;double&gt; pts;
00089   <span class="keywordtype">double</span> mgLoadFac = 2.0;
00090 
00091   PetscInitialize(&amp;argc,&amp;argv,<span class="stringliteral">"optionsElasticity"</span>,<a class="code" href="newElasSolver_8C.html#a1">help</a>);
00092   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00093 
00094   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00095 
00096 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00097 <span class="preprocessor"></span>  PetscLogEventRegister(&amp;Jac1DiagEvent,<span class="stringliteral">"ODAmatDiag"</span>,PETSC_VIEWER_COOKIE);
00098   PetscLogEventRegister(&amp;Jac1MultEvent,<span class="stringliteral">"ODAmatMult"</span>,PETSC_VIEWER_COOKIE);
00099   PetscLogEventRegister(&amp;Jac1FinestDiagEvent,<span class="stringliteral">"ODAmatDiagFinest"</span>,PETSC_VIEWER_COOKIE);
00100   PetscLogEventRegister(&amp;Jac1FinestMultEvent,<span class="stringliteral">"ODAmatMultFinest"</span>,PETSC_VIEWER_COOKIE);
00101 
00102   PetscLogEventRegister(&amp;Jac2DiagEvent,<span class="stringliteral">"OMGmatDiag-2"</span>,PETSC_VIEWER_COOKIE);
00103   PetscLogEventRegister(&amp;Jac2MultEvent,<span class="stringliteral">"OMGmatMult-2"</span>,PETSC_VIEWER_COOKIE);
00104   PetscLogEventRegister(&amp;Jac2FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-2"</span>,PETSC_VIEWER_COOKIE);
00105   PetscLogEventRegister(&amp;Jac2FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-2"</span>,PETSC_VIEWER_COOKIE);
00106 
00107   PetscLogEventRegister(&amp;Jac3DiagEvent,<span class="stringliteral">"OMGmatDiag-3"</span>,PETSC_VIEWER_COOKIE);
00108   PetscLogEventRegister(&amp;Jac3MultEvent,<span class="stringliteral">"OMGmatMult-3"</span>,PETSC_VIEWER_COOKIE);
00109   PetscLogEventRegister(&amp;Jac3FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-3"</span>,PETSC_VIEWER_COOKIE);
00110   PetscLogEventRegister(&amp;Jac3FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-3"</span>,PETSC_VIEWER_COOKIE);
00111   PetscLogEventRegister(&amp;vecMassDiagEvent,<span class="stringliteral">"vMassDiag"</span>,PETSC_VIEWER_COOKIE);
00112   PetscLogEventRegister(&amp;vecMassMultEvent,<span class="stringliteral">"vMassMult"</span>,PETSC_VIEWER_COOKIE);
00113   PetscLogEventRegister(&amp;vecMassFinestDiagEvent,<span class="stringliteral">"vMassDiagFinest"</span>,PETSC_VIEWER_COOKIE);
00114   PetscLogEventRegister(&amp;vecMassFinestMultEvent,<span class="stringliteral">"vMassMultFinest"</span>,PETSC_VIEWER_COOKIE);
00115 
00116   PetscLogEventRegister(&amp;elasticityDiagEvent,<span class="stringliteral">"elDiag"</span>,PETSC_VIEWER_COOKIE);
00117   PetscLogEventRegister(&amp;elasticityMultEvent,<span class="stringliteral">"elMult"</span>,PETSC_VIEWER_COOKIE);
00118   PetscLogEventRegister(&amp;elasticityFinestDiagEvent,<span class="stringliteral">"elDiagFinest"</span>,PETSC_VIEWER_COOKIE);
00119   PetscLogEventRegister(&amp;elasticityFinestMultEvent,<span class="stringliteral">"elMultFinest"</span>,PETSC_VIEWER_COOKIE);
00120 
00121   <span class="keywordtype">int</span> stages[3];
00122   PetscLogStageRegister(&amp;stages[0],<span class="stringliteral">"P2O."</span>);
00123   PetscLogStageRegister(&amp;stages[1],<span class="stringliteral">"Bal"</span>);  
00124   PetscLogStageRegister(&amp;stages[2],<span class="stringliteral">"Solve"</span>);  
00125 <span class="preprocessor">#endif</span>
00126 <span class="preprocessor"></span>
00127   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00128   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00129   
00130 <span class="comment">//  Usage: &lt;exe&gt; local_num_pts[5000] dim[3] maxDepth[30] maxNumPtsPerOctant[1] </span>
00131 <span class="comment">//  incCorner[1] compressLut[0] mgLoadFac[2.0]  </span>
00132  
00133   <span class="keywordflow">if</span>(argc &gt; 1) {
00134     local_num_pts = atoi(argv[1]);
00135   }  
00136   <span class="keywordflow">if</span>(argc &gt; 2) {
00137     dim = atoi(argv[2]);
00138   }
00139   <span class="keywordflow">if</span>(argc &gt; 3) {
00140     maxDepth = atoi(argv[3]);
00141   }
00142   <span class="keywordflow">if</span>(argc &gt; 4) {
00143     maxNumPts = atoi(argv[4]);
00144   }
00145   <span class="keywordflow">if</span>(argc &gt; 5) {
00146     incCorner = (bool)(atoi(argv[5]));
00147   }  
00148   <span class="keywordflow">if</span>(argc &gt; 6) { 
00149     compressLut = (bool)(atoi(argv[6]));
00150   }
00151   <span class="keywordflow">if</span>(argc &gt; 7) { 
00152     mgLoadFac = atof(argv[7]);
00153   }
00154 
00155   <span class="comment">//Generate Points</span>
00156   <span class="keywordflow">if</span>(!rank){
00157     std::cout &lt;&lt; <span class="stringliteral">"Creating points on the fly... "</span>&lt;&lt;std::endl;
00158   }
00159 
00160   MPI_Barrier(MPI_COMM_WORLD);
00161   startTime = MPI_Wtime();
00162 
00163   srand48(0x12345678 + 76543*rank);
00164 
00165   pts.resize(3*local_num_pts);
00166   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; (3*local_num_pts); i++) {
00167     pts[i]= <a class="code" href="testElasMatVec_8C.html#a8">gaussian</a>(0.5, 0.16);
00168   }
00169   MPI_Barrier(MPI_COMM_WORLD);
00170   endTime = MPI_Wtime();
00171   localTime = endTime - startTime;
00172 
00173   <span class="keywordflow">if</span>(!rank){
00174     std::cout &lt;&lt; <span class="stringliteral">" finished creating points  "</span>&lt;&lt;std::endl; <span class="comment">// Point size</span>
00175     std::cout &lt;&lt;<span class="stringliteral">"point generation time: "</span>&lt;&lt;localTime &lt;&lt; std::endl;
00176   }
00177 
00178   ptsLen = pts.size();
00179   std::vector&lt;ot::TreeNode&gt; tmpNodes;
00180   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; ptsLen; i+=3) {
00181     <span class="keywordflow">if</span>( (pts[i] &gt; 0.0) &amp;&amp;
00182         (pts[i+1] &gt; 0.0)  
00183         &amp;&amp; (pts[i+2] &gt; 0.0) &amp;&amp;
00184         ( ((<span class="keywordtype">unsigned</span> int)(pts[i]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00185         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+1]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth))  &amp;&amp;
00186         ( ((<span class="keywordtype">unsigned</span> int)(pts[i+2]*((double)(1u &lt;&lt; maxDepth)))) &lt; (1u &lt;&lt; maxDepth)) ) {
00187       tmpNodes.push_back( <a class="code" href="classot_1_1TreeNode.html">ot::TreeNode</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00188             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+1]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00189             (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pts[i+2]*(<span class="keywordtype">double</span>)(1u &lt;&lt; maxDepth)),
00190             maxDepth,dim,maxDepth) );
00191     }
00192   }
00193   pts.clear();
00194 
00195   par::removeDuplicates&lt;ot::TreeNode&gt;(tmpNodes,<span class="keyword">false</span>,MPI_COMM_WORLD);   
00196   linOct = tmpNodes;
00197   tmpNodes.clear();
00198   par::partitionW&lt;ot::TreeNode&gt;(linOct, NULL,MPI_COMM_WORLD);
00199   <span class="comment">// reduce and only print the total ...</span>
00200   localSz = linOct.size();
00201   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00202   MPI_Barrier(MPI_COMM_WORLD);  
00203   <span class="keywordflow">if</span>(rank==0) {
00204     std::cout&lt;&lt;<span class="stringliteral">"# pts= "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00205   }
00206   MPI_Barrier(MPI_COMM_WORLD);  
00207 
00208   pts.resize(3*(linOct.size()));
00209   ptsLen = (3*(linOct.size()));
00210   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; linOct.size(); i++) {
00211     pts[3*i] = (((double)(linOct[i].getX())) + 0.5)/((double)(1u &lt;&lt; maxDepth));
00212     pts[(3*i)+1] = (((double)(linOct[i].getY())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00213     pts[(3*i)+2] = (((double)(linOct[i].getZ())) +0.5)/((double)(1u &lt;&lt; maxDepth));
00214   }<span class="comment">//end for i</span>
00215   linOct.clear();
00216   gSize[0] = 1.0;
00217   gSize[1] = 1.0;
00218   gSize[2] = 1.0;
00219 
00220   <span class="comment">//Points2Octree....</span>
00221   MPI_Barrier(MPI_COMM_WORLD);  
00222 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00223 <span class="preprocessor"></span>  PetscLogStagePush(stages[0]);
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>  startTime = MPI_Wtime();
00226   <a class="code" href="namespaceot.html#a35">ot::points2Octree</a>(pts, gSize, linOct, dim, maxDepth, maxNumPts, MPI_COMM_WORLD);
00227   endTime = MPI_Wtime();
00228 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00229 <span class="preprocessor"></span>  PetscLogStagePop();
00230 <span class="preprocessor">#endif</span>
00231 <span class="preprocessor"></span>  localTime = endTime - startTime;
00232   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;globalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00233   <span class="keywordflow">if</span>(!rank){
00234     std::cout &lt;&lt;<span class="stringliteral">"P2n Time: "</span>&lt;&lt;globalTime &lt;&lt; std::endl;
00235   }
00236   <span class="comment">// reduce and only print the total ...</span>
00237   localSz = linOct.size();
00238   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00239   <span class="keywordflow">if</span>(rank==0) {
00240     std::cout&lt;&lt;<span class="stringliteral">"# of Unbalanced Octants: "</span> &lt;&lt; totalSz&lt;&lt;std::endl;
00241   }
00242   pts.clear();
00243 
00244   <span class="comment">//Balancing...</span>
00245   MPI_Barrier(MPI_COMM_WORLD);  
00246 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00247 <span class="preprocessor"></span>  PetscLogStagePush(stages[1]);
00248 <span class="preprocessor">#endif</span>
00249 <span class="preprocessor"></span>  startTime = MPI_Wtime();
00250   <a class="code" href="namespaceot.html#a10">ot::balanceOctree</a> (linOct, balOct, dim, maxDepth, incCorner, MPI_COMM_WORLD, NULL, NULL);
00251   endTime = MPI_Wtime();
00252 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00253 <span class="preprocessor"></span>  PetscLogStagePop();
00254 <span class="preprocessor">#endif</span>
00255 <span class="preprocessor"></span>  linOct.clear();
00256   <span class="comment">// compute total inp size and output size</span>
00257   localSz = balOct.size();
00258   localTime = endTime - startTime;
00259   par::Mpi_Reduce&lt;DendroIntL&gt;(&amp;localSz, &amp;totalSz, 1, MPI_SUM, 0, MPI_COMM_WORLD);
00260   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;globalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00261 
00262   <span class="keywordflow">if</span>(!rank) {
00263     std::cout &lt;&lt; <span class="stringliteral">"# of Balanced Octants: "</span>&lt;&lt; totalSz &lt;&lt; std::endl;       
00264     std::cout &lt;&lt; <span class="stringliteral">"bal Time: "</span>&lt;&lt;globalTime &lt;&lt; std::endl;
00265   }
00266 
00267   <span class="comment">//Solve ...</span>
00268   MPI_Barrier(MPI_COMM_WORLD);  
00269 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00270 <span class="preprocessor"></span>  PetscLogStagePush(stages[2]);
00271 <span class="preprocessor">#endif</span>
00272 <span class="preprocessor"></span>
00273   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a>       *damg;    
00274   <span class="keywordtype">int</span>       nlevels = 1; <span class="comment">//number of multigrid levels</span>
00275   PetscInt       numRefinements = 0;
00276   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   dof = 3; <span class="comment">// degrees of freedom per node  </span>
00277 
00278   <a class="code" href="omg_8C.html#a0">iC</a>(PetscOptionsGetInt(0,<span class="stringliteral">"-numRefinements"</span>,&amp;numRefinements,0));
00279   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; numRefinements; i++) {
00280     std::vector&lt;ot::TreeNode&gt; tmpOct = balOct;
00281     balOct.clear();
00282     <a class="code" href="namespaceot.html#a39">ot::refineOctree</a>(tmpOct, balOct); 
00283   }
00284 
00285   PetscInt nlevelsPetscInt = nlevels;
00286   PetscOptionsGetInt(0, <span class="stringliteral">"-nlevels"</span>, &amp;nlevelsPetscInt, 0);
00287   nlevels = nlevelsPetscInt;
00288 
00289   <span class="comment">// Note: The user context for all levels will be set separately later.</span>
00290   MPI_Barrier(MPI_COMM_WORLD);  
00291 
00292   <span class="keywordflow">if</span>(!rank) {
00293     std::cout&lt;&lt;<span class="stringliteral">"nlevels initial: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00294   }
00295 
00296   <a class="code" href="namespaceot.html#a103">ot::DAMGCreateAndSetDA</a>(PETSC_COMM_WORLD, nlevels, NULL, &amp;damg, 
00297       balOct, dof, mgLoadFac, compressLut, incCorner);
00298 
00299   balOct.clear();
00300 
00301   <span class="keywordflow">if</span>(!rank) {
00302     std::cout&lt;&lt;<span class="stringliteral">"nlevels final: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00303   }
00304 
00305   MPI_Barrier(MPI_COMM_WORLD);  
00306 
00307   <span class="keywordflow">if</span>(!rank) {
00308     std::cout &lt;&lt; <span class="stringliteral">"Created DA for all levels."</span>&lt;&lt; std::endl;
00309   }
00310 
00311   MPI_Barrier(MPI_COMM_WORLD);
00312   <a class="code" href="namespaceot.html#a108">ot::PrintDAMG</a>(damg);
00313   MPI_Barrier(MPI_COMM_WORLD);
00314 
00315   MPI_Barrier(MPI_COMM_WORLD);
00316   <span class="keywordflow">if</span>(!rank) {
00317     std::cout &lt;&lt; <span class="stringliteral">"Creating stencils..."</span>&lt;&lt; std::endl;
00318   }
00319   MPI_Barrier(MPI_COMM_WORLD);
00320 
00321   <a class="code" href="handleType2Stencils_8C.html#a16">createLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00322   <a class="code" href="handleType2Stencils_8C.html#a12">createMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00323   <a class="code" href="handleType2Stencils_8C.html#a8">createGDmatType2</a>(<a class="code" href="elasticityJac_8C.html#a8">GradDivType2Stencil</a>);
00324 
00325   MPI_Barrier(MPI_COMM_WORLD);
00326   <span class="keywordflow">if</span>(!rank) {
00327     std::cout &lt;&lt; <span class="stringliteral">"Created all stencils."</span>&lt;&lt; std::endl;
00328   }
00329   MPI_Barrier(MPI_COMM_WORLD);
00330 
00331   <a class="code" href="namespaceot.html#a88">ot::DAMGCreateSuppressedDOFs</a>(damg);
00332 
00333   <a class="code" href="elasticityJac_8h.html#a0">SetElasticityContexts</a>(damg);
00334 
00335   MPI_Barrier(MPI_COMM_WORLD);
00336   <span class="keywordflow">if</span>(!rank) {
00337     std::cout &lt;&lt; <span class="stringliteral">"Set Elasticity Contexts all levels."</span>&lt;&lt; std::endl;
00338   }
00339 
00340   <span class="comment">//Functions for using KSP_Shell (will be used @ the coarsest grid if not all</span>
00341 <span class="comment">//processors are active on the coarsest grid)</span>
00342 
00343   ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Elas;
00344   
00345   <span class="comment">//Set function pointers so that PC_BlockDiag could be used.</span>
00346 
00347   ot::getDofAndNodeSizeForPC_BlockDiag = getDofAndNodeSizeForElasticityMat;
00348 
00349   ot::computeInvBlockDiagEntriesForPC_BlockDiag = computeInvBlockDiagEntriesForElasticityMat;
00350 
00351   PetscInt rhsType = 2;
00352   <a class="code" href="omg_8C.html#a0">iC</a>(PetscOptionsGetInt(0,<span class="stringliteral">"-rhsType"</span>,&amp;rhsType,0));
00353 
00354   <span class="keywordflow">if</span>(rhsType == 4) {
00355     <a class="code" href="namespaceot.html#a96">ot::DAMGSetKSP</a>(damg, <a class="code" href="elasticityJac_8C.html#a17">CreateElasticityMat</a>,
00356         <a class="code" href="elasticityJac_8C.html#a13">ComputeElasticityMat</a>, <a class="code" href="omgJac_8h.html#a23">ComputeRHS4</a>);
00357   }<span class="keywordflow">else</span> {
00358     <a class="code" href="namespaceot.html#a96">ot::DAMGSetKSP</a>(damg, <a class="code" href="elasticityJac_8C.html#a17">CreateElasticityMat</a>,
00359         <a class="code" href="elasticityJac_8C.html#a13">ComputeElasticityMat</a>, <a class="code" href="elasticityJac_8h.html#a8">ComputeElasticityRHS</a>);
00360   }
00361 
00362   PetscReal norm2;
00363   PetscReal normInf;
00364 
00365   MPI_Barrier(MPI_COMM_WORLD);
00366   <span class="keywordflow">if</span>(!rank) {
00367     std::cout &lt;&lt; <span class="stringliteral">"Solving with 0-intial guess"</span>&lt;&lt; std::endl;
00368   }
00369   MPI_Barrier(MPI_COMM_WORLD);
00370 
00371   startTime = MPI_Wtime();
00372   <a class="code" href="omg_8C.html#a0">iC</a>(ot::DAMGSolve(damg));
00373   endTime = MPI_Wtime();
00374   localTime = endTime - startTime;
00375   par::Mpi_Reduce&lt;double&gt;(&amp;localTime, &amp;globalTime, 1, MPI_MAX, 0, MPI_COMM_WORLD);
00376 
00377   MPI_Barrier(MPI_COMM_WORLD);
00378 
00379   <span class="keywordflow">if</span> (!rank) {
00380     std::cout &lt;&lt;  <span class="stringliteral">"Done Solve"</span> &lt;&lt;  std::endl;
00381     std::cout &lt;&lt; <span class="stringliteral">"Solve Time: "</span>&lt;&lt;globalTime &lt;&lt; std::endl;
00382   }
00383 
00384   MPI_Barrier(MPI_COMM_WORLD);
00385 
00386   <a class="code" href="handleType2Stencils_8C.html#a26">destroyLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00387   <a class="code" href="handleType2Stencils_8C.html#a27">destroyMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00388   <a class="code" href="handleType2Stencils_8C.html#a28">destroyGDmatType2</a>(<a class="code" href="elasticityJac_8C.html#a8">GradDivType2Stencil</a>);
00389 
00390   <span class="keywordflow">if</span> (!rank) {
00391     std::cout &lt;&lt;  <span class="stringliteral">"Destroyed Stencils"</span>  &lt;&lt; std::endl;
00392   }
00393 
00394   <a class="code" href="elasticityJac_8h.html#a1">DestroyElasticityContexts</a>(damg);
00395 
00396   <span class="keywordflow">if</span> (!rank) {
00397     std::cout &lt;&lt;  <span class="stringliteral">"Destroyed Elasticity Contexts."</span>  &lt;&lt; std::endl;
00398   }
00399 
00400   MPI_Barrier(MPI_COMM_WORLD);
00401 
00402   <a class="code" href="omg_8C.html#a0">iC</a>(<a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg));
00403 
00404   <span class="keywordflow">if</span> (!rank) {
00405     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed DAMG"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00406   }
00407 
00408   endTime = MPI_Wtime();
00409 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00410 <span class="preprocessor"></span>  PetscLogStagePop();
00411 <span class="preprocessor">#endif</span>
00412 <span class="preprocessor"></span>
00413   <span class="keywordflow">if</span> (!rank) {
00414     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Finalizing PETSC"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00415   }
00416   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00417   PetscFinalize();
00418 }<span class="comment">//end main</span>
00419 
00420 <span class="keywordtype">double</span> <a class="code" href="testElasMatVec_8C.html#a8">gaussian</a>(<span class="keywordtype">double</span> mean, <span class="keywordtype">double</span> std_deviation) {
00421   <span class="keyword">static</span> <span class="keywordtype">double</span> t1 = 0, t2=0;
00422   <span class="keywordtype">double</span> x1, x2, x3, r;
00423 
00424   <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00425 
00426   <span class="comment">// reuse previous calculations</span>
00427   <span class="keywordflow">if</span>(t1) {
00428     <span class="keyword">const</span> <span class="keywordtype">double</span> tmp = t1;
00429     t1 = 0;
00430     <span class="keywordflow">return</span> mean + std_deviation * tmp;
00431   }
00432   <span class="keywordflow">if</span>(t2) {
00433     <span class="keyword">const</span> <span class="keywordtype">double</span> tmp = t2;
00434     t2 = 0;
00435     <span class="keywordflow">return</span> mean + std_deviation * tmp;
00436   }
00437 
00438   <span class="comment">// pick randomly a point inside the unit disk</span>
00439   <span class="keywordflow">do</span> {
00440     x1 = 2 * drand48() - 1;
00441     x2 = 2 * drand48() - 1;
00442     x3 = 2 * drand48() - 1;
00443     r = x1 * x1 + x2 * x2 + x3*x3;
00444   } <span class="keywordflow">while</span>(r &gt;= 1);
00445 
00446   <span class="comment">// Box-Muller transform</span>
00447   r = sqrt(-2.0 * log(r) / r);
00448 
00449   <span class="comment">// save for next call</span>
00450   t1 = (r * x2);
00451   t2 = (r * x3);
00452 
00453   <span class="keywordflow">return</span> mean + (std_deviation * r * x1);
00454 }<span class="comment">//end gaussian</span>
00455 
00456 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:24 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
