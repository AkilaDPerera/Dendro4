<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/omgNeumann_ex3.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>omgNeumann_ex3.C</h1><a href="omgNeumann__ex3_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00002 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="Point_8h.html">Point.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="parUtils_8h.html">parUtils.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="octUtils_8h.html">octUtils.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="handleStencils_8h.html">handleStencils.h</a>"</span>
00010 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00011 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00013 <span class="preprocessor">#include &lt;sstream&gt;</span>
00014 <span class="preprocessor">#include "<a class="code" href="omgNeumann_8h.html">omgNeumann.h</a>"</span>
00015 
00016 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00017 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00020 <span class="preprocessor"></span>
00021 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00022 <span class="preprocessor"></span>
00023 <span class="keywordtype">int</span> Jac2DiagEvent;
00024 <span class="keywordtype">int</span> Jac2MultEvent;
00025 <span class="keywordtype">int</span> Jac2FinestDiagEvent;
00026 <span class="keywordtype">int</span> Jac2FinestMultEvent;
00027 
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="omgNeumann__ex3_8C.html#a0">00030</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a> = 1;  <span class="comment">// frequency for test purposes</span>
00031 
00032 
<a name="l00033"></a><a class="code" href="omgNeumann__ex3_8C.html#a1">00033</a> <span class="keywordtype">void</span> <a class="code" href="omgNeumann__ex3_8C.html#a1">CalcVarCoef</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; pts, std::vector&lt;double&gt; &amp; coef)
00034 {
00035   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0,j=0; i&lt;pts.size(); i+=3,j+=2)
00036   {
00037     <span class="keywordtype">double</span> s = pts[i]*pts[i] + pts[i+1]*pts[i+1] + pts[i+2]*pts[i+2];
00038     coef[j] = s+1;
00039     coef[j+1] = s ;
00040   }
00041 }
00042 
<a name="l00043"></a><a class="code" href="omgNeumann__ex3_8C.html#a2">00043</a> <span class="keywordtype">void</span> <a class="code" href="omgNeumann__ex3_8C.html#a2">CalcVarRHS</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; pts, std::vector&lt;double&gt; &amp; rhs)
00044 {
00045   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0,j=0; i&lt;pts.size(); i+=3,j++)
00046   {
00047     <span class="keywordtype">double</span> s = pts[i]*pts[i] + pts[i+1]*pts[i+1] + pts[i+2]*pts[i+2];
00048     rhs[j] = (s<span class="comment">/*mass_factor*/</span> + (s+1)*3*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*M_PI)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+1])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+2]) + 2*pts[i]*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*sin(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+1])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+2]) + 2*pts[i+1]*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i])*sin(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+1])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+2]) + 2*pts[i+2]*<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i])*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+1])*sin(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*pts[i+2]);
00049   }
00050 }
00051 
<a name="l00052"></a><a class="code" href="omgNeumann__ex3_8C.html#a3">00052</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv )
00053 {
00054   PetscInitialize(&amp;argc,&amp;argv,<span class="stringliteral">"options"</span>,<span class="stringliteral">"DENDRO example\n"</span>);
00055   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00056 
00057   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00058 
00059   <span class="keywordtype">int</span> size, rank;
00060   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00061   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00062 
00063   <span class="keywordflow">if</span> (argc&lt;2) 
00064   {
00065     std::cout&lt;&lt;<span class="stringliteral">"Usage: mpirun -np &lt;numProcs&gt; "</span>&lt;&lt;argv[0]&lt;&lt;<span class="stringliteral">" &lt;filePrefix&gt;"</span>&lt;&lt;std::endl;
00066     <span class="keywordflow">return</span>(-1);
00067   }
00068 
00069   std::ostringstream fName;
00070   fName&lt;&lt;argv[1]&lt;&lt;rank&lt;&lt;<span class="stringliteral">"_"</span>&lt;&lt;size&lt;&lt;<span class="stringliteral">".pts"</span>;
00071 
00072   std::vector&lt;double&gt; pts;
00073   <a class="code" href="namespaceot.html#a48">ot::readPtsFromFile</a>(const_cast&lt;char*&gt;(fName.str().c_str()), pts);
00074   
00075   Vec sol;
00076   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> * damg;
00077   
00078   <span class="comment">// This function pointer will be called while setting up the solver on the coarsest grid if not all processes are active on the coarse grid </span>
00079   ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac2;
00080 
00081   <a class="code" href="omgNeumann_8h.html#a0">solve_neumann</a>(
00082     <span class="comment">/* input parameters: */</span>
00083      pts,
00084      <a class="code" href="omgNeumann__2spheres_8C.html#a7">CalcVarCoef</a>,
00085      <a class="code" href="omgNeumann__2spheres_8C.html#a8">CalcVarRHS</a>,
00086      30, <span class="comment">/* upper bound */</span>
00087 
00088      <span class="comment">/* output parameters */</span>
00089      sol,
00090      damg
00091     );
00092  
00093   <span class="comment">// compare solution with the exact one</span>
00094   <span class="keywordtype">unsigned</span> numMultigridLevels = damg[0]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o17">totalLevels</a>;
00095   <a class="code" href="classot_1_1DA.html">ot::DA</a>* da=damg[numMultigridLevels-1]-&gt;<a class="code" href="structot_1_1__p__DAMG.html#o3">da</a>;
00096   PetscScalar *solArray;
00097   da-&gt;<a class="code" href="classot_1_1DA.html#z35_11">vecGetBuffer</a>(sol,solArray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,1);
00098   <span class="keywordtype">double</span> maxDiff = 0;
00099   <span class="keywordtype">unsigned</span> maxDepth=da-&gt;<a class="code" href="classot_1_1DA.html#z31_16">getMaxDepth</a>()-1;
00100 
00101   <span class="keywordflow">if</span>(da-&gt;<a class="code" href="classot_1_1DA.html#a5">iAmActive</a>())
00102   { 
00103     <span class="comment">// first loop over those octants which do not contain ghost nodes.</span>
00104     <span class="keywordflow">for</span>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::INDEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>() &lt; da-&gt;<a class="code" href="classot_1_1DA.html#z36_2">end</a>&lt;ot::DA_FLAGS::INDEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_13">next</a>&lt;ot::DA_FLAGS::INDEPENDENT&gt;())  
00105     {
00106       <a class="code" href="classPoint.html">Point</a> pt = da-&gt;<a class="code" href="classot_1_1DA.html#z31_3">getCurrentOffset</a>();
00107       <span class="keywordtype">unsigned</span> levelhere = da-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>()) - 1;
00108       <span class="keywordtype">double</span> hxOct = ldexp(1.0,-levelhere);
00109       <span class="keywordtype">double</span> x = ldexp(pt.<a class="code" href="classPoint.html#z52_0">x</a>(),-maxDepth );
00110       <span class="keywordtype">double</span> y = ldexp(pt.<a class="code" href="classPoint.html#z52_2">y</a>(),-maxDepth );
00111       <span class="keywordtype">double</span> z = ldexp(pt.<a class="code" href="classPoint.html#z52_4">z</a>(),-maxDepth );
00112 
00113       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
00114       da-&gt;<a class="code" href="classot_1_1DA.html#z36_7">getNodeIndices</a>(indices); 
00115 
00116       <span class="keywordtype">double</span> coord[8][3] = {
00117         {0.0,0.0,0.0},
00118         {1.0,0.0,0.0},
00119         {0.0,1.0,0.0},
00120         {1.0,1.0,0.0},
00121         {0.0,0.0,1.0},
00122         {1.0,0.0,1.0},
00123         {0.0,1.0,1.0},
00124         {1.0,1.0,1.0}
00125       };
00126 
00127       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hn = da-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>());
00128 
00129       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 8; i++)
00130         <span class="keywordflow">if</span> (!(hn &amp; (1 &lt;&lt; i)))
00131         {
00132           <span class="keywordtype">double</span> xhere, yhere, zhere;
00133           xhere = x + coord[i][0]*hxOct; 
00134           yhere = y + coord[i][1]*hxOct; 
00135           zhere = z + coord[i][2]*hxOct; 
00136 
00137           <span class="keywordtype">double</span> currDiff = fabs ( solArray[indices[i]] - cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*xhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*yhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*zhere) );      
00138           <span class="keywordflow">if</span> (maxDiff &lt; currDiff)
00139             maxDiff=currDiff;
00140         }
00141     }  
00142     
00143     <span class="comment">// now loop over those octants which DO contain ghost nodes; now we need to  check if the node is ghost, and skip it if it is</span>
00144     size_t myFirstNode = da-&gt;<a class="code" href="classot_1_1DA.html#z31_9">getIdxElementBegin</a>();
00145     size_t postFirstNode = da-&gt;<a class="code" href="classot_1_1DA.html#z31_11">getIdxPostGhostBegin</a>();
00146     <span class="keywordflow">for</span>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_9">init</a>&lt;ot::DA_FLAGS::DEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>() &lt; da-&gt;<a class="code" href="classot_1_1DA.html#z36_2">end</a>&lt;ot::DA_FLAGS::DEPENDENT&gt;(); da-&gt;<a class="code" href="classot_1_1DA.html#z36_13">next</a>&lt;ot::DA_FLAGS::DEPENDENT&gt;())  
00147     {
00148       <a class="code" href="classPoint.html">Point</a> pt = da-&gt;<a class="code" href="classot_1_1DA.html#z31_3">getCurrentOffset</a>();
00149       <span class="keywordtype">unsigned</span> levelhere = da-&gt;<a class="code" href="classot_1_1DA.html#z36_6">getLevel</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>()) - 1;
00150       <span class="keywordtype">double</span> hxOct = ldexp(1.0,-levelhere);
00151       <span class="keywordtype">double</span> x = ldexp(pt.<a class="code" href="classPoint.html#z52_0">x</a>(),-maxDepth );
00152       <span class="keywordtype">double</span> y = ldexp(pt.<a class="code" href="classPoint.html#z52_2">y</a>(),-maxDepth );
00153       <span class="keywordtype">double</span> z = ldexp(pt.<a class="code" href="classPoint.html#z52_4">z</a>(),-maxDepth );
00154 
00155       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> indices[8];
00156       da-&gt;<a class="code" href="classot_1_1DA.html#z36_7">getNodeIndices</a>(indices); 
00157 
00158       <span class="keywordtype">double</span> coord[8][3] = {
00159         {0.0,0.0,0.0},
00160         {1.0,0.0,0.0},
00161         {0.0,1.0,0.0},
00162         {1.0,1.0,0.0},
00163         {0.0,0.0,1.0},
00164         {1.0,0.0,1.0},
00165         {0.0,1.0,1.0},
00166         {1.0,1.0,1.0}
00167       };
00168 
00169       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hn = da-&gt;<a class="code" href="classot_1_1DA.html#z36_5">getHangingNodeIndex</a>(da-&gt;<a class="code" href="classot_1_1DA.html#z36_0">curr</a>());
00170 
00171       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; 8; i++)
00172         <span class="keywordflow">if</span> ( indices[i]&gt;=myFirstNode &amp;&amp; indices[i]&lt;postFirstNode &amp;&amp; !(hn &amp; (1 &lt;&lt; i)) )
00173         {
00174           <span class="keywordtype">double</span> xhere, yhere, zhere;
00175           xhere = x + coord[i][0]*hxOct; 
00176           yhere = y + coord[i][1]*hxOct; 
00177           zhere = z + coord[i][2]*hxOct; 
00178 
00179           <span class="keywordtype">double</span> currDiff = fabs ( solArray[indices[i]] - cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*xhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*yhere)*cos(<a class="code" href="omgNeumann__2spheres_8C.html#a0">w</a>*M_PI*zhere) );      
00180           <span class="keywordflow">if</span> (maxDiff &lt; currDiff)
00181              maxDiff=currDiff;
00182         }
00183     }  
00184   }
00185   da-&gt;<a class="code" href="classot_1_1DA.html#z35_13">vecRestoreBuffer</a>(sol,solArray,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,1); 
00186 
00187   <span class="keywordflow">if</span> (!rank)
00188   {
00189     <span class="keywordtype">double</span> gMaxDiff;
00190     par::Mpi_Reduce&lt;double&gt;(&amp;maxDiff, &amp;gMaxDiff, 1, MPI_MAX, 0, MPI_COMM_WORLD);  
00191     std::cout&lt;&lt;<span class="stringliteral">"Maximum difference: "</span>&lt;&lt;gMaxDiff&lt;&lt;std::endl;
00192   }
00193   <span class="keywordflow">else</span> {
00194     par::Mpi_Reduce&lt;double&gt;(&amp;maxDiff, &amp;maxDiff, 1, MPI_MAX, 0, MPI_COMM_WORLD);  
00195   }
00196     
00197   <span class="keywordtype">double</span> solmax,solmin;
00198   VecMax(sol,NULL,&amp;solmax);
00199   VecMin(sol,NULL,&amp;solmin);
00200 
00201   <span class="keywordflow">if</span> (!rank)
00202     std::cout&lt;&lt;<span class="stringliteral">"solution min: "</span> &lt;&lt; solmin &lt;&lt; <span class="stringliteral">"; solution max: "</span> &lt;&lt; solmax &lt;&lt; std::endl;
00203 
00204   <span class="comment">// destroy multigrid context; this destroys the solution as well </span>
00205   <a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg);
00206   
00207   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00208   PetscFinalize();
00209   <span class="keywordflow">return</span> 0;
00210 }
00211 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:25 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
