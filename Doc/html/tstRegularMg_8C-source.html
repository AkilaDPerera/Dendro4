<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DENDRO: /net/ac190/www-db1/grads/r/rahulss/Dendro/examples/tstRegularMg.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">examples</a></div>
<h1>tstRegularMg.C</h1><a href="tstRegularMg_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 <span class="preprocessor">#include "mpi.h"</span>
00003 <span class="preprocessor">#include "petsc.h"</span>
00004 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">sys.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="TreeNode_8h.html">TreeNode.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="omg_8h.html">omg.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="oda_8h.html">oda.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="omgJac_8h.html">omgJac.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="handleStencils_8h.html">handleStencils.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="colors_8h.html">colors.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="externVars_8h.html">externVars.h</a>"</span>
00012 
<a name="l00013"></a><a class="code" href="tstRegularMg_8C.html#a0">00013</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="tstRegularMg_8C.html#a0">help</a>[] = <span class="stringliteral">"Regular Grid MG"</span>;
00014 
00015 <span class="comment">//Don't want time to be synchronized. Need to check load imbalance.</span>
00016 <span class="preprocessor">#ifdef MPI_WTIME_IS_GLOBAL</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#undef MPI_WTIME_IS_GLOBAL</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00019 <span class="preprocessor"></span>
00020 <span class="comment">//user-defined variables</span>
00021 
00022 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00023 <span class="preprocessor"></span><span class="keywordtype">int</span> Jac1MultEvent;
00024 <span class="keywordtype">int</span> Jac1DiagEvent;
00025 <span class="keywordtype">int</span> Jac1FinestMultEvent;
00026 <span class="keywordtype">int</span> Jac1FinestDiagEvent;
00027 <span class="keywordtype">int</span> matPropEvent;
00028 
00029 <span class="keywordtype">int</span> Jac2MultEvent;
00030 <span class="keywordtype">int</span> Jac2DiagEvent;
00031 <span class="keywordtype">int</span> Jac2FinestMultEvent;
00032 <span class="keywordtype">int</span> Jac2FinestDiagEvent;
00033 
00034 <span class="keywordtype">int</span> Jac3MultEvent;
00035 <span class="keywordtype">int</span> Jac3DiagEvent;
00036 <span class="keywordtype">int</span> Jac3FinestMultEvent;
00037 <span class="keywordtype">int</span> Jac3FinestDiagEvent;
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="tstRegularMg_8C.html#a1">00040</a> <span class="keywordtype">double</span>***** LaplacianType1Stencil; 
<a name="l00041"></a><a class="code" href="tstRegularMg_8C.html#a2">00041</a> <span class="keywordtype">double</span>**** LaplacianType2Stencil; 
<a name="l00042"></a><a class="code" href="tstRegularMg_8C.html#a3">00042</a> <span class="keywordtype">double</span>***** MassType1Stencil; 
<a name="l00043"></a><a class="code" href="tstRegularMg_8C.html#a4">00043</a> <span class="keywordtype">double</span>**** MassType2Stencil; 
<a name="l00044"></a><a class="code" href="tstRegularMg_8C.html#a5">00044</a> <span class="keywordtype">double</span>****** ShapeFnStencil;
<a name="l00045"></a><a class="code" href="tstRegularMg_8C.html#a6">00045</a> <span class="keywordtype">double</span>**** ShapeFnCoeffs;
00046 
<a name="l00047"></a><a class="code" href="tstRegularMg_8C.html#a7">00047</a> <span class="keywordtype">int</span> <a class="code" href="testShFn_8C.html#a8">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv ) {     
00048   <span class="keywordtype">int</span> size, rank;
00049   <span class="keywordtype">bool</span> incCorner = 1;  
00050   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim=3;
00051   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxDepth=29;
00052   <span class="keywordtype">bool</span> compressLut=<span class="keyword">true</span>;
00053   std::vector&lt;ot::TreeNode&gt; balOct;
00054   <span class="keywordtype">double</span> mgLoadFac = 2.0;
00055   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> regLev = 2;
00056 
00057   PetscInitialize(&amp;argc, &amp;argv, <span class="stringliteral">"options"</span>, <a class="code" href="tstRegularMg_8C.html#a0">help</a>);
00058   <a class="code" href="namespaceot.html#a134">ot::RegisterEvents</a>();
00059 
00060   <a class="code" href="namespaceot.html#a89">ot::DAMG_Initialize</a>(MPI_COMM_WORLD);
00061 
00062 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00063 <span class="preprocessor"></span>  PetscLogEventRegister(&amp;matPropEvent,<span class="stringliteral">"matProp"</span>,PETSC_VIEWER_COOKIE);
00064   PetscLogEventRegister(&amp;Jac1DiagEvent,<span class="stringliteral">"ODAmatDiag"</span>,PETSC_VIEWER_COOKIE);
00065   PetscLogEventRegister(&amp;Jac1MultEvent,<span class="stringliteral">"ODAmatMult"</span>,PETSC_VIEWER_COOKIE);
00066   PetscLogEventRegister(&amp;Jac1FinestDiagEvent,<span class="stringliteral">"ODAmatDiagFinest"</span>,PETSC_VIEWER_COOKIE);
00067   PetscLogEventRegister(&amp;Jac1FinestMultEvent,<span class="stringliteral">"ODAmatMultFinest"</span>,PETSC_VIEWER_COOKIE);
00068 
00069   PetscLogEventRegister(&amp;Jac2DiagEvent,<span class="stringliteral">"OMGmatDiag-2"</span>,PETSC_VIEWER_COOKIE);
00070   PetscLogEventRegister(&amp;Jac2MultEvent,<span class="stringliteral">"OMGmatMult-2"</span>,PETSC_VIEWER_COOKIE);
00071   PetscLogEventRegister(&amp;Jac2FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-2"</span>,PETSC_VIEWER_COOKIE);
00072   PetscLogEventRegister(&amp;Jac2FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-2"</span>,PETSC_VIEWER_COOKIE);
00073 
00074   PetscLogEventRegister(&amp;Jac3DiagEvent,<span class="stringliteral">"OMGmatDiag-3"</span>,PETSC_VIEWER_COOKIE);
00075   PetscLogEventRegister(&amp;Jac3MultEvent,<span class="stringliteral">"OMGmatMult-3"</span>,PETSC_VIEWER_COOKIE);
00076   PetscLogEventRegister(&amp;Jac3FinestDiagEvent,<span class="stringliteral">"OMGmatDiagFinest-3"</span>,PETSC_VIEWER_COOKIE);
00077   PetscLogEventRegister(&amp;Jac3FinestMultEvent,<span class="stringliteral">"OMGmatMultFinest-3"</span>,PETSC_VIEWER_COOKIE);
00078 
00079   <span class="keywordtype">int</span> stages[1];
00080   PetscLogStageRegister(&amp;stages[0],<span class="stringliteral">"Solve"</span>);  
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>
00083   MPI_Comm_size(MPI_COMM_WORLD,&amp;size);
00084   MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);
00085   <span class="keywordflow">if</span>(argc &gt; 1) {
00086     regLev = atoi(argv[1]);
00087   }
00088   <span class="keywordflow">if</span>(argc &gt; 2) {
00089     maxDepth = atoi(argv[2]);
00090   }
00091   <span class="keywordflow">if</span>(argc &gt; 3) {
00092     dim = atoi(argv[3]);
00093   }
00094   <span class="keywordflow">if</span>(argc &gt; 4) { incCorner = (bool)(atoi(argv[4]));}  
00095   <span class="keywordflow">if</span>(argc &gt; 5) { compressLut = (bool)(atoi(argv[5]));}
00096   <span class="keywordflow">if</span>(argc &gt; 6) { mgLoadFac = atof(argv[6]); }
00097 
00098 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00099 <span class="preprocessor"></span>  PetscLogStagePush(stages[0]);
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>  MPI_Barrier(MPI_COMM_WORLD);  
00102 
00103   <a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a>        *damg;    
00104   <span class="keywordtype">int</span>       nlevels = 1; <span class="comment">//number of multigrid levels</span>
00105   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       dof = 1; <span class="comment">// degrees of freedom per node  </span>
00106 
00107   <a class="code" href="namespaceot.html#a41">createRegularOctree</a>(balOct, regLev, dim, maxDepth, MPI_COMM_WORLD);
00108 
00109   PetscInt nlevelsPetscInt = nlevels; <span class="comment">//To keep the compilers happy when using 64-bit indices </span>
00110   PetscOptionsGetInt(0, <span class="stringliteral">"-nlevels"</span>, &amp;nlevelsPetscInt, 0);
00111   nlevels = nlevelsPetscInt;
00112   
00113   <span class="comment">// Note: The user context for all levels will be set separately later.</span>
00114   MPI_Barrier(MPI_COMM_WORLD);  
00115   
00116   <span class="keywordflow">if</span>(!rank) {
00117     std::cout&lt;&lt;<span class="stringliteral">" nlevels initial: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00118   }
00119   
00120   <a class="code" href="namespaceot.html#a103">ot::DAMGCreateAndSetDA</a>(PETSC_COMM_WORLD, nlevels, NULL, &amp;damg, 
00121       balOct, dof, mgLoadFac, compressLut, incCorner);
00122 
00123   <span class="keywordflow">if</span>(!rank) {
00124     std::cout&lt;&lt;<span class="stringliteral">" nlevels final: "</span>&lt;&lt;nlevels&lt;&lt;std::endl;
00125   }
00126   
00127   MPI_Barrier(MPI_COMM_WORLD);  
00128   
00129   <span class="keywordflow">if</span>(!rank) {
00130     std::cout &lt;&lt; <span class="stringliteral">"Created DA for all levels."</span>&lt;&lt; std::endl;
00131   }
00132 
00133   MPI_Barrier(MPI_COMM_WORLD);
00134   <a class="code" href="namespaceot.html#a108">ot::PrintDAMG</a>(damg);
00135   MPI_Barrier(MPI_COMM_WORLD);
00136 
00137   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;nlevels;i++) {
00138     std::cout&lt;&lt;<span class="stringliteral">"Level "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">" is regular? "</span>&lt;&lt;
00139       (<a class="code" href="namespaceot.html#a83">isRegularGrid</a>(damg[i]-&gt;da))&lt;&lt;std::endl;
00140   }<span class="comment">//end for i</span>
00141 
00142 
00143   <a class="code" href="omgJac_8h.html#a0">SetUserContexts</a>(damg);
00144 
00145   <span class="keywordflow">if</span>(!rank) {
00146     std::cout &lt;&lt; <span class="stringliteral">"Set User Contexts all levels."</span>&lt;&lt; std::endl;
00147   }
00148 
00149   MPI_Barrier(MPI_COMM_WORLD);
00150 
00151   PetscInt       jacType = 1;
00152   PetscOptionsGetInt(0,<span class="stringliteral">"-jacType"</span>,&amp;jacType,0);
00153 
00154   PetscInt       rhsType = 1;
00155   PetscOptionsGetInt(0,<span class="stringliteral">"-rhsType"</span>,&amp;rhsType,0);
00156 
00157   <a class="code" href="handleType2Stencils_8C.html#a16">createLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00158   <a class="code" href="handleType2Stencils_8C.html#a12">createMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00159   <span class="keywordflow">if</span>(jacType == 3) {
00160     <a class="code" href="handleType1Stencils_8C.html#a4">createLmatType1</a>(<a class="code" href="checkError_8C.html#a1">LaplacianType1Stencil</a>);
00161     <a class="code" href="handleType1Stencils_8C.html#a0">createMmatType1</a>(<a class="code" href="checkError_8C.html#a3">MassType1Stencil</a>);
00162   }
00163  <a class="code" href="handleType2Stencils_8C.html#a4">createShFnMat</a>(<a class="code" href="checkError_8C.html#a5">ShapeFnStencil</a>);
00164  <a class="code" href="handleType2Stencils_8C.html#a0">createShapeFnCoeffs</a>(<a class="code" href="checkError_8C.html#a6">ShapeFnCoeffs</a>);
00165 
00166   <span class="keywordflow">if</span>(!rank) {
00167     std::cout &lt;&lt; <span class="stringliteral">"Created Stencils."</span>&lt;&lt; std::endl;
00168   }
00169 
00170   <span class="comment">//Function handles</span>
00171   PetscErrorCode (*ComputeRHSHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Vec rhs) = NULL;
00172   PetscErrorCode (*CreateJacobianHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Mat *B) = NULL;
00173   PetscErrorCode (*ComputeJacobianHandle)(<a class="code" href="structot_1_1__p__DAMG.html">ot::DAMG</a> damg,Mat J, Mat B) = NULL;
00174 
00175   <span class="keywordflow">if</span>(rhsType == 0) {
00176     ComputeRHSHandle = ComputeRHS0;
00177   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 1) {
00178     ComputeRHSHandle = ComputeRHS1;
00179   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 2) {
00180     ComputeRHSHandle = ComputeRHS2;
00181   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 3) {
00182     ComputeRHSHandle = ComputeRHS3;
00183   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 4) {
00184     ComputeRHSHandle = ComputeRHS4;
00185   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 5) {
00186     ComputeRHSHandle = ComputeRHS5;
00187   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 6) {
00188     ComputeRHSHandle = ComputeRHS6;
00189   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 7) {
00190     ComputeRHSHandle = ComputeRHS7;
00191   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rhsType == 8) {
00192     ComputeRHSHandle = ComputeRHS8;
00193   } <span class="keywordflow">else</span> {
00194     assert(<span class="keyword">false</span>);
00195   }
00196 
00197   <span class="keywordflow">if</span>(jacType == 1) {
00198     CreateJacobianHandle = CreateJacobian1;
00199     ComputeJacobianHandle = ComputeJacobian1;
00200   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 2) {
00201     CreateJacobianHandle = CreateJacobian2;
00202     ComputeJacobianHandle = ComputeJacobian2;
00203   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 3) {
00204     CreateJacobianHandle = CreateJacobian3;
00205     ComputeJacobianHandle = ComputeJacobian3;
00206     <span class="comment">//Skip the finest and the coarsest levels. For the other levels, J and B</span>
00207     <span class="comment">//must be different</span>
00208     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; (nlevels-1); i++) {
00209       <a class="code" href="namespaceot.html#a95">ot::DAMGCreateJMatrix</a>(damg[i], CreateJacobianHandle);
00210     }
00211   } <span class="keywordflow">else</span> {
00212     assert(<span class="keyword">false</span>);
00213   }
00214 
00215   <span class="comment">//Global Function Handles for using KSP_Shell (will be used @ the coarsest grid if not all</span>
00216   <span class="comment">//processors are active on the coarsest grid)</span>
00217   <span class="keywordflow">if</span> (jacType == 1) {
00218     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac1;
00219   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 2) {
00220     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac2;
00221   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jacType == 3) {
00222     ot::getPrivateMatricesForKSP_Shell = getPrivateMatricesForKSP_Shell_Jac3;
00223   } <span class="keywordflow">else</span> {
00224     assert(<span class="keyword">false</span>);
00225   }
00226 
00227   <a class="code" href="namespaceot.html#a96">ot::DAMGSetKSP</a>(damg, CreateJacobianHandle, ComputeJacobianHandle, ComputeRHSHandle);
00228 
00229   <span class="keywordflow">if</span>(!rank) {
00230     std::cout&lt;&lt;<span class="stringliteral">"Solving u-Lu=f"</span>&lt;&lt;std::endl;
00231   }
00232 
00233   <a class="code" href="omg_8C.html#a0">iC</a>(ot::DAMGSolve(damg));
00234 
00235   <a class="code" href="handleType2Stencils_8C.html#a26">destroyLmatType2</a>(<a class="code" href="checkError_8C.html#a2">LaplacianType2Stencil</a>);
00236   <a class="code" href="handleType2Stencils_8C.html#a27">destroyMmatType2</a>(<a class="code" href="checkError_8C.html#a4">MassType2Stencil</a>);
00237   <span class="keywordflow">if</span>(jacType == 3) {
00238     <a class="code" href="handleType1Stencils_8C.html#a8">destroyLmatType1</a>(<a class="code" href="checkError_8C.html#a1">LaplacianType1Stencil</a>);
00239     <a class="code" href="handleType1Stencils_8C.html#a9">destroyMmatType1</a>(<a class="code" href="checkError_8C.html#a3">MassType1Stencil</a>);
00240   }
00241   <a class="code" href="handleType2Stencils_8C.html#a29">destroyShFnMat</a>(<a class="code" href="checkError_8C.html#a5">ShapeFnStencil</a>);
00242   <a class="code" href="handleType2Stencils_8C.html#a25">destroyShapeFnCoeffs</a>(<a class="code" href="checkError_8C.html#a6">ShapeFnCoeffs</a>);
00243 
00244   MPI_Barrier(MPI_COMM_WORLD);
00245 
00246   <a class="code" href="omgNeumann_8C.html#a13">DestroyUserContexts</a>(damg);
00247 
00248   <span class="keywordflow">if</span> (!rank) {
00249     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed User Contexts."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00250   }
00251 
00252   MPI_Barrier(MPI_COMM_WORLD);
00253 
00254   <a class="code" href="omg_8C.html#a0">iC</a>(<a class="code" href="namespaceot.html#a94">DAMGDestroy</a>(damg));
00255 
00256   <span class="keywordflow">if</span> (!rank) {
00257     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Destroyed DAMG"</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00258   }
00259 
00260 <span class="preprocessor">#ifdef PETSC_USE_LOG</span>
00261 <span class="preprocessor"></span>  PetscLogStagePop();
00262 <span class="preprocessor">#endif</span>
00263 <span class="preprocessor"></span>  balOct.clear();
00264 
00265   <span class="keywordflow">if</span> (!rank) {
00266     std::cout &lt;&lt; <a class="code" href="colors_8h.html#a2">GRN</a> &lt;&lt; <span class="stringliteral">"Finalizing ..."</span> &lt;&lt; <a class="code" href="colors_8h.html#a6">NRM</a> &lt;&lt; std::endl;
00267   }
00268   <a class="code" href="namespaceot.html#a93">ot::DAMG_Finalize</a>();
00269   PetscFinalize();
00270 }<span class="comment">//end function</span>
00271 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 10 11:31:26 2008 for DENDRO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
